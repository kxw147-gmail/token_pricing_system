2025-07-05 14:51:02,569 - root - INFO - Logging configured at level: INFO
2025-07-05 14:51:02,569 - root - INFO - Logs will also be written to: app.log
2025-07-05 14:51:02,613 - app.main - INFO - Application startup initiated.
2025-07-05 14:51:02,614 - app.main - INFO - Database tables ensured to exist.
2025-07-05 14:51:02,614 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 14:51:02,614 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 14:51:02,614 - app.main - INFO - Application startup complete.
2025-07-05 14:51:02,614 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 14:51:02,614 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 18:51:02.614591+00:00.
2025-07-05 14:51:02,614 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 14:51:02,614 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T17:00:00+00:00 to 2025-07-05T18:00:00+00:00 UTC.
2025-07-05 14:51:02,620 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:51:02,626 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:51:02,627 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:51:02,627 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:51:02,627 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:51:02,627 - app.services.aggregation_service - INFO - Next aggregation check in 537.37 seconds.
2025-07-05 14:51:02,627 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 14:51:02,628 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 14:51:02,652 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 14:51:02,674 - app.api.endpoints - INFO - Attempting to register new user: flow_user
2025-07-05 14:51:02,676 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 14:51:02,835 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108017
2025-07-05 14:51:02,838 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108017.0 at 2025-07-05 18:50:00+00:00 (granularity: 5min)
2025-07-05 14:51:02,877 - app.api.endpoints - INFO - User flow_user successfully registered.
2025-07-05 14:51:02,879 - app.api.endpoints - INFO - Login attempt for user: flow_user
2025-07-05 14:51:03,071 - app.api.endpoints - INFO - User flow_user successfully logged in and token issued.
2025-07-05 14:51:03,073 - app.api.endpoints - INFO - User flow_user triggered manual prefetch for BITCOIN.
2025-07-05 14:51:03,078 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:03,079 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:03,079 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:04,091 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:04,092 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:04,093 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:05,101 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:05,102 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:05,102 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:06,114 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:06,115 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:06,115 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:07,127 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:07,128 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:07,128 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:08,139 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:08,140 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:08,140 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:08,653 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-05 14:51:08,795 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2495.25
2025-07-05 14:51:08,802 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2495.25 at 2025-07-05 18:50:00+00:00 (granularity: 5min)
2025-07-05 14:51:09,148 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:09,149 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:09,149 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:10,160 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:10,161 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:10,161 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:11,173 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:11,174 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:11,174 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:12,186 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:12,187 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:12,187 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:13,231 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 14:51:13,231 - app.main - INFO - Application shutdown complete.
2025-07-05 14:57:51,173 - root - INFO - Logging configured at level: INFO
2025-07-05 14:57:51,173 - root - INFO - Logs will also be written to: app.log
2025-07-05 14:57:51,245 - app.main - INFO - Application startup initiated.
2025-07-05 14:57:51,246 - app.main - INFO - Database tables ensured to exist.
2025-07-05 14:57:51,246 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 14:57:51,246 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 14:57:51,246 - app.main - INFO - Application startup complete.
2025-07-05 14:57:51,246 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 14:57:51,246 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 18:57:51.246851+00:00.
2025-07-05 14:57:51,247 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 14:57:51,247 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T17:00:00+00:00 to 2025-07-05T18:00:00+00:00 UTC.
2025-07-05 14:57:51,256 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:57:51,263 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:57:51,263 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:57:51,263 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:57:51,263 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:57:51,263 - app.services.aggregation_service - INFO - Next aggregation check in 128.74 seconds.
2025-07-05 14:57:51,263 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 14:57:51,264 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 14:57:51,290 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 14:57:51,316 - app.api.endpoints - INFO - Attempting to register new user: flow_user
2025-07-05 14:57:51,317 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 14:57:51,510 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108025
2025-07-05 14:57:51,512 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108025.0 at 2025-07-05 18:55:00+00:00 (granularity: 5min)
2025-07-05 14:57:51,524 - app.api.endpoints - INFO - User flow_user successfully registered.
2025-07-05 14:57:51,526 - app.api.endpoints - INFO - Login attempt for user: flow_user
2025-07-05 14:57:51,720 - app.api.endpoints - INFO - User flow_user successfully logged in and token issued.
2025-07-05 14:57:51,723 - app.api.endpoints - INFO - User flow_user triggered manual prefetch for BITCOIN.
2025-07-05 14:57:51,728 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:51,729 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:51,729 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:52,741 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:52,741 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:52,742 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:53,753 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:53,754 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:53,755 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:54,766 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:54,767 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:54,768 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:55,779 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:55,780 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:55,781 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:56,791 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:56,791 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:56,792 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:57,291 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-05 14:57:57,434 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2495.07
2025-07-05 14:57:57,449 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2495.07 at 2025-07-05 18:55:00+00:00 (granularity: 5min)
2025-07-05 14:57:57,803 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:57,804 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:57,804 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:58,815 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:58,816 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:58,816 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:59,826 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:59,827 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:59,828 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:58:00,839 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:58:00,840 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:58:00,841 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:58:01,887 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 14:58:01,887 - app.main - INFO - Application shutdown complete.
2025-07-05 14:59:42,068 - root - INFO - Logging configured at level: INFO
2025-07-05 14:59:42,068 - root - INFO - Logs will also be written to: app.log
2025-07-05 14:59:42,094 - app.main - INFO - Application startup initiated.
2025-07-05 14:59:42,095 - app.main - INFO - Database tables ensured to exist.
2025-07-05 14:59:42,095 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 14:59:42,095 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 14:59:42,095 - app.main - INFO - Application startup complete.
2025-07-05 14:59:42,095 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 14:59:42,095 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 18:59:42.095559+00:00.
2025-07-05 14:59:42,095 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 14:59:42,095 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T17:00:00+00:00 to 2025-07-05T18:00:00+00:00 UTC.
2025-07-05 14:59:42,114 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:59:42,121 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:59:42,121 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:59:42,121 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:59:42,121 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:59:42,121 - app.services.aggregation_service - INFO - Next aggregation check in 17.88 seconds.
2025-07-05 14:59:42,121 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 14:59:42,122 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 14:59:42,145 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 14:59:42,166 - app.api.endpoints - INFO - Attempting to register new user: flow_user
2025-07-05 14:59:42,168 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 14:59:42,292 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108027
2025-07-05 14:59:42,292 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:55:00.000000', 108027.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:59:42,370 - app.api.endpoints - INFO - User flow_user successfully registered.
2025-07-05 14:59:42,372 - app.api.endpoints - INFO - Login attempt for user: flow_user
2025-07-05 14:59:42,564 - app.api.endpoints - INFO - User flow_user successfully logged in and token issued.
2025-07-05 14:59:42,566 - app.api.endpoints - INFO - User flow_user triggered manual prefetch for BITCOIN.
2025-07-05 14:59:42,571 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:42,572 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:42,572 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:43,584 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:43,585 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:43,586 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:44,597 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:44,598 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:44,598 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:45,610 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:45,611 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:45,611 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:46,622 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:46,623 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:46,623 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:47,635 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:47,636 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:47,636 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:48,146 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-05 14:59:48,280 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2494.95
2025-07-05 14:59:48,284 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-05 18:55:00.000000', 2494.95, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:59:48,654 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:48,655 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:48,655 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:49,667 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:49,668 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:49,668 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:50,675 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:50,676 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:50,677 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:51,687 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:51,688 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:51,689 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:52,727 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 14:59:52,727 - app.main - INFO - Application shutdown complete.
2025-07-05 15:02:45,104 - root - INFO - Logging configured at level: INFO
2025-07-05 15:02:45,104 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:02:45,151 - app.main - INFO - Application startup initiated.
2025-07-05 15:02:45,152 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:02:45,152 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:02:45,152 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:02:45,152 - app.main - INFO - Application startup complete.
2025-07-05 15:02:45,152 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:02:45,152 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:02:45.152508+00:00.
2025-07-05 15:02:45,152 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:02:45,152 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:02:45,160 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 completed. Processed 2 symbols.
2025-07-05 15:02:45,160 - app.services.aggregation_service - INFO - Next aggregation check in 3434.84 seconds.
2025-07-05 15:02:45,160 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:02:45,161 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:02:45,184 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:02:45,206 - app.api.endpoints - INFO - Attempting to register new user: flow_user
2025-07-05 15:02:45,207 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:02:45,378 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108029
2025-07-05 15:02:45,379 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108029.0 at 2025-07-05 19:00:00+00:00 (granularity: 5min)
2025-07-05 15:02:45,410 - app.api.endpoints - INFO - User flow_user successfully registered.
2025-07-05 15:02:45,412 - app.api.endpoints - INFO - Login attempt for user: flow_user
2025-07-05 15:02:45,602 - app.api.endpoints - INFO - User flow_user successfully logged in and token issued.
2025-07-05 15:02:45,605 - app.api.endpoints - INFO - User flow_user triggered manual prefetch for BITCOIN.
2025-07-05 15:02:45,611 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:45,612 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:45,612 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:46,624 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:46,625 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:46,626 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:47,638 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:47,639 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:47,639 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:48,652 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:48,653 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:48,653 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:49,664 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:49,665 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:49,666 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:50,677 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:50,678 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:50,679 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:51,185 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-05 15:02:51,331 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2494.21
2025-07-05 15:02:51,338 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2494.21 at 2025-07-05 19:00:00+00:00 (granularity: 5min)
2025-07-05 15:02:51,690 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:51,691 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:51,691 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:52,703 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:52,704 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:52,704 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:53,716 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:53,717 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:53,718 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:54,730 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:54,732 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:54,732 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:55,778 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:02:55,778 - app.main - INFO - Application shutdown complete.
2025-07-05 15:10:55,688 - root - INFO - Logging configured at level: INFO
2025-07-05 15:10:55,689 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:11:39,622 - root - INFO - Logging configured at level: INFO
2025-07-05 15:11:39,623 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:11:39,645 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:39,645 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:39,645 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:39,645 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:39,645 - app.main - INFO - Application startup complete.
2025-07-05 15:11:39,645 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:39,645 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:39.645979+00:00.
2025-07-05 15:11:39,646 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:39,646 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:39,664 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:39,672 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:39,672 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:39,672 - app.services.aggregation_service - INFO - Next aggregation check in 2900.33 seconds.
2025-07-05 15:11:39,672 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:39,673 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:39,698 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:11:39,720 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:11:39,879 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 107994
2025-07-05 15:11:39,894 - app.services.ingestion_service - INFO - Ingested BITCOIN price 107994.0 at 2025-07-05 19:10:00+00:00 (granularity: 5min)
2025-07-05 15:11:40,038 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:40,038 - app.main - INFO - Application shutdown complete.
2025-07-05 15:11:40,041 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:40,041 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:40,041 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:40,041 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:40,041 - app.main - INFO - Application startup complete.
2025-07-05 15:11:40,042 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:40,042 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:40.042075+00:00.
2025-07-05 15:11:40,042 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:40,042 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:40,043 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:40,043 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,044 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,044 - app.services.aggregation_service - INFO - Next aggregation check in 2899.96 seconds.
2025-07-05 15:11:40,044 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:40,044 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:40,070 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:11:40,275 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:11:40,467 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:11:40,469 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:40,469 - app.main - INFO - Application shutdown complete.
2025-07-05 15:11:40,472 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:40,472 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:40,472 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:40,472 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:40,472 - app.main - INFO - Application startup complete.
2025-07-05 15:11:40,472 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:40,472 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:40.472564+00:00.
2025-07-05 15:11:40,472 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:40,472 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:40,473 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:40,474 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,474 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,474 - app.services.aggregation_service - INFO - Next aggregation check in 2899.53 seconds.
2025-07-05 15:11:40,474 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:40,475 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:40,686 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:11:40,870 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:11:40,874 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:41:40 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:16:40 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:41:40 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:16:40 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:11:40,876 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:40,876 - app.main - INFO - Application shutdown complete.
2025-07-05 15:11:40,879 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:40,879 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:40,879 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:40,879 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:40,879 - app.main - INFO - Application startup complete.
2025-07-05 15:11:40,879 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:40,879 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:40.879933+00:00.
2025-07-05 15:11:40,879 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:40,880 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:40,888 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:40,889 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,889 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,889 - app.services.aggregation_service - INFO - Next aggregation check in 2899.11 seconds.
2025-07-05 15:11:40,889 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:40,890 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:41,100 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:11:41,284 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:11:41,286 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:11:41,400 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:41,400 - app.main - INFO - Application shutdown complete.
2025-07-05 15:11:41,403 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:41,403 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:41,403 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:41,403 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:41,403 - app.main - INFO - Application startup complete.
2025-07-05 15:11:41,403 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:41,403 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:41.403988+00:00.
2025-07-05 15:11:41,404 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:41,404 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:41,404 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:41,405 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:41,405 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:41,406 - app.services.aggregation_service - INFO - Next aggregation check in 2898.59 seconds.
2025-07-05 15:11:41,406 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:41,406 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:41,617 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:11:41,802 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:11:41,845 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:41,846 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:33,892 - root - INFO - Logging configured at level: INFO
2025-07-05 15:16:33,892 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:16:33,914 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:33,915 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:33,915 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:33,915 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:33,915 - app.main - INFO - Application startup complete.
2025-07-05 15:16:33,915 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:33,915 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:33.915320+00:00.
2025-07-05 15:16:33,915 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:33,915 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:33,935 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:33,941 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:33,942 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:33,942 - app.services.aggregation_service - INFO - Next aggregation check in 2606.06 seconds.
2025-07-05 15:16:33,942 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:33,943 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:33,967 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:16:33,989 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:16:34,186 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 107986
2025-07-05 15:16:34,189 - app.services.ingestion_service - INFO - Ingested BITCOIN price 107986.0 at 2025-07-05 19:15:00+00:00 (granularity: 5min)
2025-07-05 15:16:34,313 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:34,313 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:34,316 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:34,316 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:34,316 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:34,316 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:34,316 - app.main - INFO - Application startup complete.
2025-07-05 15:16:34,317 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:34,317 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:34.317057+00:00.
2025-07-05 15:16:34,317 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:34,317 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:34,318 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:34,318 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:34,319 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:34,319 - app.services.aggregation_service - INFO - Next aggregation check in 2605.68 seconds.
2025-07-05 15:16:34,319 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:34,319 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:34,345 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:16:34,552 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:16:34,744 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:16:34,747 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:34,747 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:34,750 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:34,750 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:34,750 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:34,750 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:34,750 - app.main - INFO - Application startup complete.
2025-07-05 15:16:34,750 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:34,750 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:34.750414+00:00.
2025-07-05 15:16:34,750 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:34,750 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:34,751 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:34,752 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:34,752 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:34,752 - app.services.aggregation_service - INFO - Next aggregation check in 2605.25 seconds.
2025-07-05 15:16:34,752 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:34,752 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:34,966 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:16:35,150 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:16:35,154 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:46:35 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:21:35 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:46:35 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:21:35 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:16:35,156 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:35,156 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:35,159 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:35,159 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:35,159 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:35,159 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:35,159 - app.main - INFO - Application startup complete.
2025-07-05 15:16:35,159 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:35,159 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:35.159855+00:00.
2025-07-05 15:16:35,159 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:35,159 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:35,168 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:35,169 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:35,169 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:35,170 - app.services.aggregation_service - INFO - Next aggregation check in 2604.83 seconds.
2025-07-05 15:16:35,170 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:35,170 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:35,380 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:16:35,564 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:16:35,566 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:16:35,680 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:35,680 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:35,683 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:35,683 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:35,683 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:35,683 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:35,683 - app.main - INFO - Application startup complete.
2025-07-05 15:16:35,684 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:35,684 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:35.684067+00:00.
2025-07-05 15:16:35,684 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:35,684 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:35,684 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:35,685 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:35,686 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:35,686 - app.services.aggregation_service - INFO - Next aggregation check in 2604.31 seconds.
2025-07-05 15:16:35,686 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:35,686 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:35,898 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:16:36,081 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:16:36,125 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:36,125 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:33,073 - root - INFO - Logging configured at level: INFO
2025-07-05 15:19:33,073 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:19:33,094 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:33,095 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:33,095 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:33,095 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:33,095 - app.main - INFO - Application startup complete.
2025-07-05 15:19:33,095 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:33,095 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:33.095503+00:00.
2025-07-05 15:19:33,095 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:33,095 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:33,114 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:33,121 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,121 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,121 - app.services.aggregation_service - INFO - Next aggregation check in 2426.88 seconds.
2025-07-05 15:19:33,121 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:33,122 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:33,147 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:19:33,169 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:19:33,365 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 107970
2025-07-05 15:19:33,366 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:15:00.000000', 107970.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:33,489 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:33,489 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:33,492 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:33,492 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:33,492 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:33,492 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:33,492 - app.main - INFO - Application startup complete.
2025-07-05 15:19:33,493 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:33,493 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:33.493063+00:00.
2025-07-05 15:19:33,493 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:33,493 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:33,494 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:33,495 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,495 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,495 - app.services.aggregation_service - INFO - Next aggregation check in 2426.50 seconds.
2025-07-05 15:19:33,495 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:33,495 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:33,520 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:19:33,725 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:19:33,917 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:19:33,919 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:33,919 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:33,922 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:33,922 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:33,922 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:33,922 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:33,922 - app.main - INFO - Application startup complete.
2025-07-05 15:19:33,922 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:33,922 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:33.922585+00:00.
2025-07-05 15:19:33,922 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:33,922 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:33,923 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:33,924 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,924 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,924 - app.services.aggregation_service - INFO - Next aggregation check in 2426.08 seconds.
2025-07-05 15:19:33,924 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:33,924 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:34,136 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:19:34,320 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:19:34,324 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:49:34 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:24:34 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:49:34 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:24:34 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:19:34,326 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:34,326 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:34,328 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:34,329 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:34,329 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:34,329 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:34,329 - app.main - INFO - Application startup complete.
2025-07-05 15:19:34,329 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:34,329 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:34.329207+00:00.
2025-07-05 15:19:34,329 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:34,329 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:34,337 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:34,338 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:34,339 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:34,339 - app.services.aggregation_service - INFO - Next aggregation check in 2425.66 seconds.
2025-07-05 15:19:34,339 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:34,339 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:34,549 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:19:34,734 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:19:34,736 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:19:34,852 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:34,852 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:34,855 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:34,855 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:34,855 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:34,855 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:34,855 - app.main - INFO - Application startup complete.
2025-07-05 15:19:34,855 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:34,855 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:34.855406+00:00.
2025-07-05 15:19:34,855 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:34,855 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:34,856 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:34,857 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:34,857 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:34,857 - app.services.aggregation_service - INFO - Next aggregation check in 2425.14 seconds.
2025-07-05 15:19:34,857 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:34,857 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:35,069 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:19:35,252 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:19:35,296 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:35,296 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:58,918 - root - INFO - Logging configured at level: INFO
2025-07-05 15:19:58,918 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:19:58,934 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:58,935 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:58,935 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:58,935 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:58,935 - app.main - INFO - Application startup complete.
2025-07-05 15:19:58,935 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:58,935 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:58.935406+00:00.
2025-07-05 15:19:58,935 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:58,935 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:58,953 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:58,955 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:58,955 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:58,955 - app.services.aggregation_service - INFO - Next aggregation check in 2401.04 seconds.
2025-07-05 15:19:58,955 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:58,956 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:58,970 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:19:58,992 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:19:59,100 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 107970
2025-07-05 15:19:59,143 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:15:00.000000', 107970.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:59,299 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:59,299 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:59,302 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:59,302 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:59,302 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:59,302 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:59,302 - app.main - INFO - Application startup complete.
2025-07-05 15:19:59,302 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:59,303 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:59.303023+00:00.
2025-07-05 15:19:59,303 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:59,303 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:59,303 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:59,304 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:59,305 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:59,305 - app.services.aggregation_service - INFO - Next aggregation check in 2400.69 seconds.
2025-07-05 15:19:59,305 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:59,305 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:59,330 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:19:59,533 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:19:59,720 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:19:59,722 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:59,722 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:59,724 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:59,724 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:59,724 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:59,724 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:59,724 - app.main - INFO - Application startup complete.
2025-07-05 15:19:59,725 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:59,725 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:59.725070+00:00.
2025-07-05 15:19:59,725 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:59,725 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:59,725 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:59,726 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:59,727 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:59,727 - app.services.aggregation_service - INFO - Next aggregation check in 2400.27 seconds.
2025-07-05 15:19:59,727 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:59,727 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:59,938 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:20:00,121 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:20:00,125 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:50:00 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:25:00 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:50:00 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:25:00 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:20:00,127 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:20:00,127 - app.main - INFO - Application shutdown complete.
2025-07-05 15:20:00,129 - app.main - INFO - Application startup initiated.
2025-07-05 15:20:00,129 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:20:00,129 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:20:00,129 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:20:00,129 - app.main - INFO - Application startup complete.
2025-07-05 15:20:00,129 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:20:00,130 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:20:00.130019+00:00.
2025-07-05 15:20:00,130 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:20:00,130 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:20:00,138 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:20:00,139 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:20:00,140 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:20:00,140 - app.services.aggregation_service - INFO - Next aggregation check in 2399.86 seconds.
2025-07-05 15:20:00,140 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:20:00,140 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:20:00,350 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:20:00,534 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:20:00,536 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:20:00,651 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:20:00,652 - app.main - INFO - Application shutdown complete.
2025-07-05 15:20:00,654 - app.main - INFO - Application startup initiated.
2025-07-05 15:20:00,654 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:20:00,654 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:20:00,654 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:20:00,654 - app.main - INFO - Application startup complete.
2025-07-05 15:20:00,654 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:20:00,654 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:20:00.654724+00:00.
2025-07-05 15:20:00,654 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:20:00,654 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:20:00,655 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:20:00,656 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:20:00,656 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:20:00,656 - app.services.aggregation_service - INFO - Next aggregation check in 2399.34 seconds.
2025-07-05 15:20:00,656 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:20:00,657 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:20:00,867 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:20:01,051 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:20:01,094 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:20:01,094 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:27,211 - root - INFO - Logging configured at level: INFO
2025-07-05 15:24:27,211 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:24:27,233 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:27,234 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:27,234 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:27,234 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:27,234 - app.main - INFO - Application startup complete.
2025-07-05 15:24:27,234 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:27,234 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:27.234459+00:00.
2025-07-05 15:24:27,234 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:27,234 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:27,240 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:27,247 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,247 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,247 - app.services.aggregation_service - INFO - Next aggregation check in 2132.75 seconds.
2025-07-05 15:24:27,247 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:27,248 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:27,286 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:24:27,308 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:24:27,308 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:24:27,448 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108001
2025-07-05 15:24:27,450 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108001.0 at 2025-07-05 19:20:00+00:00 (granularity: 5min)
2025-07-05 15:24:27,511 - app.api.endpoints - INFO - User testuser_reg successfully registered.
2025-07-05 15:24:27,512 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:27,512 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:27,514 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:27,514 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:27,514 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:27,514 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:27,514 - app.main - INFO - Application startup complete.
2025-07-05 15:24:27,514 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:27,514 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:27.514815+00:00.
2025-07-05 15:24:27,514 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:27,514 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:27,516 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:27,517 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,517 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,517 - app.services.aggregation_service - INFO - Next aggregation check in 2132.48 seconds.
2025-07-05 15:24:27,517 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:27,517 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:27,730 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:24:27,923 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:24:27,924 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:27,925 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:27,926 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:27,926 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:27,926 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:27,926 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:27,926 - app.main - INFO - Application startup complete.
2025-07-05 15:24:27,926 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:27,926 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:27.926721+00:00.
2025-07-05 15:24:27,926 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:27,926 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:27,927 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:27,928 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,928 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,928 - app.services.aggregation_service - INFO - Next aggregation check in 2132.07 seconds.
2025-07-05 15:24:27,928 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:27,929 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:28,139 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:24:28,325 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:24:28,329 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:54:28 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:29:28 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:54:28 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:29:28 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:24:28,357 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:28,357 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:28,358 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:28,358 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:28,358 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:28,358 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:28,358 - app.main - INFO - Application startup complete.
2025-07-05 15:24:28,358 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:28,358 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:28.358977+00:00.
2025-07-05 15:24:28,359 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:28,359 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:28,359 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:28,360 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:28,360 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:28,361 - app.services.aggregation_service - INFO - Next aggregation check in 2131.64 seconds.
2025-07-05 15:24:28,361 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:28,361 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:28,571 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:24:28,755 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:24:28,756 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:24:28,853 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:28,853 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:28,854 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:28,854 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:28,854 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:28,854 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:28,855 - app.main - INFO - Application startup complete.
2025-07-05 15:24:28,855 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:28,855 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:28.855079+00:00.
2025-07-05 15:24:28,855 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:28,855 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:28,855 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:28,856 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:28,857 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:28,857 - app.services.aggregation_service - INFO - Next aggregation check in 2131.14 seconds.
2025-07-05 15:24:28,857 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:28,857 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:29,068 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:24:29,252 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:24:29,295 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:29,295 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:38,106 - root - INFO - Logging configured at level: INFO
2025-07-05 15:24:38,106 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:28:49,335 - root - INFO - Logging configured at level: INFO
2025-07-05 15:28:49,335 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:28:49,376 - app.main - INFO - Application startup initiated.
2025-07-05 15:28:49,376 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:28:49,376 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:28:49,377 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:28:49,377 - app.main - INFO - Application startup complete.
2025-07-05 15:28:49,377 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:28:49,377 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:28:49.377241+00:00.
2025-07-05 15:28:49,377 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:28:49,377 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:28:49,383 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:28:49,389 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:28:49,390 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:28:49,390 - app.services.aggregation_service - INFO - Next aggregation check in 1870.61 seconds.
2025-07-05 15:28:49,390 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:28:49,390 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:28:49,413 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:28:49,434 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:28:49,599 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108015
2025-07-05 15:28:49,601 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108015.0 at 2025-07-05 19:25:00+00:00 (granularity: 5min)
2025-07-05 15:28:49,637 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:28:49,829 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:28:49,832 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:58:49 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:33:49 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:58:49 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:33:49 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:28:49,853 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:28:49,853 - app.main - INFO - Application shutdown complete.
2025-07-05 15:31:46,868 - root - INFO - Logging configured at level: INFO
2025-07-05 15:31:46,868 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:31:46,910 - app.main - INFO - Application startup initiated.
2025-07-05 15:31:46,911 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:31:46,911 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:31:46,911 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:31:46,911 - app.main - INFO - Application startup complete.
2025-07-05 15:31:46,911 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:31:46,911 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:31:46.911915+00:00.
2025-07-05 15:31:46,911 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:31:46,912 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:31:46,917 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:31:46,924 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:31:46,924 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:31:46,924 - app.services.aggregation_service - INFO - Next aggregation check in 1693.08 seconds.
2025-07-05 15:31:46,924 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:31:46,925 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:31:46,948 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:31:46,969 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:31:47,112 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108019
2025-07-05 15:31:47,115 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108019.0 at 2025-07-05 19:30:00+00:00 (granularity: 5min)
2025-07-05 15:31:47,174 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:31:47,367 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:31:47,371 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:01:47 00:00 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:36:47 00:00 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:01:47 00:00 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:36:47 00:00 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:31:47,391 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:31:47,391 - app.main - INFO - Application shutdown complete.
2025-07-05 15:33:14,994 - root - INFO - Logging configured at level: INFO
2025-07-05 15:33:14,994 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:33:15,036 - app.main - INFO - Application startup initiated.
2025-07-05 15:33:15,037 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:33:15,037 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:33:15,037 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:33:15,037 - app.main - INFO - Application startup complete.
2025-07-05 15:33:15,037 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:33:15,037 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:33:15.037426+00:00.
2025-07-05 15:33:15,037 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:33:15,037 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:33:15,043 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:33:15,051 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:33:15,051 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:33:15,051 - app.services.aggregation_service - INFO - Next aggregation check in 1604.95 seconds.
2025-07-05 15:33:15,051 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:33:15,052 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:33:15,075 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:33:15,096 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:33:15,217 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108024
2025-07-05 15:33:15,218 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:30:00.000000', 108024.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:33:15,300 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:33:15,494 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:33:15,499 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:03:15 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:38:15 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:03:15 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:38:15 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:33:15,520 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:33:15,520 - app.main - INFO - Application shutdown complete.
2025-07-05 15:36:21,853 - root - INFO - Logging configured at level: INFO
2025-07-05 15:36:21,853 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:36:21,894 - app.main - INFO - Application startup initiated.
2025-07-05 15:36:21,894 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:36:21,894 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:36:21,894 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:36:21,894 - app.main - INFO - Application startup complete.
2025-07-05 15:36:21,895 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:36:21,895 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:36:21.895055+00:00.
2025-07-05 15:36:21,895 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:36:21,895 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:36:21,900 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:36:21,907 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:36:21,907 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:36:21,908 - app.services.aggregation_service - INFO - Next aggregation check in 1418.09 seconds.
2025-07-05 15:36:21,908 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:36:21,908 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:36:21,934 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:36:21,955 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:36:22,105 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108033
2025-07-05 15:36:22,109 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108033.0 at 2025-07-05 19:35:00+00:00 (granularity: 5min)
2025-07-05 15:36:22,160 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:36:22,354 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:36:22,358 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:06:22 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:41:22 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:06:22 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:41:22 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:36:22,378 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:36:22,378 - app.main - INFO - Application shutdown complete.
2025-07-05 15:40:29,804 - root - INFO - Logging configured at level: INFO
2025-07-05 15:40:29,804 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:40:29,845 - app.main - INFO - Application startup initiated.
2025-07-05 15:40:29,846 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:40:29,846 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:40:29,846 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:40:29,846 - app.main - INFO - Application startup complete.
2025-07-05 15:40:29,846 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:40:29,846 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:40:29.846703+00:00.
2025-07-05 15:40:29,846 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:40:29,846 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:40:29,852 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:40:29,858 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:40:29,859 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:40:29,859 - app.services.aggregation_service - INFO - Next aggregation check in 1170.14 seconds.
2025-07-05 15:40:29,859 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:40:29,862 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:40:29,886 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:40:29,907 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:40:30,047 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108058
2025-07-05 15:40:30,050 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108058.0 at 2025-07-05 19:40:00+00:00 (granularity: 5min)
2025-07-05 15:40:30,111 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:40:30,304 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:40:30,308 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:10:30 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:45:30 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:10:30 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:45:30 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:40:30,329 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:40:30,329 - app.main - INFO - Application shutdown complete.
2025-07-05 15:41:13,355 - root - INFO - Logging configured at level: INFO
2025-07-05 15:41:13,355 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:41:13,396 - app.main - INFO - Application startup initiated.
2025-07-05 15:41:13,397 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:41:13,397 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:41:13,397 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:41:13,397 - app.main - INFO - Application startup complete.
2025-07-05 15:41:13,397 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:41:13,397 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:41:13.397803+00:00.
2025-07-05 15:41:13,397 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:41:13,397 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:41:13,403 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:41:13,410 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:41:13,410 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:41:13,411 - app.services.aggregation_service - INFO - Next aggregation check in 1126.59 seconds.
2025-07-05 15:41:13,411 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:41:13,411 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:41:13,435 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:41:13,456 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:41:13,539 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108058
2025-07-05 15:41:13,539 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:40:00.000000', 108058.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:41:13,661 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:41:13,855 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:41:13,859 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:11:00.855573 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:46:00.855573 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:11:00.855573 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:46:00.855573 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:41:13,880 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:41:13,880 - app.main - INFO - Application shutdown complete.
2025-07-05 15:42:32,859 - root - INFO - Logging configured at level: INFO
2025-07-05 15:42:32,860 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:42:32,901 - app.main - INFO - Application startup initiated.
2025-07-05 15:42:32,901 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:42:32,901 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:42:32,901 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:42:32,901 - app.main - INFO - Application startup complete.
2025-07-05 15:42:32,902 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:42:32,902 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:42:32.902101+00:00.
2025-07-05 15:42:32,902 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:42:32,902 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:42:32,907 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:42:32,914 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:42:32,914 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:42:32,914 - app.services.aggregation_service - INFO - Next aggregation check in 1047.09 seconds.
2025-07-05 15:42:32,914 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:42:32,915 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:42:32,937 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:42:32,958 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:42:33,135 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108072
2025-07-05 15:42:33,136 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:40:00.000000', 108072.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:42:33,162 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:42:33,353 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:42:33,357 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:12:33 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:47:33 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:12:33 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:47:33 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:42:33,378 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:42:33,378 - app.main - INFO - Application shutdown complete.
2025-07-05 15:43:36,343 - root - INFO - Logging configured at level: INFO
2025-07-05 15:43:36,343 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:43:36,385 - app.main - INFO - Application startup initiated.
2025-07-05 15:43:36,385 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:43:36,385 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:43:36,385 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:43:36,385 - app.main - INFO - Application startup complete.
2025-07-05 15:43:36,386 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:43:36,386 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:43:36.386036+00:00.
2025-07-05 15:43:36,386 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:43:36,386 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:43:36,391 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:43:36,398 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:43:36,399 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:43:36,399 - app.services.aggregation_service - INFO - Next aggregation check in 983.60 seconds.
2025-07-05 15:43:36,399 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:43:36,399 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:43:36,423 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:43:36,444 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:43:36,582 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108076
2025-07-05 15:43:36,582 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:40:00.000000', 108076.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:43:36,649 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:43:36,840 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:43:36,845 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:13:36 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:48:36 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:13:36 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:48:36 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:43:36,866 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:43:36,867 - app.main - INFO - Application shutdown complete.
2025-07-05 15:45:24,814 - root - INFO - Logging configured at level: INFO
2025-07-05 15:45:24,814 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:45:24,841 - app.main - INFO - Application startup initiated.
2025-07-05 15:45:24,842 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:45:24,842 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:45:24,842 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:45:24,842 - app.main - INFO - Application startup complete.
2025-07-05 15:45:24,842 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:45:24,842 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:45:24.842570+00:00.
2025-07-05 15:45:24,842 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:45:24,842 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:45:24,848 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:45:24,856 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:45:24,856 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:45:24,857 - app.services.aggregation_service - INFO - Next aggregation check in 875.14 seconds.
2025-07-05 15:45:24,857 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:45:24,857 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:45:24,897 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:45:24,918 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:45:25,049 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108079
2025-07-05 15:45:25,051 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108079.0 at 2025-07-05 19:45:00+00:00 (granularity: 5min)
2025-07-05 15:45:25,121 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:45:25,320 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:45:25,323 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:15:25 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:50:25 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:15:25 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:50:25 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:45:25,344 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:45:25,344 - app.main - INFO - Application shutdown complete.
2025-07-05 15:52:35,326 - root - INFO - Logging configured at level: INFO
2025-07-05 15:52:35,326 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:52:35,368 - app.main - INFO - Application startup initiated.
2025-07-05 15:52:35,369 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:52:35,369 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:52:35,369 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:52:35,369 - app.main - INFO - Application startup complete.
2025-07-05 15:52:35,369 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:52:35,369 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:52:35.369553+00:00.
2025-07-05 15:52:35,369 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:52:35,369 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:52:35,375 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:52:35,382 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:52:35,382 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:52:35,382 - app.services.aggregation_service - INFO - Next aggregation check in 444.62 seconds.
2025-07-05 15:52:35,382 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:52:35,383 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:52:35,408 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:52:35,431 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:52:35,574 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108139
2025-07-05 15:52:35,577 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108139.0 at 2025-07-05 19:50:00+00:00 (granularity: 5min)
2025-07-05 15:52:35,637 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:52:35,831 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:52:35,852 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:52:35,852 - app.main - INFO - Application shutdown complete.
2025-07-05 15:53:48,321 - root - INFO - Logging configured at level: INFO
2025-07-05 15:53:48,322 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:53:48,364 - app.main - INFO - Application startup initiated.
2025-07-05 15:53:48,364 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:53:48,365 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:53:48,365 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:53:48,365 - app.main - INFO - Application startup complete.
2025-07-05 15:53:48,365 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:53:48,365 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:53:48.365213+00:00.
2025-07-05 15:53:48,365 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:53:48,365 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:53:48,370 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:53:48,377 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:53:48,377 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:53:48,377 - app.services.aggregation_service - INFO - Next aggregation check in 371.62 seconds.
2025-07-05 15:53:48,378 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:53:48,378 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:53:48,401 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:53:48,422 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:53:48,603 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108149
2025-07-05 15:53:48,603 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:50:00.000000', 108149.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:53:48,627 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:53:48,821 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:53:48,825 - app.api.endpoints - INFO - User testuser_hist querying historical prices for TEST with granularity 5min from 2025-07-05T19:23:48+00:00 to 2025-07-05T19:58:48+00:00.
2025-07-05 15:53:48,826 - app.api.endpoints - INFO - Returned 5 historical prices for TEST.
2025-07-05 15:53:48,827 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:53:48,828 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:07,699 - root - INFO - Logging configured at level: INFO
2025-07-05 15:54:07,699 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:54:07,720 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:07,721 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:07,721 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:07,721 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:07,721 - app.main - INFO - Application startup complete.
2025-07-05 15:54:07,721 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:07,721 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:07.721406+00:00.
2025-07-05 15:54:07,721 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:07,721 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:07,726 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:07,733 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:07,733 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:07,733 - app.services.aggregation_service - INFO - Next aggregation check in 352.27 seconds.
2025-07-05 15:54:07,733 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:07,734 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:07,770 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:54:07,792 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:54:07,793 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:54:07,864 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108149
2025-07-05 15:54:07,864 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:50:00.000000', 108149.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:07,995 - app.api.endpoints - INFO - User testuser_reg successfully registered.
2025-07-05 15:54:07,997 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:07,997 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:07,998 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:07,999 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:07,999 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:07,999 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:07,999 - app.main - INFO - Application startup complete.
2025-07-05 15:54:07,999 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:07,999 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:07.999219+00:00.
2025-07-05 15:54:07,999 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:07,999 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:08,000 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:08,001 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,001 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,001 - app.services.aggregation_service - INFO - Next aggregation check in 352.00 seconds.
2025-07-05 15:54:08,002 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:08,002 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:08,213 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:54:08,404 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:54:08,405 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:08,405 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:08,407 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:08,407 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:08,407 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:08,407 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:08,407 - app.main - INFO - Application startup complete.
2025-07-05 15:54:08,407 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:08,407 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:08.407545+00:00.
2025-07-05 15:54:08,407 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:08,407 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:08,408 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:08,409 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,409 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,409 - app.services.aggregation_service - INFO - Next aggregation check in 351.59 seconds.
2025-07-05 15:54:08,409 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:08,410 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:08,621 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:54:08,805 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:54:08,810 - app.api.endpoints - INFO - User testuser_hist querying historical prices for TEST with granularity 5min from 2025-07-05T19:24:08+00:00 to 2025-07-05T19:59:08+00:00.
2025-07-05 15:54:08,810 - app.api.endpoints - INFO - Returned 5 historical prices for TEST.
2025-07-05 15:54:08,811 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:08,811 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:08,812 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:08,812 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:08,813 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:08,813 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:08,813 - app.main - INFO - Application startup complete.
2025-07-05 15:54:08,813 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:08,813 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:08.813146+00:00.
2025-07-05 15:54:08,813 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:08,813 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:08,813 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:08,825 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,826 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,826 - app.services.aggregation_service - INFO - Next aggregation check in 351.17 seconds.
2025-07-05 15:54:08,826 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:08,826 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:09,036 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:54:09,219 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:54:09,221 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:54:09,338 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:09,338 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:09,339 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:09,339 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:09,339 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:09,339 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:09,339 - app.main - INFO - Application startup complete.
2025-07-05 15:54:09,339 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:09,340 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:09.340014+00:00.
2025-07-05 15:54:09,340 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:09,340 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:09,340 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:09,341 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:09,341 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:09,342 - app.services.aggregation_service - INFO - Next aggregation check in 350.66 seconds.
2025-07-05 15:54:09,342 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:09,342 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:09,552 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:54:09,736 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:54:09,779 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:09,779 - app.main - INFO - Application shutdown complete.
2025-07-05 15:56:01,817 - root - INFO - Logging configured at level: INFO
2025-07-05 15:56:01,817 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:56:01,859 - app.main - INFO - Application startup initiated.
2025-07-05 15:56:01,860 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:56:01,860 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:56:01,860 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:56:01,860 - app.main - INFO - Application startup complete.
2025-07-05 15:56:01,860 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:56:01,860 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:56:01.860537+00:00.
2025-07-05 15:56:01,860 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:56:01,860 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:56:01,866 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:56:01,873 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:56:01,873 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:56:01,873 - app.services.aggregation_service - INFO - Next aggregation check in 238.13 seconds.
2025-07-05 15:56:01,873 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:56:01,874 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:56:01,897 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:56:01,918 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:56:02,123 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:56:02,318 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:56:02,319 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108153
2025-07-05 15:56:02,322 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108153.0 at 2025-07-05 19:55:00+00:00 (granularity: 5min)
2025-07-05 15:56:02,324 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:56:02,440 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:56:02,440 - app.main - INFO - Application shutdown complete.
2025-07-05 15:57:47,723 - root - INFO - Logging configured at level: INFO
2025-07-05 15:57:47,723 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:57:47,744 - app.main - INFO - Application startup initiated.
2025-07-05 15:57:47,744 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:57:47,744 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:57:47,744 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:57:47,744 - app.main - INFO - Application startup complete.
2025-07-05 15:57:47,744 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:57:47,744 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:57:47.744957+00:00.
2025-07-05 15:57:47,745 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:57:47,745 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:57:47,750 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:57:47,757 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:57:47,757 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:57:47,757 - app.services.aggregation_service - INFO - Next aggregation check in 132.24 seconds.
2025-07-05 15:57:47,757 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:57:47,758 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:57:47,795 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:57:47,816 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:57:47,975 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108152
2025-07-05 15:57:47,976 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:55:00.000000', 108152.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:57:48,019 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:57:48,211 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:57:48,213 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:57:48,328 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:57:48,328 - app.main - INFO - Application shutdown complete.
2025-07-05 15:59:54,544 - root - INFO - Logging configured at level: INFO
2025-07-05 15:59:54,544 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:59:54,585 - app.main - INFO - Application startup initiated.
2025-07-05 15:59:54,585 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:59:54,585 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:59:54,586 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:59:54,586 - app.main - INFO - Application startup complete.
2025-07-05 15:59:54,586 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:59:54,586 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:59:54.586256+00:00.
2025-07-05 15:59:54,586 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:59:54,586 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:59:54,591 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:59:54,598 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:59:54,598 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:59:54,599 - app.services.aggregation_service - INFO - Next aggregation check in 5.40 seconds.
2025-07-05 15:59:54,599 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:59:54,599 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:59:54,622 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:59:54,643 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:59:54,796 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108150
2025-07-05 15:59:54,797 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:55:00.000000', 108150.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:59:54,862 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:59:55,052 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:59:55,055 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:59:55,173 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:59:55,173 - app.main - INFO - Application shutdown complete.
2025-07-05 16:05:56,115 - root - INFO - Logging configured at level: INFO
2025-07-05 16:05:56,116 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:05:56,137 - app.main - INFO - Application startup initiated.
2025-07-05 16:05:56,138 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:05:56,138 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:05:56,138 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:05:56,138 - app.main - INFO - Application startup complete.
2025-07-05 16:05:56,138 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:05:56,138 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:05:56.138737+00:00.
2025-07-05 16:05:56,138 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:05:56,138 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:05:56,146 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 completed. Processed 2 symbols.
2025-07-05 16:05:56,146 - app.services.aggregation_service - INFO - Next aggregation check in 3243.85 seconds.
2025-07-05 16:05:56,146 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:05:56,146 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:05:56,183 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:05:56,204 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:05:56,344 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108168
2025-07-05 16:05:56,345 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108168.0 at 2025-07-05 20:05:00+00:00 (granularity: 5min)
2025-07-05 16:05:56,407 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 16:05:56,598 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 16:05:56,601 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 16:05:56,602 - app.api.endpoints - INFO - Fetched latest price for LATEST from DB and cached it. Price: 500.0
2025-07-05 16:05:56,603 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 16:05:56,603 - app.api.endpoints - INFO - Serving latest price for LATEST from cache.
2025-07-05 16:05:56,603 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:05:56,603 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:15,064 - root - INFO - Logging configured at level: INFO
2025-07-05 16:06:15,064 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:06:15,086 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:15,087 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:15,087 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:15,087 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:15,087 - app.main - INFO - Application startup complete.
2025-07-05 16:06:15,087 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:15,087 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:15.087771+00:00.
2025-07-05 16:06:15,087 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:15,087 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:15,093 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:15,100 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,100 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,100 - app.services.aggregation_service - INFO - Next aggregation check in 3224.90 seconds.
2025-07-05 16:06:15,100 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:15,101 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:15,137 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:06:15,159 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 16:06:15,160 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:06:15,242 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108168
2025-07-05 16:06:15,243 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:05:00.000000', 108168.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:15,362 - app.api.endpoints - INFO - User testuser_reg successfully registered.
2025-07-05 16:06:15,363 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:15,363 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:15,365 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:15,365 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:15,365 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:15,365 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:15,365 - app.main - INFO - Application startup complete.
2025-07-05 16:06:15,365 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:15,365 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:15.365643+00:00.
2025-07-05 16:06:15,365 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:15,365 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:15,367 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:15,368 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,368 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,368 - app.services.aggregation_service - INFO - Next aggregation check in 3224.63 seconds.
2025-07-05 16:06:15,368 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:15,368 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:15,580 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 16:06:15,771 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 16:06:15,772 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:15,772 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:15,774 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:15,774 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:15,774 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:15,774 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:15,774 - app.main - INFO - Application startup complete.
2025-07-05 16:06:15,774 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:15,774 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:15.774550+00:00.
2025-07-05 16:06:15,774 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:15,774 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:15,775 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:15,776 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,776 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,776 - app.services.aggregation_service - INFO - Next aggregation check in 3224.22 seconds.
2025-07-05 16:06:15,776 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:15,776 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:15,987 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 16:06:16,170 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 16:06:16,174 - app.api.endpoints - INFO - User testuser_hist querying historical prices for TEST with granularity 5min from 2025-07-05T19:36:16+00:00 to 2025-07-05T20:11:16+00:00.
2025-07-05 16:06:16,174 - app.api.endpoints - INFO - Returned 5 historical prices for TEST.
2025-07-05 16:06:16,175 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:16,175 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:16,176 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:16,176 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:16,176 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:16,176 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:16,176 - app.main - INFO - Application startup complete.
2025-07-05 16:06:16,177 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:16,177 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:16.177039+00:00.
2025-07-05 16:06:16,177 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:16,177 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:16,177 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:16,189 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:16,189 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:16,190 - app.services.aggregation_service - INFO - Next aggregation check in 3223.81 seconds.
2025-07-05 16:06:16,190 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:16,190 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:16,400 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 16:06:16,584 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 16:06:16,585 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 16:06:16,586 - app.api.endpoints - INFO - Fetched latest price for LATEST from DB and cached it. Price: 500.0
2025-07-05 16:06:16,587 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 16:06:16,587 - app.api.endpoints - INFO - Serving latest price for LATEST from cache.
2025-07-05 16:06:16,587 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:16,587 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:16,589 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:16,589 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:16,589 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:16,589 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:16,589 - app.main - INFO - Application startup complete.
2025-07-05 16:06:16,589 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:16,589 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:16.589720+00:00.
2025-07-05 16:06:16,589 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:16,589 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:16,590 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:16,591 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:16,591 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:16,591 - app.services.aggregation_service - INFO - Next aggregation check in 3223.41 seconds.
2025-07-05 16:06:16,591 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:16,591 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:16,802 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:06:16,985 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:06:17,047 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:17,047 - app.main - INFO - Application shutdown complete.
2025-07-05 16:10:14,029 - root - INFO - Logging configured at level: INFO
2025-07-05 16:10:14,030 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:10:14,050 - app.main - INFO - Application startup initiated.
2025-07-05 16:10:14,051 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:10:14,051 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:10:14,051 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:10:14,051 - app.main - INFO - Application startup complete.
2025-07-05 16:10:14,051 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:10:14,051 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:10:14.051556+00:00.
2025-07-05 16:10:14,051 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:10:14,051 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:10:14,057 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:10:14,064 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:10:14,064 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:10:14,064 - app.services.aggregation_service - INFO - Next aggregation check in 2985.94 seconds.
2025-07-05 16:10:14,064 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:10:14,065 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:10:14,106 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:10:14,127 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:10:14,282 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108135
2025-07-05 16:10:14,286 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108135.0 at 2025-07-05 20:10:00+00:00 (granularity: 5min)
2025-07-05 16:10:14,331 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:10:14,523 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:10:14,585 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:10:14,586 - app.main - INFO - Application shutdown complete.
2025-07-05 16:10:59,634 - root - INFO - Logging configured at level: INFO
2025-07-05 16:10:59,634 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:10:59,655 - app.main - INFO - Application startup initiated.
2025-07-05 16:10:59,656 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:10:59,656 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:10:59,656 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:10:59,656 - app.main - INFO - Application startup complete.
2025-07-05 16:10:59,656 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:10:59,656 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:10:59.656668+00:00.
2025-07-05 16:10:59,656 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:10:59,656 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:10:59,662 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:10:59,669 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:10:59,669 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:10:59,669 - app.services.aggregation_service - INFO - Next aggregation check in 2940.33 seconds.
2025-07-05 16:10:59,669 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:10:59,670 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:10:59,707 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:10:59,728 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:10:59,802 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108135
2025-07-05 16:10:59,804 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:10:00.000000', 108135.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:10:59,932 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:11:00,126 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:11:00,189 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:11:00,189 - app.main - INFO - Application shutdown complete.
2025-07-05 16:19:04,060 - root - INFO - Logging configured at level: INFO
2025-07-05 16:19:04,060 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:20:01,353 - root - INFO - Logging configured at level: INFO
2025-07-05 16:20:01,353 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:20:01,375 - app.main - INFO - Application startup initiated.
2025-07-05 16:20:01,376 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:20:01,376 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:20:01,376 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:20:01,376 - app.main - INFO - Application startup complete.
2025-07-05 16:20:01,376 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:20:01,376 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:20:01.376539+00:00.
2025-07-05 16:20:01,376 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:20:01,376 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:20:01,382 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:20:01,389 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:20:01,389 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:20:01,389 - app.services.aggregation_service - INFO - Next aggregation check in 2398.61 seconds.
2025-07-05 16:20:01,389 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:20:01,390 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:20:01,428 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:20:01,449 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:20:01,599 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108095
2025-07-05 16:20:01,601 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108095.0 at 2025-07-05 20:20:00+00:00 (granularity: 5min)
2025-07-05 16:20:01,654 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:20:01,847 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:20:01,912 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:20:01,912 - app.main - INFO - Application shutdown complete.
2025-07-05 16:20:59,449 - root - INFO - Logging configured at level: INFO
2025-07-05 16:20:59,449 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:20:59,470 - app.main - INFO - Application startup initiated.
2025-07-05 16:20:59,471 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:20:59,471 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:20:59,471 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:20:59,471 - app.main - INFO - Application startup complete.
2025-07-05 16:20:59,471 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:20:59,471 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:20:59.471645+00:00.
2025-07-05 16:20:59,471 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:20:59,471 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:20:59,477 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:20:59,484 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:20:59,484 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:20:59,484 - app.services.aggregation_service - INFO - Next aggregation check in 2340.52 seconds.
2025-07-05 16:20:59,484 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:20:59,485 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:20:59,523 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:20:59,544 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:20:59,609 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108095
2025-07-05 16:20:59,610 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:20:00.000000', 108095.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:20:59,748 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:20:59,941 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:21:00,005 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:21:00,005 - app.main - INFO - Application shutdown complete.
2025-07-05 16:24:01,869 - root - INFO - Logging configured at level: INFO
2025-07-05 16:24:01,869 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:25:08,561 - root - INFO - Logging configured at level: INFO
2025-07-05 16:25:08,561 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:26:39,409 - root - INFO - Logging configured at level: INFO
2025-07-05 16:26:39,410 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:26:39,431 - app.main - INFO - Application startup initiated.
2025-07-05 16:26:39,432 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:26:39,432 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:26:39,432 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:26:39,433 - app.main - INFO - Application startup complete.
2025-07-05 16:26:39,433 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:26:39,433 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:26:39.433137+00:00.
2025-07-05 16:26:39,433 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:26:39,433 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:26:39,439 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:26:39,445 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:26:39,446 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:26:39,446 - app.services.aggregation_service - INFO - Next aggregation check in 2000.55 seconds.
2025-07-05 16:26:39,446 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:26:39,446 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:26:39,485 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:26:39,506 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:26:39,640 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108044
2025-07-05 16:26:39,644 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108044.0 at 2025-07-05 20:25:00+00:00 (granularity: 5min)
2025-07-05 16:26:39,709 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:26:39,900 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:26:39,970 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:26:39,970 - app.main - INFO - Application shutdown complete.
2025-07-05 16:28:48,722 - root - INFO - Logging configured at level: INFO
2025-07-05 16:28:48,723 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:28:48,744 - app.main - INFO - Application startup initiated.
2025-07-05 16:28:48,745 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:28:48,745 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:28:48,745 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:28:48,745 - app.main - INFO - Application startup complete.
2025-07-05 16:28:48,745 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:28:48,745 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:28:48.745718+00:00.
2025-07-05 16:28:48,745 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:28:48,745 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:28:48,751 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:28:48,758 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:28:48,758 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:28:48,758 - app.services.aggregation_service - INFO - Next aggregation check in 1871.24 seconds.
2025-07-05 16:28:48,758 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:28:48,759 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:28:48,797 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:28:48,817 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:28:48,949 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108035
2025-07-05 16:28:48,949 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:25:00.000000', 108035.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:28:49,023 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:28:49,215 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:28:49,280 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:28:49,280 - app.main - INFO - Application shutdown complete.
2025-07-05 16:32:23,261 - root - INFO - Logging configured at level: INFO
2025-07-05 16:32:23,261 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:32:23,302 - app.main - INFO - Application startup initiated.
2025-07-05 16:32:23,303 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:32:23,303 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:32:23,303 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:32:23,303 - app.main - INFO - Application startup complete.
2025-07-05 16:32:23,303 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:32:23,303 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:32:23.303436+00:00.
2025-07-05 16:32:23,303 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:32:23,303 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:32:23,309 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:32:23,316 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:32:23,316 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:32:23,316 - app.services.aggregation_service - INFO - Next aggregation check in 1656.68 seconds.
2025-07-05 16:32:23,316 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:32:23,317 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:32:23,341 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:32:23,362 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:32:23,495 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108012
2025-07-05 16:32:23,498 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108012.0 at 2025-07-05 20:30:00+00:00 (granularity: 5min)
2025-07-05 16:32:23,752 - app.api.endpoints - INFO - Login attempt for user: user1
2025-07-05 16:32:23,947 - app.api.endpoints - INFO - User user1 successfully logged in and token issued.
2025-07-05 16:32:23,949 - app.api.endpoints - INFO - Login attempt for user: user2
2025-07-05 16:32:24,133 - app.api.endpoints - INFO - User user2 successfully logged in and token issued.
2025-07-05 16:32:24,194 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:32:24,195 - app.main - INFO - Application shutdown complete.
2025-07-05 16:34:00,588 - root - INFO - Logging configured at level: INFO
2025-07-05 16:34:00,588 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:34:29,769 - root - INFO - Logging configured at level: INFO
2025-07-05 16:34:29,770 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:34:29,791 - app.main - INFO - Application startup initiated.
2025-07-05 16:34:29,792 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:34:29,792 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:34:29,792 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:34:29,792 - app.main - INFO - Application startup complete.
2025-07-05 16:34:29,792 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:34:29,792 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:34:29.792587+00:00.
2025-07-05 16:34:29,792 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:34:29,792 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:34:29,798 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:34:29,805 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:34:29,805 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:34:29,805 - app.services.aggregation_service - INFO - Next aggregation check in 1530.19 seconds.
2025-07-05 16:34:29,805 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:34:29,806 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:34:29,848 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:34:29,869 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:34:30,019 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108028
2025-07-05 16:34:30,021 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:30:00.000000', 108028.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:34:30,072 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:34:30,263 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:34:30,328 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:34:30,329 - app.main - INFO - Application shutdown complete.
2025-07-05 16:43:31,668 - root - INFO - Logging configured at level: INFO
2025-07-05 16:43:31,669 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:43:31,711 - app.main - INFO - Application startup initiated.
2025-07-05 16:43:31,712 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:43:31,712 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:43:31,712 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:43:31,712 - app.main - INFO - Application startup complete.
2025-07-05 16:43:31,712 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:43:31,712 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:43:31.712284+00:00.
2025-07-05 16:43:31,712 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:43:31,712 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:43:31,717 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:43:31,724 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:43:31,725 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:43:31,725 - app.services.aggregation_service - INFO - Next aggregation check in 988.27 seconds.
2025-07-05 16:43:31,725 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:43:31,725 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:43:31,748 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:43:31,769 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:43:31,966 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108081
2025-07-05 16:43:31,969 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108081.0 at 2025-07-05 20:40:00+00:00 (granularity: 5min)
2025-07-05 16:43:31,973 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:43:32,164 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:43:32,225 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:43:32,225 - app.main - INFO - Application shutdown complete.
2025-07-05 16:49:41,375 - root - INFO - Logging configured at level: INFO
2025-07-05 16:49:41,375 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:49:41,414 - app.main - INFO - Application startup initiated.
2025-07-05 16:49:41,415 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:49:41,415 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:49:41,415 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:49:41,415 - app.main - INFO - Application startup complete.
2025-07-05 16:49:41,415 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:49:41,415 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:49:41.415883+00:00.
2025-07-05 16:49:41,415 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:49:41,416 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:49:41,422 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:49:41,428 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:49:41,428 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:49:41,428 - app.services.aggregation_service - INFO - Next aggregation check in 618.57 seconds.
2025-07-05 16:49:41,428 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:49:41,429 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:49:41,452 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:49:41,473 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:49:41,616 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108097
2025-07-05 16:49:41,618 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108097.0 at 2025-07-05 20:45:00+00:00 (granularity: 5min)
2025-07-05 16:49:41,677 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:49:41,870 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:49:41,931 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:49:41,931 - app.main - INFO - Application shutdown complete.
2025-07-05 16:52:42,443 - root - INFO - Logging configured at level: INFO
2025-07-05 16:52:42,443 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:52:42,484 - app.main - INFO - Application startup initiated.
2025-07-05 16:52:42,485 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:52:42,485 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:52:42,485 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:52:42,485 - app.main - INFO - Application startup complete.
2025-07-05 16:52:42,485 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:52:42,485 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:52:42.485510+00:00.
2025-07-05 16:52:42,485 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:52:42,485 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:52:42,491 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:52:42,497 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:52:42,497 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:52:42,498 - app.services.aggregation_service - INFO - Next aggregation check in 437.50 seconds.
2025-07-05 16:52:42,498 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:52:42,498 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:52:42,521 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:52:42,542 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:52:42,711 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108119
2025-07-05 16:52:42,714 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108119.0 at 2025-07-05 20:50:00+00:00 (granularity: 5min)
2025-07-05 16:52:42,746 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:52:42,938 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:52:43,002 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:52:43,002 - app.main - INFO - Application shutdown complete.
2025-07-05 16:53:33,186 - root - INFO - Logging configured at level: INFO
2025-07-05 16:53:33,186 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:53:33,207 - app.main - INFO - Application startup initiated.
2025-07-05 16:53:33,207 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:53:33,207 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:53:33,207 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:53:33,207 - app.main - INFO - Application startup complete.
2025-07-05 16:53:33,207 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:53:33,207 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:53:33.207947+00:00.
2025-07-05 16:53:33,208 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:53:33,208 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:53:33,214 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:53:33,220 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:53:33,220 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:53:33,220 - app.services.aggregation_service - INFO - Next aggregation check in 386.78 seconds.
2025-07-05 16:53:33,220 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:53:33,221 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:53:33,258 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:53:33,279 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:53:33,345 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108119
2025-07-05 16:53:33,345 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:50:00.000000', 108119.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:53:33,485 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:53:33,679 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:53:33,741 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:53:33,741 - app.main - INFO - Application shutdown complete.
2025-07-05 16:57:21,398 - root - INFO - Logging configured at level: INFO
2025-07-05 16:57:21,399 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:57:21,420 - app.main - INFO - Application startup initiated.
2025-07-05 16:57:21,420 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:57:21,420 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:57:21,420 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 16:57:21,421 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:57:21,625 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:57:21,815 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:57:21,894 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:57:21,894 - app.main - INFO - Application shutdown complete.
2025-07-05 17:03:34,619 - root - INFO - Logging configured at level: INFO
2025-07-05 17:03:34,619 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:03:34,641 - app.main - INFO - Application startup initiated.
2025-07-05 17:03:34,642 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:03:34,642 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:03:34,642 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:03:34,642 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:03:34,850 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:03:35,043 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:03:35,120 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:03:35,120 - app.main - INFO - Application shutdown complete.
2025-07-05 17:04:10,839 - root - INFO - Logging configured at level: INFO
2025-07-05 17:04:10,839 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:04:10,856 - app.main - INFO - Application startup initiated.
2025-07-05 17:04:10,857 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:04:10,857 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:04:10,857 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:04:10,857 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:04:11,061 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:04:11,246 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:04:11,319 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:04:11,319 - app.main - INFO - Application shutdown complete.
2025-07-05 17:06:54,029 - root - INFO - Logging configured at level: INFO
2025-07-05 17:06:54,029 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:06:54,069 - app.main - INFO - Application startup initiated.
2025-07-05 17:06:54,070 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:06:54,070 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:06:54,070 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:06:54,070 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:06:54,275 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:06:54,465 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:06:54,527 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:06:54,527 - app.main - INFO - Application shutdown complete.
2025-07-05 17:13:04,205 - root - INFO - Logging configured at level: INFO
2025-07-05 17:13:04,205 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:13:04,246 - app.main - INFO - Application startup initiated.
2025-07-05 17:13:04,247 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:13:04,247 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:13:04,247 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:13:04,248 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:13:04,453 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:13:04,645 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:13:04,665 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:13:04,666 - app.main - INFO - Application shutdown complete.
2025-07-05 17:13:26,986 - root - INFO - Logging configured at level: INFO
2025-07-05 17:13:26,986 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:13:27,024 - app.main - INFO - Application startup initiated.
2025-07-05 17:13:27,025 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:13:27,025 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:13:27,025 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:13:27,025 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:13:27,231 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:13:27,422 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:13:27,487 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:13:27,487 - app.main - INFO - Application shutdown complete.
2025-07-05 17:14:38,324 - root - INFO - Logging configured at level: INFO
2025-07-05 17:14:38,324 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:14:38,366 - app.main - INFO - Application startup initiated.
2025-07-05 17:14:38,367 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:14:38,367 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:14:38,367 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:14:38,368 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:14:38,573 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:14:38,765 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:14:38,828 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:14:38,828 - app.main - INFO - Application shutdown complete.
2025-07-05 17:15:55,240 - root - INFO - Logging configured at level: INFO
2025-07-05 17:15:55,240 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:15:55,281 - app.main - INFO - Application startup initiated.
2025-07-05 17:15:55,281 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:15:55,281 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:15:55,281 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:15:55,282 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:15:55,486 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:15:55,677 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:15:55,737 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:15:55,737 - app.main - INFO - Application shutdown complete.
2025-07-05 17:17:53,005 - root - INFO - Logging configured at level: INFO
2025-07-05 17:17:53,005 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:18:25,103 - root - INFO - Logging configured at level: INFO
2025-07-05 17:18:25,103 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:18:25,125 - app.main - INFO - Application startup initiated.
2025-07-05 17:18:25,126 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:18:25,126 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:18:25,126 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:18:25,126 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:18:25,331 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:18:25,524 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:18:25,600 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:18:25,600 - app.main - INFO - Application shutdown complete.
2025-07-05 17:19:43,027 - root - INFO - Logging configured at level: INFO
2025-07-05 17:19:43,027 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:20:32,095 - root - INFO - Logging configured at level: INFO
2025-07-05 17:20:32,095 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:20:32,116 - app.main - INFO - Application startup initiated.
2025-07-05 17:20:32,117 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:20:32,117 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:20:32,117 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:20:32,117 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:20:32,322 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:20:32,516 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:20:32,592 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:20:32,592 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:22,973 - root - INFO - Logging configured at level: INFO
2025-07-05 17:36:22,973 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:36:23,013 - app.main - INFO - Application startup initiated.
2025-07-05 17:36:23,014 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:36:23,014 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:36:23,014 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-05 17:36:23,014 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 17:36:23,014 - app.main - INFO - Application startup complete.
2025-07-05 17:36:23,014 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 17:36:23,014 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 21:36:23.014666+00:00.
2025-07-05 17:36:23,014 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 17:36:23,014 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 UTC.
2025-07-05 17:36:23,021 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 completed. Processed 1 symbols.
2025-07-05 17:36:23,021 - app.services.aggregation_service - INFO - Next aggregation check in 1416.98 seconds.
2025-07-05 17:36:23,021 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 17:36:23,022 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 17:36:23,045 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 17:36:23,069 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 17:36:23,070 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:36:23,207 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108132
2025-07-05 17:36:23,208 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108132.0 at 2025-07-05 21:35:00+00:00 (granularity: 5min)
2025-07-05 17:36:23,273 - app.api.endpoints - INFO - User testuser_reg successfully registered.
2025-07-05 17:36:23,275 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:36:23,275 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:23,277 - app.main - INFO - Application startup initiated.
2025-07-05 17:36:23,278 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:36:23,278 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:36:23,278 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-05 17:36:23,278 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 17:36:23,278 - app.main - INFO - Application startup complete.
2025-07-05 17:36:23,278 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 17:36:23,278 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 21:36:23.278316+00:00.
2025-07-05 17:36:23,278 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 17:36:23,278 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 UTC.
2025-07-05 17:36:23,279 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 17:36:23,289 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 17:36:23,290 - app.services.aggregation_service - INFO - Next aggregation check in 1416.71 seconds.
2025-07-05 17:36:23,290 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 17:36:23,290 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 17:36:23,501 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 17:36:23,693 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 17:36:23,694 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:36:23,694 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:23,696 - app.main - INFO - Application startup initiated.
2025-07-05 17:36:23,696 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:36:23,696 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:36:23,696 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-05 17:36:23,696 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 17:36:23,696 - app.main - INFO - Application startup complete.
2025-07-05 17:36:23,696 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 17:36:23,696 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 21:36:23.696722+00:00.
2025-07-05 17:36:23,696 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 17:36:23,696 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 UTC.
2025-07-05 17:36:23,697 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 17:36:23,698 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 17:36:23,698 - app.services.aggregation_service - INFO - Next aggregation check in 1416.30 seconds.
2025-07-05 17:36:23,698 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 17:36:23,698 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 17:36:23,909 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 17:36:24,093 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 17:36:24,095 - app.api.endpoints - INFO - User testuser_hist querying historical prices for TEST with granularity 5min from 2025-07-05T21:06:24+00:00 to 2025-07-05T21:41:24+00:00.
2025-07-05 17:36:24,096 - app.api.endpoints - INFO - Returned 5 historical prices for TEST.
2025-07-05 17:36:24,097 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:36:24,097 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:24,098 - app.main - INFO - Application startup initiated.
2025-07-05 17:36:24,098 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:36:24,098 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:36:24,098 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-05 17:36:24,098 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 17:36:24,098 - app.main - INFO - Application startup complete.
2025-07-05 17:36:24,098 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 17:36:24,098 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 21:36:24.098931+00:00.
2025-07-05 17:36:24,098 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 17:36:24,099 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 UTC.
2025-07-05 17:36:24,099 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 17:36:24,100 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 17:36:24,100 - app.services.aggregation_service - INFO - Next aggregation check in 1415.90 seconds.
2025-07-05 17:36:24,100 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 17:36:24,101 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 17:36:24,311 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 17:36:24,495 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 17:36:24,496 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 17:36:24,497 - app.api.endpoints - INFO - Fetched latest price for LATEST from DB and cached it. Price: 500.0
2025-07-05 17:36:24,498 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 17:36:24,498 - app.api.endpoints - INFO - Serving latest price for LATEST from cache.
2025-07-05 17:36:24,498 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:36:24,498 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:36,319 - root - INFO - Logging configured at level: INFO
2025-07-05 17:36:36,319 - root - INFO - Logs will also be written to: app.log
