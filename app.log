2025-07-05 14:51:02,569 - root - INFO - Logging configured at level: INFO
2025-07-05 14:51:02,569 - root - INFO - Logs will also be written to: app.log
2025-07-05 14:51:02,613 - app.main - INFO - Application startup initiated.
2025-07-05 14:51:02,614 - app.main - INFO - Database tables ensured to exist.
2025-07-05 14:51:02,614 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 14:51:02,614 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 14:51:02,614 - app.main - INFO - Application startup complete.
2025-07-05 14:51:02,614 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 14:51:02,614 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 18:51:02.614591+00:00.
2025-07-05 14:51:02,614 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 14:51:02,614 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T17:00:00+00:00 to 2025-07-05T18:00:00+00:00 UTC.
2025-07-05 14:51:02,620 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:51:02,626 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:51:02,627 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:51:02,627 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:51:02,627 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:51:02,627 - app.services.aggregation_service - INFO - Next aggregation check in 537.37 seconds.
2025-07-05 14:51:02,627 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 14:51:02,628 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 14:51:02,652 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 14:51:02,674 - app.api.endpoints - INFO - Attempting to register new user: flow_user
2025-07-05 14:51:02,676 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 14:51:02,835 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108017
2025-07-05 14:51:02,838 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108017.0 at 2025-07-05 18:50:00+00:00 (granularity: 5min)
2025-07-05 14:51:02,877 - app.api.endpoints - INFO - User flow_user successfully registered.
2025-07-05 14:51:02,879 - app.api.endpoints - INFO - Login attempt for user: flow_user
2025-07-05 14:51:03,071 - app.api.endpoints - INFO - User flow_user successfully logged in and token issued.
2025-07-05 14:51:03,073 - app.api.endpoints - INFO - User flow_user triggered manual prefetch for BITCOIN.
2025-07-05 14:51:03,078 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:03,079 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:03,079 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:04,091 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:04,092 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:04,093 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:05,101 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:05,102 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:05,102 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:06,114 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:06,115 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:06,115 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:07,127 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:07,128 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:07,128 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:08,139 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:08,140 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:08,140 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:08,653 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-05 14:51:08,795 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2495.25
2025-07-05 14:51:08,802 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2495.25 at 2025-07-05 18:50:00+00:00 (granularity: 5min)
2025-07-05 14:51:09,148 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:09,149 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:09,149 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:10,160 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:10,161 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:10,161 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:11,173 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:11,174 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:11,174 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:12,186 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:51:12,187 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:51:12,187 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:51:13,231 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 14:51:13,231 - app.main - INFO - Application shutdown complete.
2025-07-05 14:57:51,173 - root - INFO - Logging configured at level: INFO
2025-07-05 14:57:51,173 - root - INFO - Logs will also be written to: app.log
2025-07-05 14:57:51,245 - app.main - INFO - Application startup initiated.
2025-07-05 14:57:51,246 - app.main - INFO - Database tables ensured to exist.
2025-07-05 14:57:51,246 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 14:57:51,246 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 14:57:51,246 - app.main - INFO - Application startup complete.
2025-07-05 14:57:51,246 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 14:57:51,246 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 18:57:51.246851+00:00.
2025-07-05 14:57:51,247 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 14:57:51,247 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T17:00:00+00:00 to 2025-07-05T18:00:00+00:00 UTC.
2025-07-05 14:57:51,256 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:57:51,263 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:57:51,263 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:57:51,263 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:57:51,263 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:57:51,263 - app.services.aggregation_service - INFO - Next aggregation check in 128.74 seconds.
2025-07-05 14:57:51,263 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 14:57:51,264 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 14:57:51,290 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 14:57:51,316 - app.api.endpoints - INFO - Attempting to register new user: flow_user
2025-07-05 14:57:51,317 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 14:57:51,510 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108025
2025-07-05 14:57:51,512 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108025.0 at 2025-07-05 18:55:00+00:00 (granularity: 5min)
2025-07-05 14:57:51,524 - app.api.endpoints - INFO - User flow_user successfully registered.
2025-07-05 14:57:51,526 - app.api.endpoints - INFO - Login attempt for user: flow_user
2025-07-05 14:57:51,720 - app.api.endpoints - INFO - User flow_user successfully logged in and token issued.
2025-07-05 14:57:51,723 - app.api.endpoints - INFO - User flow_user triggered manual prefetch for BITCOIN.
2025-07-05 14:57:51,728 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:51,729 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:51,729 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:52,741 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:52,741 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:52,742 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:53,753 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:53,754 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:53,755 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:54,766 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:54,767 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:54,768 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:55,779 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:55,780 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:55,781 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:56,791 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:56,791 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:56,792 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:57,291 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-05 14:57:57,434 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2495.07
2025-07-05 14:57:57,449 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2495.07 at 2025-07-05 18:55:00+00:00 (granularity: 5min)
2025-07-05 14:57:57,803 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:57,804 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:57,804 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:58,815 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:58,816 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:58,816 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:57:59,826 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:57:59,827 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:57:59,828 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:58:00,839 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:58:00,840 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:58:00,841 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:58:01,887 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 14:58:01,887 - app.main - INFO - Application shutdown complete.
2025-07-05 14:59:42,068 - root - INFO - Logging configured at level: INFO
2025-07-05 14:59:42,068 - root - INFO - Logs will also be written to: app.log
2025-07-05 14:59:42,094 - app.main - INFO - Application startup initiated.
2025-07-05 14:59:42,095 - app.main - INFO - Database tables ensured to exist.
2025-07-05 14:59:42,095 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 14:59:42,095 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 14:59:42,095 - app.main - INFO - Application startup complete.
2025-07-05 14:59:42,095 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 14:59:42,095 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 18:59:42.095559+00:00.
2025-07-05 14:59:42,095 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 14:59:42,095 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T17:00:00+00:00 to 2025-07-05T18:00:00+00:00 UTC.
2025-07-05 14:59:42,114 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:59:42,121 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:59:42,121 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:59:42,121 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:59:42,121 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 17:00:00.000000', 108043.2, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 14:59:42,121 - app.services.aggregation_service - INFO - Next aggregation check in 17.88 seconds.
2025-07-05 14:59:42,121 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 14:59:42,122 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 14:59:42,145 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 14:59:42,166 - app.api.endpoints - INFO - Attempting to register new user: flow_user
2025-07-05 14:59:42,168 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 14:59:42,292 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108027
2025-07-05 14:59:42,292 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:55:00.000000', 108027.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:59:42,370 - app.api.endpoints - INFO - User flow_user successfully registered.
2025-07-05 14:59:42,372 - app.api.endpoints - INFO - Login attempt for user: flow_user
2025-07-05 14:59:42,564 - app.api.endpoints - INFO - User flow_user successfully logged in and token issued.
2025-07-05 14:59:42,566 - app.api.endpoints - INFO - User flow_user triggered manual prefetch for BITCOIN.
2025-07-05 14:59:42,571 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:42,572 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:42,572 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:43,584 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:43,585 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:43,586 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:44,597 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:44,598 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:44,598 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:45,610 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:45,611 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:45,611 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:46,622 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:46,623 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:46,623 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:47,635 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:47,636 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:47,636 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:48,146 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-05 14:59:48,280 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2494.95
2025-07-05 14:59:48,284 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-05 18:55:00.000000', 2494.95, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 14:59:48,654 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:48,655 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:48,655 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:49,667 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:49,668 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:49,668 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:50,675 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:50,676 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:50,677 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:51,687 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 14:59:51,688 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 14:59:51,689 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 14:59:52,727 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 14:59:52,727 - app.main - INFO - Application shutdown complete.
2025-07-05 15:02:45,104 - root - INFO - Logging configured at level: INFO
2025-07-05 15:02:45,104 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:02:45,151 - app.main - INFO - Application startup initiated.
2025-07-05 15:02:45,152 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:02:45,152 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:02:45,152 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:02:45,152 - app.main - INFO - Application startup complete.
2025-07-05 15:02:45,152 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:02:45,152 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:02:45.152508+00:00.
2025-07-05 15:02:45,152 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:02:45,152 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:02:45,160 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 completed. Processed 2 symbols.
2025-07-05 15:02:45,160 - app.services.aggregation_service - INFO - Next aggregation check in 3434.84 seconds.
2025-07-05 15:02:45,160 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:02:45,161 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:02:45,184 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:02:45,206 - app.api.endpoints - INFO - Attempting to register new user: flow_user
2025-07-05 15:02:45,207 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:02:45,378 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108029
2025-07-05 15:02:45,379 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108029.0 at 2025-07-05 19:00:00+00:00 (granularity: 5min)
2025-07-05 15:02:45,410 - app.api.endpoints - INFO - User flow_user successfully registered.
2025-07-05 15:02:45,412 - app.api.endpoints - INFO - Login attempt for user: flow_user
2025-07-05 15:02:45,602 - app.api.endpoints - INFO - User flow_user successfully logged in and token issued.
2025-07-05 15:02:45,605 - app.api.endpoints - INFO - User flow_user triggered manual prefetch for BITCOIN.
2025-07-05 15:02:45,611 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:45,612 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:45,612 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:46,624 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:46,625 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:46,626 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:47,638 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:47,639 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:47,639 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:48,652 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:48,653 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:48,653 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:49,664 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:49,665 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:49,666 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:50,677 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:50,678 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:50,679 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:51,185 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-05 15:02:51,331 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2494.21
2025-07-05 15:02:51,338 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2494.21 at 2025-07-05 19:00:00+00:00 (granularity: 5min)
2025-07-05 15:02:51,690 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:51,691 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:51,691 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:52,703 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:52,704 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:52,704 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:53,716 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:53,717 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:53,718 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:54,730 - app.api.endpoints - INFO - User flow_user querying latest price for BITCOIN with granularity 5min.
2025-07-05 15:02:54,732 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 5min.
2025-07-05 15:02:54,732 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-05 15:02:55,778 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:02:55,778 - app.main - INFO - Application shutdown complete.
2025-07-05 15:10:55,688 - root - INFO - Logging configured at level: INFO
2025-07-05 15:10:55,689 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:11:39,622 - root - INFO - Logging configured at level: INFO
2025-07-05 15:11:39,623 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:11:39,645 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:39,645 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:39,645 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:39,645 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:39,645 - app.main - INFO - Application startup complete.
2025-07-05 15:11:39,645 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:39,645 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:39.645979+00:00.
2025-07-05 15:11:39,646 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:39,646 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:39,664 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:39,672 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:39,672 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:39,672 - app.services.aggregation_service - INFO - Next aggregation check in 2900.33 seconds.
2025-07-05 15:11:39,672 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:39,673 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:39,698 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:11:39,720 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:11:39,879 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 107994
2025-07-05 15:11:39,894 - app.services.ingestion_service - INFO - Ingested BITCOIN price 107994.0 at 2025-07-05 19:10:00+00:00 (granularity: 5min)
2025-07-05 15:11:40,038 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:40,038 - app.main - INFO - Application shutdown complete.
2025-07-05 15:11:40,041 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:40,041 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:40,041 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:40,041 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:40,041 - app.main - INFO - Application startup complete.
2025-07-05 15:11:40,042 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:40,042 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:40.042075+00:00.
2025-07-05 15:11:40,042 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:40,042 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:40,043 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:40,043 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,044 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,044 - app.services.aggregation_service - INFO - Next aggregation check in 2899.96 seconds.
2025-07-05 15:11:40,044 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:40,044 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:40,070 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:11:40,275 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:11:40,467 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:11:40,469 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:40,469 - app.main - INFO - Application shutdown complete.
2025-07-05 15:11:40,472 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:40,472 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:40,472 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:40,472 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:40,472 - app.main - INFO - Application startup complete.
2025-07-05 15:11:40,472 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:40,472 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:40.472564+00:00.
2025-07-05 15:11:40,472 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:40,472 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:40,473 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:40,474 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,474 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,474 - app.services.aggregation_service - INFO - Next aggregation check in 2899.53 seconds.
2025-07-05 15:11:40,474 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:40,475 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:40,686 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:11:40,870 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:11:40,874 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:41:40 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:16:40 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:41:40 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:16:40 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:11:40,876 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:40,876 - app.main - INFO - Application shutdown complete.
2025-07-05 15:11:40,879 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:40,879 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:40,879 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:40,879 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:40,879 - app.main - INFO - Application startup complete.
2025-07-05 15:11:40,879 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:40,879 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:40.879933+00:00.
2025-07-05 15:11:40,879 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:40,880 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:40,888 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:40,889 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,889 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:40,889 - app.services.aggregation_service - INFO - Next aggregation check in 2899.11 seconds.
2025-07-05 15:11:40,889 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:40,890 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:41,100 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:11:41,284 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:11:41,286 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:11:41,400 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:41,400 - app.main - INFO - Application shutdown complete.
2025-07-05 15:11:41,403 - app.main - INFO - Application startup initiated.
2025-07-05 15:11:41,403 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:11:41,403 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:11:41,403 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:11:41,403 - app.main - INFO - Application startup complete.
2025-07-05 15:11:41,403 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:11:41,403 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:11:41.403988+00:00.
2025-07-05 15:11:41,404 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:11:41,404 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:11:41,404 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:11:41,405 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:41,405 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:11:41,406 - app.services.aggregation_service - INFO - Next aggregation check in 2898.59 seconds.
2025-07-05 15:11:41,406 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:11:41,406 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:11:41,617 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:11:41,802 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:11:41,845 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:11:41,846 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:33,892 - root - INFO - Logging configured at level: INFO
2025-07-05 15:16:33,892 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:16:33,914 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:33,915 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:33,915 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:33,915 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:33,915 - app.main - INFO - Application startup complete.
2025-07-05 15:16:33,915 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:33,915 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:33.915320+00:00.
2025-07-05 15:16:33,915 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:33,915 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:33,935 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:33,941 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:33,942 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:33,942 - app.services.aggregation_service - INFO - Next aggregation check in 2606.06 seconds.
2025-07-05 15:16:33,942 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:33,943 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:33,967 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:16:33,989 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:16:34,186 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 107986
2025-07-05 15:16:34,189 - app.services.ingestion_service - INFO - Ingested BITCOIN price 107986.0 at 2025-07-05 19:15:00+00:00 (granularity: 5min)
2025-07-05 15:16:34,313 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:34,313 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:34,316 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:34,316 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:34,316 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:34,316 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:34,316 - app.main - INFO - Application startup complete.
2025-07-05 15:16:34,317 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:34,317 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:34.317057+00:00.
2025-07-05 15:16:34,317 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:34,317 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:34,318 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:34,318 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:34,319 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:34,319 - app.services.aggregation_service - INFO - Next aggregation check in 2605.68 seconds.
2025-07-05 15:16:34,319 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:34,319 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:34,345 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:16:34,552 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:16:34,744 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:16:34,747 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:34,747 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:34,750 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:34,750 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:34,750 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:34,750 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:34,750 - app.main - INFO - Application startup complete.
2025-07-05 15:16:34,750 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:34,750 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:34.750414+00:00.
2025-07-05 15:16:34,750 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:34,750 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:34,751 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:34,752 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:34,752 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:34,752 - app.services.aggregation_service - INFO - Next aggregation check in 2605.25 seconds.
2025-07-05 15:16:34,752 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:34,752 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:34,966 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:16:35,150 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:16:35,154 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:46:35 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:21:35 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:46:35 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:21:35 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:16:35,156 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:35,156 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:35,159 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:35,159 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:35,159 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:35,159 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:35,159 - app.main - INFO - Application startup complete.
2025-07-05 15:16:35,159 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:35,159 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:35.159855+00:00.
2025-07-05 15:16:35,159 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:35,159 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:35,168 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:35,169 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:35,169 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:35,170 - app.services.aggregation_service - INFO - Next aggregation check in 2604.83 seconds.
2025-07-05 15:16:35,170 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:35,170 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:35,380 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:16:35,564 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:16:35,566 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:16:35,680 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:35,680 - app.main - INFO - Application shutdown complete.
2025-07-05 15:16:35,683 - app.main - INFO - Application startup initiated.
2025-07-05 15:16:35,683 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:16:35,683 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:16:35,683 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:16:35,683 - app.main - INFO - Application startup complete.
2025-07-05 15:16:35,684 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:16:35,684 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:16:35.684067+00:00.
2025-07-05 15:16:35,684 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:16:35,684 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:16:35,684 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:16:35,685 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:35,686 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:16:35,686 - app.services.aggregation_service - INFO - Next aggregation check in 2604.31 seconds.
2025-07-05 15:16:35,686 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:16:35,686 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:16:35,898 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:16:36,081 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:16:36,125 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:16:36,125 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:33,073 - root - INFO - Logging configured at level: INFO
2025-07-05 15:19:33,073 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:19:33,094 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:33,095 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:33,095 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:33,095 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:33,095 - app.main - INFO - Application startup complete.
2025-07-05 15:19:33,095 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:33,095 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:33.095503+00:00.
2025-07-05 15:19:33,095 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:33,095 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:33,114 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:33,121 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,121 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,121 - app.services.aggregation_service - INFO - Next aggregation check in 2426.88 seconds.
2025-07-05 15:19:33,121 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:33,122 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:33,147 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:19:33,169 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:19:33,365 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 107970
2025-07-05 15:19:33,366 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:15:00.000000', 107970.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:33,489 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:33,489 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:33,492 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:33,492 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:33,492 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:33,492 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:33,492 - app.main - INFO - Application startup complete.
2025-07-05 15:19:33,493 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:33,493 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:33.493063+00:00.
2025-07-05 15:19:33,493 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:33,493 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:33,494 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:33,495 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,495 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,495 - app.services.aggregation_service - INFO - Next aggregation check in 2426.50 seconds.
2025-07-05 15:19:33,495 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:33,495 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:33,520 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:19:33,725 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:19:33,917 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:19:33,919 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:33,919 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:33,922 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:33,922 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:33,922 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:33,922 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:33,922 - app.main - INFO - Application startup complete.
2025-07-05 15:19:33,922 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:33,922 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:33.922585+00:00.
2025-07-05 15:19:33,922 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:33,922 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:33,923 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:33,924 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,924 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:33,924 - app.services.aggregation_service - INFO - Next aggregation check in 2426.08 seconds.
2025-07-05 15:19:33,924 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:33,924 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:34,136 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:19:34,320 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:19:34,324 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:49:34 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:24:34 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:49:34 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:24:34 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:19:34,326 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:34,326 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:34,328 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:34,329 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:34,329 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:34,329 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:34,329 - app.main - INFO - Application startup complete.
2025-07-05 15:19:34,329 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:34,329 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:34.329207+00:00.
2025-07-05 15:19:34,329 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:34,329 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:34,337 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:34,338 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:34,339 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:34,339 - app.services.aggregation_service - INFO - Next aggregation check in 2425.66 seconds.
2025-07-05 15:19:34,339 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:34,339 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:34,549 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:19:34,734 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:19:34,736 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:19:34,852 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:34,852 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:34,855 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:34,855 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:34,855 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:34,855 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:34,855 - app.main - INFO - Application startup complete.
2025-07-05 15:19:34,855 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:34,855 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:34.855406+00:00.
2025-07-05 15:19:34,855 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:34,855 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:34,856 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:34,857 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:34,857 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:34,857 - app.services.aggregation_service - INFO - Next aggregation check in 2425.14 seconds.
2025-07-05 15:19:34,857 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:34,857 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:35,069 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:19:35,252 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:19:35,296 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:35,296 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:58,918 - root - INFO - Logging configured at level: INFO
2025-07-05 15:19:58,918 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:19:58,934 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:58,935 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:58,935 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:58,935 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:58,935 - app.main - INFO - Application startup complete.
2025-07-05 15:19:58,935 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:58,935 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:58.935406+00:00.
2025-07-05 15:19:58,935 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:58,935 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:58,953 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:58,955 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:58,955 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:58,955 - app.services.aggregation_service - INFO - Next aggregation check in 2401.04 seconds.
2025-07-05 15:19:58,955 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:58,956 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:58,970 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:19:58,992 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:19:59,100 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 107970
2025-07-05 15:19:59,143 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:15:00.000000', 107970.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:59,299 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:59,299 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:59,302 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:59,302 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:59,302 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:59,302 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:59,302 - app.main - INFO - Application startup complete.
2025-07-05 15:19:59,302 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:59,303 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:59.303023+00:00.
2025-07-05 15:19:59,303 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:59,303 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:59,303 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:59,304 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:59,305 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:59,305 - app.services.aggregation_service - INFO - Next aggregation check in 2400.69 seconds.
2025-07-05 15:19:59,305 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:59,305 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:59,330 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:19:59,533 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:19:59,720 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:19:59,722 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:19:59,722 - app.main - INFO - Application shutdown complete.
2025-07-05 15:19:59,724 - app.main - INFO - Application startup initiated.
2025-07-05 15:19:59,724 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:19:59,724 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:19:59,724 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:19:59,724 - app.main - INFO - Application startup complete.
2025-07-05 15:19:59,725 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:19:59,725 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:19:59.725070+00:00.
2025-07-05 15:19:59,725 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:19:59,725 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:19:59,725 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:19:59,726 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:59,727 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:19:59,727 - app.services.aggregation_service - INFO - Next aggregation check in 2400.27 seconds.
2025-07-05 15:19:59,727 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:19:59,727 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:19:59,938 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:20:00,121 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:20:00,125 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:50:00 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:25:00 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:50:00 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:25:00 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:20:00,127 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:20:00,127 - app.main - INFO - Application shutdown complete.
2025-07-05 15:20:00,129 - app.main - INFO - Application startup initiated.
2025-07-05 15:20:00,129 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:20:00,129 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:20:00,129 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:20:00,129 - app.main - INFO - Application startup complete.
2025-07-05 15:20:00,129 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:20:00,130 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:20:00.130019+00:00.
2025-07-05 15:20:00,130 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:20:00,130 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:20:00,138 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:20:00,139 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:20:00,140 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:20:00,140 - app.services.aggregation_service - INFO - Next aggregation check in 2399.86 seconds.
2025-07-05 15:20:00,140 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:20:00,140 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:20:00,350 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:20:00,534 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:20:00,536 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:20:00,651 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:20:00,652 - app.main - INFO - Application shutdown complete.
2025-07-05 15:20:00,654 - app.main - INFO - Application startup initiated.
2025-07-05 15:20:00,654 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:20:00,654 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:20:00,654 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:20:00,654 - app.main - INFO - Application startup complete.
2025-07-05 15:20:00,654 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:20:00,654 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:20:00.654724+00:00.
2025-07-05 15:20:00,654 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:20:00,654 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:20:00,655 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:20:00,656 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:20:00,656 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:20:00,656 - app.services.aggregation_service - INFO - Next aggregation check in 2399.34 seconds.
2025-07-05 15:20:00,656 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:20:00,657 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:20:00,867 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:20:01,051 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:20:01,094 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:20:01,094 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:27,211 - root - INFO - Logging configured at level: INFO
2025-07-05 15:24:27,211 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:24:27,233 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:27,234 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:27,234 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:27,234 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:27,234 - app.main - INFO - Application startup complete.
2025-07-05 15:24:27,234 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:27,234 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:27.234459+00:00.
2025-07-05 15:24:27,234 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:27,234 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:27,240 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:27,247 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,247 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,247 - app.services.aggregation_service - INFO - Next aggregation check in 2132.75 seconds.
2025-07-05 15:24:27,247 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:27,248 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:27,286 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:24:27,308 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:24:27,308 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:24:27,448 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108001
2025-07-05 15:24:27,450 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108001.0 at 2025-07-05 19:20:00+00:00 (granularity: 5min)
2025-07-05 15:24:27,511 - app.api.endpoints - INFO - User testuser_reg successfully registered.
2025-07-05 15:24:27,512 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:27,512 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:27,514 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:27,514 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:27,514 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:27,514 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:27,514 - app.main - INFO - Application startup complete.
2025-07-05 15:24:27,514 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:27,514 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:27.514815+00:00.
2025-07-05 15:24:27,514 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:27,514 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:27,516 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:27,517 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,517 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,517 - app.services.aggregation_service - INFO - Next aggregation check in 2132.48 seconds.
2025-07-05 15:24:27,517 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:27,517 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:27,730 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:24:27,923 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:24:27,924 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:27,925 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:27,926 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:27,926 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:27,926 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:27,926 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:27,926 - app.main - INFO - Application startup complete.
2025-07-05 15:24:27,926 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:27,926 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:27.926721+00:00.
2025-07-05 15:24:27,926 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:27,926 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:27,927 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:27,928 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,928 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:27,928 - app.services.aggregation_service - INFO - Next aggregation check in 2132.07 seconds.
2025-07-05 15:24:27,928 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:27,929 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:28,139 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:24:28,325 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:24:28,329 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:54:28 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:29:28 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:54:28 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:29:28 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:24:28,357 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:28,357 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:28,358 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:28,358 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:28,358 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:28,358 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:28,358 - app.main - INFO - Application startup complete.
2025-07-05 15:24:28,358 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:28,358 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:28.358977+00:00.
2025-07-05 15:24:28,359 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:28,359 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:28,359 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:28,360 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:28,360 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:28,361 - app.services.aggregation_service - INFO - Next aggregation check in 2131.64 seconds.
2025-07-05 15:24:28,361 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:28,361 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:28,571 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:24:28,755 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:24:28,756 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:24:28,853 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:28,853 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:28,854 - app.main - INFO - Application startup initiated.
2025-07-05 15:24:28,854 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:24:28,854 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:24:28,854 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:24:28,855 - app.main - INFO - Application startup complete.
2025-07-05 15:24:28,855 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:24:28,855 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:24:28.855079+00:00.
2025-07-05 15:24:28,855 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:24:28,855 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:24:28,855 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:24:28,856 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:28,857 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:24:28,857 - app.services.aggregation_service - INFO - Next aggregation check in 2131.14 seconds.
2025-07-05 15:24:28,857 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:24:28,857 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:24:29,068 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:24:29,252 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:24:29,295 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:24:29,295 - app.main - INFO - Application shutdown complete.
2025-07-05 15:24:38,106 - root - INFO - Logging configured at level: INFO
2025-07-05 15:24:38,106 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:28:49,335 - root - INFO - Logging configured at level: INFO
2025-07-05 15:28:49,335 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:28:49,376 - app.main - INFO - Application startup initiated.
2025-07-05 15:28:49,376 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:28:49,376 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:28:49,377 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:28:49,377 - app.main - INFO - Application startup complete.
2025-07-05 15:28:49,377 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:28:49,377 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:28:49.377241+00:00.
2025-07-05 15:28:49,377 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:28:49,377 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:28:49,383 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:28:49,389 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:28:49,390 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:28:49,390 - app.services.aggregation_service - INFO - Next aggregation check in 1870.61 seconds.
2025-07-05 15:28:49,390 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:28:49,390 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:28:49,413 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:28:49,434 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:28:49,599 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108015
2025-07-05 15:28:49,601 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108015.0 at 2025-07-05 19:25:00+00:00 (granularity: 5min)
2025-07-05 15:28:49,637 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:28:49,829 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:28:49,832 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:58:49 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:33:49 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T18:58:49 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:33:49 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:28:49,853 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:28:49,853 - app.main - INFO - Application shutdown complete.
2025-07-05 15:31:46,868 - root - INFO - Logging configured at level: INFO
2025-07-05 15:31:46,868 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:31:46,910 - app.main - INFO - Application startup initiated.
2025-07-05 15:31:46,911 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:31:46,911 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:31:46,911 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:31:46,911 - app.main - INFO - Application startup complete.
2025-07-05 15:31:46,911 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:31:46,911 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:31:46.911915+00:00.
2025-07-05 15:31:46,911 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:31:46,912 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:31:46,917 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:31:46,924 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:31:46,924 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:31:46,924 - app.services.aggregation_service - INFO - Next aggregation check in 1693.08 seconds.
2025-07-05 15:31:46,924 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:31:46,925 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:31:46,948 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:31:46,969 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:31:47,112 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108019
2025-07-05 15:31:47,115 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108019.0 at 2025-07-05 19:30:00+00:00 (granularity: 5min)
2025-07-05 15:31:47,174 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:31:47,367 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:31:47,371 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:01:47 00:00 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:36:47 00:00 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:01:47 00:00 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:36:47 00:00 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:31:47,391 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:31:47,391 - app.main - INFO - Application shutdown complete.
2025-07-05 15:33:14,994 - root - INFO - Logging configured at level: INFO
2025-07-05 15:33:14,994 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:33:15,036 - app.main - INFO - Application startup initiated.
2025-07-05 15:33:15,037 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:33:15,037 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:33:15,037 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:33:15,037 - app.main - INFO - Application startup complete.
2025-07-05 15:33:15,037 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:33:15,037 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:33:15.037426+00:00.
2025-07-05 15:33:15,037 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:33:15,037 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:33:15,043 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:33:15,051 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:33:15,051 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:33:15,051 - app.services.aggregation_service - INFO - Next aggregation check in 1604.95 seconds.
2025-07-05 15:33:15,051 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:33:15,052 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:33:15,075 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:33:15,096 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:33:15,217 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108024
2025-07-05 15:33:15,218 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:30:00.000000', 108024.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:33:15,300 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:33:15,494 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:33:15,499 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:03:15 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:38:15 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:03:15 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:38:15 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:33:15,520 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:33:15,520 - app.main - INFO - Application shutdown complete.
2025-07-05 15:36:21,853 - root - INFO - Logging configured at level: INFO
2025-07-05 15:36:21,853 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:36:21,894 - app.main - INFO - Application startup initiated.
2025-07-05 15:36:21,894 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:36:21,894 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:36:21,894 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:36:21,894 - app.main - INFO - Application startup complete.
2025-07-05 15:36:21,895 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:36:21,895 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:36:21.895055+00:00.
2025-07-05 15:36:21,895 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:36:21,895 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:36:21,900 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:36:21,907 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:36:21,907 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:36:21,908 - app.services.aggregation_service - INFO - Next aggregation check in 1418.09 seconds.
2025-07-05 15:36:21,908 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:36:21,908 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:36:21,934 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:36:21,955 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:36:22,105 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108033
2025-07-05 15:36:22,109 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108033.0 at 2025-07-05 19:35:00+00:00 (granularity: 5min)
2025-07-05 15:36:22,160 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:36:22,354 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:36:22,358 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:06:22 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:41:22 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:06:22 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:41:22 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:36:22,378 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:36:22,378 - app.main - INFO - Application shutdown complete.
2025-07-05 15:40:29,804 - root - INFO - Logging configured at level: INFO
2025-07-05 15:40:29,804 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:40:29,845 - app.main - INFO - Application startup initiated.
2025-07-05 15:40:29,846 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:40:29,846 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:40:29,846 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:40:29,846 - app.main - INFO - Application startup complete.
2025-07-05 15:40:29,846 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:40:29,846 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:40:29.846703+00:00.
2025-07-05 15:40:29,846 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:40:29,846 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:40:29,852 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:40:29,858 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:40:29,859 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:40:29,859 - app.services.aggregation_service - INFO - Next aggregation check in 1170.14 seconds.
2025-07-05 15:40:29,859 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:40:29,862 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:40:29,886 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:40:29,907 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:40:30,047 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108058
2025-07-05 15:40:30,050 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108058.0 at 2025-07-05 19:40:00+00:00 (granularity: 5min)
2025-07-05 15:40:30,111 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:40:30,304 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:40:30,308 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:10:30 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:45:30 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:10:30 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:45:30 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:40:30,329 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:40:30,329 - app.main - INFO - Application shutdown complete.
2025-07-05 15:41:13,355 - root - INFO - Logging configured at level: INFO
2025-07-05 15:41:13,355 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:41:13,396 - app.main - INFO - Application startup initiated.
2025-07-05 15:41:13,397 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:41:13,397 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:41:13,397 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:41:13,397 - app.main - INFO - Application startup complete.
2025-07-05 15:41:13,397 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:41:13,397 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:41:13.397803+00:00.
2025-07-05 15:41:13,397 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:41:13,397 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:41:13,403 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:41:13,410 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:41:13,410 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:41:13,411 - app.services.aggregation_service - INFO - Next aggregation check in 1126.59 seconds.
2025-07-05 15:41:13,411 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:41:13,411 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:41:13,435 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:41:13,456 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:41:13,539 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108058
2025-07-05 15:41:13,539 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:40:00.000000', 108058.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:41:13,661 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:41:13,855 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:41:13,859 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:11:00.855573 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:46:00.855573 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:11:00.855573 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:46:00.855573 00:00', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:41:13,880 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:41:13,880 - app.main - INFO - Application shutdown complete.
2025-07-05 15:42:32,859 - root - INFO - Logging configured at level: INFO
2025-07-05 15:42:32,860 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:42:32,901 - app.main - INFO - Application startup initiated.
2025-07-05 15:42:32,901 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:42:32,901 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:42:32,901 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:42:32,901 - app.main - INFO - Application startup complete.
2025-07-05 15:42:32,902 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:42:32,902 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:42:32.902101+00:00.
2025-07-05 15:42:32,902 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:42:32,902 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:42:32,907 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:42:32,914 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:42:32,914 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:42:32,914 - app.services.aggregation_service - INFO - Next aggregation check in 1047.09 seconds.
2025-07-05 15:42:32,914 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:42:32,915 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:42:32,937 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:42:32,958 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:42:33,135 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108072
2025-07-05 15:42:33,136 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:40:00.000000', 108072.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:42:33,162 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:42:33,353 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:42:33,357 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:12:33 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:47:33 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:12:33 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:47:33 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:42:33,378 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:42:33,378 - app.main - INFO - Application shutdown complete.
2025-07-05 15:43:36,343 - root - INFO - Logging configured at level: INFO
2025-07-05 15:43:36,343 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:43:36,385 - app.main - INFO - Application startup initiated.
2025-07-05 15:43:36,385 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:43:36,385 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:43:36,385 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:43:36,385 - app.main - INFO - Application startup complete.
2025-07-05 15:43:36,386 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:43:36,386 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:43:36.386036+00:00.
2025-07-05 15:43:36,386 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:43:36,386 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:43:36,391 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:43:36,398 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:43:36,399 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:43:36,399 - app.services.aggregation_service - INFO - Next aggregation check in 983.60 seconds.
2025-07-05 15:43:36,399 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:43:36,399 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:43:36,423 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:43:36,444 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:43:36,582 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108076
2025-07-05 15:43:36,582 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:40:00.000000', 108076.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:43:36,649 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:43:36,840 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:43:36,845 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:13:36 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:48:36 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:13:36 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:48:36 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:43:36,866 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:43:36,867 - app.main - INFO - Application shutdown complete.
2025-07-05 15:45:24,814 - root - INFO - Logging configured at level: INFO
2025-07-05 15:45:24,814 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:45:24,841 - app.main - INFO - Application startup initiated.
2025-07-05 15:45:24,842 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:45:24,842 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:45:24,842 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:45:24,842 - app.main - INFO - Application startup complete.
2025-07-05 15:45:24,842 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:45:24,842 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:45:24.842570+00:00.
2025-07-05 15:45:24,842 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:45:24,842 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:45:24,848 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:45:24,856 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:45:24,856 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:45:24,857 - app.services.aggregation_service - INFO - Next aggregation check in 875.14 seconds.
2025-07-05 15:45:24,857 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:45:24,857 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:45:24,897 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:45:24,918 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:45:25,049 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108079
2025-07-05 15:45:25,051 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108079.0 at 2025-07-05 19:45:00+00:00 (granularity: 5min)
2025-07-05 15:45:25,121 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:45:25,320 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:45:25,323 - app.main - ERROR - Request validation error for GET /api/v1/prices/TEST: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:15:25 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:50:25 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'datetime_from_date_parsing', 'loc': ('query', 'start_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:15:25 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}, {'type': 'datetime_from_date_parsing', 'loc': ('query', 'end_time'), 'msg': 'Input should be a valid datetime or date, unexpected extra characters at the end of the input', 'input': '2025-07-05T19:50:25 00:00Z', 'ctx': {'error': 'unexpected extra characters at the end of the input'}}]
2025-07-05 15:45:25,344 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:45:25,344 - app.main - INFO - Application shutdown complete.
2025-07-05 15:52:35,326 - root - INFO - Logging configured at level: INFO
2025-07-05 15:52:35,326 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:52:35,368 - app.main - INFO - Application startup initiated.
2025-07-05 15:52:35,369 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:52:35,369 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:52:35,369 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:52:35,369 - app.main - INFO - Application startup complete.
2025-07-05 15:52:35,369 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:52:35,369 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:52:35.369553+00:00.
2025-07-05 15:52:35,369 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:52:35,369 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:52:35,375 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:52:35,382 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:52:35,382 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:52:35,382 - app.services.aggregation_service - INFO - Next aggregation check in 444.62 seconds.
2025-07-05 15:52:35,382 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:52:35,383 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:52:35,408 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:52:35,431 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:52:35,574 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108139
2025-07-05 15:52:35,577 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108139.0 at 2025-07-05 19:50:00+00:00 (granularity: 5min)
2025-07-05 15:52:35,637 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:52:35,831 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:52:35,852 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:52:35,852 - app.main - INFO - Application shutdown complete.
2025-07-05 15:53:48,321 - root - INFO - Logging configured at level: INFO
2025-07-05 15:53:48,322 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:53:48,364 - app.main - INFO - Application startup initiated.
2025-07-05 15:53:48,364 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:53:48,365 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:53:48,365 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:53:48,365 - app.main - INFO - Application startup complete.
2025-07-05 15:53:48,365 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:53:48,365 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:53:48.365213+00:00.
2025-07-05 15:53:48,365 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:53:48,365 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:53:48,370 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:53:48,377 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:53:48,377 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:53:48,377 - app.services.aggregation_service - INFO - Next aggregation check in 371.62 seconds.
2025-07-05 15:53:48,378 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:53:48,378 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:53:48,401 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:53:48,422 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:53:48,603 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108149
2025-07-05 15:53:48,603 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:50:00.000000', 108149.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:53:48,627 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:53:48,821 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:53:48,825 - app.api.endpoints - INFO - User testuser_hist querying historical prices for TEST with granularity 5min from 2025-07-05T19:23:48+00:00 to 2025-07-05T19:58:48+00:00.
2025-07-05 15:53:48,826 - app.api.endpoints - INFO - Returned 5 historical prices for TEST.
2025-07-05 15:53:48,827 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:53:48,828 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:07,699 - root - INFO - Logging configured at level: INFO
2025-07-05 15:54:07,699 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:54:07,720 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:07,721 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:07,721 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:07,721 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:07,721 - app.main - INFO - Application startup complete.
2025-07-05 15:54:07,721 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:07,721 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:07.721406+00:00.
2025-07-05 15:54:07,721 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:07,721 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:07,726 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:07,733 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:07,733 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:07,733 - app.services.aggregation_service - INFO - Next aggregation check in 352.27 seconds.
2025-07-05 15:54:07,733 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:07,734 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:07,770 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:54:07,792 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 15:54:07,793 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:54:07,864 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108149
2025-07-05 15:54:07,864 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:50:00.000000', 108149.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:07,995 - app.api.endpoints - INFO - User testuser_reg successfully registered.
2025-07-05 15:54:07,997 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:07,997 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:07,998 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:07,999 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:07,999 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:07,999 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:07,999 - app.main - INFO - Application startup complete.
2025-07-05 15:54:07,999 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:07,999 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:07.999219+00:00.
2025-07-05 15:54:07,999 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:07,999 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:08,000 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:08,001 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,001 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,001 - app.services.aggregation_service - INFO - Next aggregation check in 352.00 seconds.
2025-07-05 15:54:08,002 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:08,002 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:08,213 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 15:54:08,404 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 15:54:08,405 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:08,405 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:08,407 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:08,407 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:08,407 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:08,407 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:08,407 - app.main - INFO - Application startup complete.
2025-07-05 15:54:08,407 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:08,407 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:08.407545+00:00.
2025-07-05 15:54:08,407 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:08,407 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:08,408 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:08,409 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,409 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,409 - app.services.aggregation_service - INFO - Next aggregation check in 351.59 seconds.
2025-07-05 15:54:08,409 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:08,410 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:08,621 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 15:54:08,805 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 15:54:08,810 - app.api.endpoints - INFO - User testuser_hist querying historical prices for TEST with granularity 5min from 2025-07-05T19:24:08+00:00 to 2025-07-05T19:59:08+00:00.
2025-07-05 15:54:08,810 - app.api.endpoints - INFO - Returned 5 historical prices for TEST.
2025-07-05 15:54:08,811 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:08,811 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:08,812 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:08,812 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:08,813 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:08,813 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:08,813 - app.main - INFO - Application startup complete.
2025-07-05 15:54:08,813 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:08,813 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:08.813146+00:00.
2025-07-05 15:54:08,813 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:08,813 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:08,813 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:08,825 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,826 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:08,826 - app.services.aggregation_service - INFO - Next aggregation check in 351.17 seconds.
2025-07-05 15:54:08,826 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:08,826 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:09,036 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:54:09,219 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:54:09,221 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:54:09,338 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:09,338 - app.main - INFO - Application shutdown complete.
2025-07-05 15:54:09,339 - app.main - INFO - Application startup initiated.
2025-07-05 15:54:09,339 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:54:09,339 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:54:09,339 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:54:09,339 - app.main - INFO - Application startup complete.
2025-07-05 15:54:09,339 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:54:09,340 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:54:09.340014+00:00.
2025-07-05 15:54:09,340 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:54:09,340 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:54:09,340 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:54:09,341 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:09,341 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:54:09,342 - app.services.aggregation_service - INFO - Next aggregation check in 350.66 seconds.
2025-07-05 15:54:09,342 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:54:09,342 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:54:09,552 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 15:54:09,736 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 15:54:09,779 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:54:09,779 - app.main - INFO - Application shutdown complete.
2025-07-05 15:56:01,817 - root - INFO - Logging configured at level: INFO
2025-07-05 15:56:01,817 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:56:01,859 - app.main - INFO - Application startup initiated.
2025-07-05 15:56:01,860 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:56:01,860 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:56:01,860 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:56:01,860 - app.main - INFO - Application startup complete.
2025-07-05 15:56:01,860 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:56:01,860 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:56:01.860537+00:00.
2025-07-05 15:56:01,860 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:56:01,860 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:56:01,866 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:56:01,873 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:56:01,873 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:56:01,873 - app.services.aggregation_service - INFO - Next aggregation check in 238.13 seconds.
2025-07-05 15:56:01,873 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:56:01,874 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:56:01,897 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:56:01,918 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:56:02,123 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:56:02,318 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:56:02,319 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108153
2025-07-05 15:56:02,322 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108153.0 at 2025-07-05 19:55:00+00:00 (granularity: 5min)
2025-07-05 15:56:02,324 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:56:02,440 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:56:02,440 - app.main - INFO - Application shutdown complete.
2025-07-05 15:57:47,723 - root - INFO - Logging configured at level: INFO
2025-07-05 15:57:47,723 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:57:47,744 - app.main - INFO - Application startup initiated.
2025-07-05 15:57:47,744 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:57:47,744 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:57:47,744 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:57:47,744 - app.main - INFO - Application startup complete.
2025-07-05 15:57:47,744 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:57:47,744 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:57:47.744957+00:00.
2025-07-05 15:57:47,745 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:57:47,745 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:57:47,750 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:57:47,757 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:57:47,757 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:57:47,757 - app.services.aggregation_service - INFO - Next aggregation check in 132.24 seconds.
2025-07-05 15:57:47,757 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:57:47,758 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:57:47,795 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:57:47,816 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:57:47,975 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108152
2025-07-05 15:57:47,976 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:55:00.000000', 108152.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:57:48,019 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:57:48,211 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:57:48,213 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:57:48,328 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:57:48,328 - app.main - INFO - Application shutdown complete.
2025-07-05 15:59:54,544 - root - INFO - Logging configured at level: INFO
2025-07-05 15:59:54,544 - root - INFO - Logs will also be written to: app.log
2025-07-05 15:59:54,585 - app.main - INFO - Application startup initiated.
2025-07-05 15:59:54,585 - app.main - INFO - Database tables ensured to exist.
2025-07-05 15:59:54,585 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 15:59:54,586 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 15:59:54,586 - app.main - INFO - Application startup complete.
2025-07-05 15:59:54,586 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 15:59:54,586 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 19:59:54.586256+00:00.
2025-07-05 15:59:54,586 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 15:59:54,586 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T18:00:00+00:00 to 2025-07-05T19:00:00+00:00 UTC.
2025-07-05 15:59:54,591 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:59:54,598 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:59:54,598 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 18:00:00.000000', 108027.4, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 15:59:54,599 - app.services.aggregation_service - INFO - Next aggregation check in 5.40 seconds.
2025-07-05 15:59:54,599 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 15:59:54,599 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 15:59:54,622 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 15:59:54,643 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 15:59:54,796 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108150
2025-07-05 15:59:54,797 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:55:00.000000', 108150.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 15:59:54,862 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 15:59:55,052 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 15:59:55,055 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 15:59:55,173 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 15:59:55,173 - app.main - INFO - Application shutdown complete.
2025-07-05 16:05:56,115 - root - INFO - Logging configured at level: INFO
2025-07-05 16:05:56,116 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:05:56,137 - app.main - INFO - Application startup initiated.
2025-07-05 16:05:56,138 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:05:56,138 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:05:56,138 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:05:56,138 - app.main - INFO - Application startup complete.
2025-07-05 16:05:56,138 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:05:56,138 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:05:56.138737+00:00.
2025-07-05 16:05:56,138 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:05:56,138 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:05:56,146 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 completed. Processed 2 symbols.
2025-07-05 16:05:56,146 - app.services.aggregation_service - INFO - Next aggregation check in 3243.85 seconds.
2025-07-05 16:05:56,146 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:05:56,146 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:05:56,183 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:05:56,204 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:05:56,344 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108168
2025-07-05 16:05:56,345 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108168.0 at 2025-07-05 20:05:00+00:00 (granularity: 5min)
2025-07-05 16:05:56,407 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 16:05:56,598 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 16:05:56,601 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 16:05:56,602 - app.api.endpoints - INFO - Fetched latest price for LATEST from DB and cached it. Price: 500.0
2025-07-05 16:05:56,603 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 16:05:56,603 - app.api.endpoints - INFO - Serving latest price for LATEST from cache.
2025-07-05 16:05:56,603 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:05:56,603 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:15,064 - root - INFO - Logging configured at level: INFO
2025-07-05 16:06:15,064 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:06:15,086 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:15,087 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:15,087 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:15,087 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:15,087 - app.main - INFO - Application startup complete.
2025-07-05 16:06:15,087 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:15,087 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:15.087771+00:00.
2025-07-05 16:06:15,087 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:15,087 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:15,093 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:15,100 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,100 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,100 - app.services.aggregation_service - INFO - Next aggregation check in 3224.90 seconds.
2025-07-05 16:06:15,100 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:15,101 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:15,137 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:06:15,159 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 16:06:15,160 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:06:15,242 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108168
2025-07-05 16:06:15,243 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:05:00.000000', 108168.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:15,362 - app.api.endpoints - INFO - User testuser_reg successfully registered.
2025-07-05 16:06:15,363 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:15,363 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:15,365 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:15,365 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:15,365 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:15,365 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:15,365 - app.main - INFO - Application startup complete.
2025-07-05 16:06:15,365 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:15,365 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:15.365643+00:00.
2025-07-05 16:06:15,365 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:15,365 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:15,367 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:15,368 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,368 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,368 - app.services.aggregation_service - INFO - Next aggregation check in 3224.63 seconds.
2025-07-05 16:06:15,368 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:15,368 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:15,580 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 16:06:15,771 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 16:06:15,772 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:15,772 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:15,774 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:15,774 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:15,774 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:15,774 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:15,774 - app.main - INFO - Application startup complete.
2025-07-05 16:06:15,774 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:15,774 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:15.774550+00:00.
2025-07-05 16:06:15,774 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:15,774 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:15,775 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:15,776 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,776 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:15,776 - app.services.aggregation_service - INFO - Next aggregation check in 3224.22 seconds.
2025-07-05 16:06:15,776 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:15,776 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:15,987 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 16:06:16,170 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 16:06:16,174 - app.api.endpoints - INFO - User testuser_hist querying historical prices for TEST with granularity 5min from 2025-07-05T19:36:16+00:00 to 2025-07-05T20:11:16+00:00.
2025-07-05 16:06:16,174 - app.api.endpoints - INFO - Returned 5 historical prices for TEST.
2025-07-05 16:06:16,175 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:16,175 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:16,176 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:16,176 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:16,176 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:16,176 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:16,176 - app.main - INFO - Application startup complete.
2025-07-05 16:06:16,177 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:16,177 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:16.177039+00:00.
2025-07-05 16:06:16,177 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:16,177 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:16,177 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:16,189 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:16,189 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:16,190 - app.services.aggregation_service - INFO - Next aggregation check in 3223.81 seconds.
2025-07-05 16:06:16,190 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:16,190 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:16,400 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 16:06:16,584 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 16:06:16,585 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 16:06:16,586 - app.api.endpoints - INFO - Fetched latest price for LATEST from DB and cached it. Price: 500.0
2025-07-05 16:06:16,587 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 16:06:16,587 - app.api.endpoints - INFO - Serving latest price for LATEST from cache.
2025-07-05 16:06:16,587 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:16,587 - app.main - INFO - Application shutdown complete.
2025-07-05 16:06:16,589 - app.main - INFO - Application startup initiated.
2025-07-05 16:06:16,589 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:06:16,589 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:06:16,589 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:06:16,589 - app.main - INFO - Application startup complete.
2025-07-05 16:06:16,589 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:06:16,589 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:06:16.589720+00:00.
2025-07-05 16:06:16,589 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:06:16,589 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:06:16,590 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:06:16,591 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:16,591 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:06:16,591 - app.services.aggregation_service - INFO - Next aggregation check in 3223.41 seconds.
2025-07-05 16:06:16,591 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:06:16,591 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:06:16,802 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:06:16,985 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:06:17,047 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:06:17,047 - app.main - INFO - Application shutdown complete.
2025-07-05 16:10:14,029 - root - INFO - Logging configured at level: INFO
2025-07-05 16:10:14,030 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:10:14,050 - app.main - INFO - Application startup initiated.
2025-07-05 16:10:14,051 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:10:14,051 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:10:14,051 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:10:14,051 - app.main - INFO - Application startup complete.
2025-07-05 16:10:14,051 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:10:14,051 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:10:14.051556+00:00.
2025-07-05 16:10:14,051 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:10:14,051 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:10:14,057 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:10:14,064 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:10:14,064 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:10:14,064 - app.services.aggregation_service - INFO - Next aggregation check in 2985.94 seconds.
2025-07-05 16:10:14,064 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:10:14,065 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:10:14,106 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:10:14,127 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:10:14,282 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108135
2025-07-05 16:10:14,286 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108135.0 at 2025-07-05 20:10:00+00:00 (granularity: 5min)
2025-07-05 16:10:14,331 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:10:14,523 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:10:14,585 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:10:14,586 - app.main - INFO - Application shutdown complete.
2025-07-05 16:10:59,634 - root - INFO - Logging configured at level: INFO
2025-07-05 16:10:59,634 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:10:59,655 - app.main - INFO - Application startup initiated.
2025-07-05 16:10:59,656 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:10:59,656 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:10:59,656 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:10:59,656 - app.main - INFO - Application startup complete.
2025-07-05 16:10:59,656 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:10:59,656 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:10:59.656668+00:00.
2025-07-05 16:10:59,656 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:10:59,656 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:10:59,662 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:10:59,669 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:10:59,669 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:10:59,669 - app.services.aggregation_service - INFO - Next aggregation check in 2940.33 seconds.
2025-07-05 16:10:59,669 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:10:59,670 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:10:59,707 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:10:59,728 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:10:59,802 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108135
2025-07-05 16:10:59,804 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:10:00.000000', 108135.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:10:59,932 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:11:00,126 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:11:00,189 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:11:00,189 - app.main - INFO - Application shutdown complete.
2025-07-05 16:19:04,060 - root - INFO - Logging configured at level: INFO
2025-07-05 16:19:04,060 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:20:01,353 - root - INFO - Logging configured at level: INFO
2025-07-05 16:20:01,353 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:20:01,375 - app.main - INFO - Application startup initiated.
2025-07-05 16:20:01,376 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:20:01,376 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:20:01,376 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:20:01,376 - app.main - INFO - Application startup complete.
2025-07-05 16:20:01,376 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:20:01,376 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:20:01.376539+00:00.
2025-07-05 16:20:01,376 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:20:01,376 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:20:01,382 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:20:01,389 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:20:01,389 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:20:01,389 - app.services.aggregation_service - INFO - Next aggregation check in 2398.61 seconds.
2025-07-05 16:20:01,389 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:20:01,390 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:20:01,428 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:20:01,449 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:20:01,599 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108095
2025-07-05 16:20:01,601 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108095.0 at 2025-07-05 20:20:00+00:00 (granularity: 5min)
2025-07-05 16:20:01,654 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:20:01,847 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:20:01,912 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:20:01,912 - app.main - INFO - Application shutdown complete.
2025-07-05 16:20:59,449 - root - INFO - Logging configured at level: INFO
2025-07-05 16:20:59,449 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:20:59,470 - app.main - INFO - Application startup initiated.
2025-07-05 16:20:59,471 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:20:59,471 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:20:59,471 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:20:59,471 - app.main - INFO - Application startup complete.
2025-07-05 16:20:59,471 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:20:59,471 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:20:59.471645+00:00.
2025-07-05 16:20:59,471 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:20:59,471 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:20:59,477 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:20:59,484 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:20:59,484 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:20:59,484 - app.services.aggregation_service - INFO - Next aggregation check in 2340.52 seconds.
2025-07-05 16:20:59,484 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:20:59,485 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:20:59,523 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:20:59,544 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:20:59,609 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108095
2025-07-05 16:20:59,610 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:20:00.000000', 108095.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:20:59,748 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:20:59,941 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:21:00,005 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:21:00,005 - app.main - INFO - Application shutdown complete.
2025-07-05 16:24:01,869 - root - INFO - Logging configured at level: INFO
2025-07-05 16:24:01,869 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:25:08,561 - root - INFO - Logging configured at level: INFO
2025-07-05 16:25:08,561 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:26:39,409 - root - INFO - Logging configured at level: INFO
2025-07-05 16:26:39,410 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:26:39,431 - app.main - INFO - Application startup initiated.
2025-07-05 16:26:39,432 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:26:39,432 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:26:39,432 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:26:39,433 - app.main - INFO - Application startup complete.
2025-07-05 16:26:39,433 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:26:39,433 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:26:39.433137+00:00.
2025-07-05 16:26:39,433 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:26:39,433 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:26:39,439 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:26:39,445 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:26:39,446 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:26:39,446 - app.services.aggregation_service - INFO - Next aggregation check in 2000.55 seconds.
2025-07-05 16:26:39,446 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:26:39,446 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:26:39,485 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:26:39,506 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:26:39,640 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108044
2025-07-05 16:26:39,644 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108044.0 at 2025-07-05 20:25:00+00:00 (granularity: 5min)
2025-07-05 16:26:39,709 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:26:39,900 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:26:39,970 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:26:39,970 - app.main - INFO - Application shutdown complete.
2025-07-05 16:28:48,722 - root - INFO - Logging configured at level: INFO
2025-07-05 16:28:48,723 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:28:48,744 - app.main - INFO - Application startup initiated.
2025-07-05 16:28:48,745 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:28:48,745 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:28:48,745 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:28:48,745 - app.main - INFO - Application startup complete.
2025-07-05 16:28:48,745 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:28:48,745 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:28:48.745718+00:00.
2025-07-05 16:28:48,745 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:28:48,745 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:28:48,751 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:28:48,758 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:28:48,758 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:28:48,758 - app.services.aggregation_service - INFO - Next aggregation check in 1871.24 seconds.
2025-07-05 16:28:48,758 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:28:48,759 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:28:48,797 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:28:48,817 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:28:48,949 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108035
2025-07-05 16:28:48,949 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:25:00.000000', 108035.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:28:49,023 - app.api.endpoints - INFO - Login attempt for user: rate_limiter_user
2025-07-05 16:28:49,215 - app.api.endpoints - INFO - User rate_limiter_user successfully logged in and token issued.
2025-07-05 16:28:49,280 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:28:49,280 - app.main - INFO - Application shutdown complete.
2025-07-05 16:32:23,261 - root - INFO - Logging configured at level: INFO
2025-07-05 16:32:23,261 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:32:23,302 - app.main - INFO - Application startup initiated.
2025-07-05 16:32:23,303 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:32:23,303 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:32:23,303 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:32:23,303 - app.main - INFO - Application startup complete.
2025-07-05 16:32:23,303 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:32:23,303 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:32:23.303436+00:00.
2025-07-05 16:32:23,303 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:32:23,303 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:32:23,309 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:32:23,316 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:32:23,316 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:32:23,316 - app.services.aggregation_service - INFO - Next aggregation check in 1656.68 seconds.
2025-07-05 16:32:23,316 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:32:23,317 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:32:23,341 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:32:23,362 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:32:23,495 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108012
2025-07-05 16:32:23,498 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108012.0 at 2025-07-05 20:30:00+00:00 (granularity: 5min)
2025-07-05 16:32:23,752 - app.api.endpoints - INFO - Login attempt for user: user1
2025-07-05 16:32:23,947 - app.api.endpoints - INFO - User user1 successfully logged in and token issued.
2025-07-05 16:32:23,949 - app.api.endpoints - INFO - Login attempt for user: user2
2025-07-05 16:32:24,133 - app.api.endpoints - INFO - User user2 successfully logged in and token issued.
2025-07-05 16:32:24,194 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:32:24,195 - app.main - INFO - Application shutdown complete.
2025-07-05 16:34:00,588 - root - INFO - Logging configured at level: INFO
2025-07-05 16:34:00,588 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:34:29,769 - root - INFO - Logging configured at level: INFO
2025-07-05 16:34:29,770 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:34:29,791 - app.main - INFO - Application startup initiated.
2025-07-05 16:34:29,792 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:34:29,792 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:34:29,792 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:34:29,792 - app.main - INFO - Application startup complete.
2025-07-05 16:34:29,792 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:34:29,792 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:34:29.792587+00:00.
2025-07-05 16:34:29,792 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:34:29,792 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:34:29,798 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:34:29,805 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:34:29,805 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:34:29,805 - app.services.aggregation_service - INFO - Next aggregation check in 1530.19 seconds.
2025-07-05 16:34:29,805 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:34:29,806 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:34:29,848 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:34:29,869 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:34:30,019 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108028
2025-07-05 16:34:30,021 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:30:00.000000', 108028.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:34:30,072 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:34:30,263 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:34:30,328 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:34:30,329 - app.main - INFO - Application shutdown complete.
2025-07-05 16:43:31,668 - root - INFO - Logging configured at level: INFO
2025-07-05 16:43:31,669 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:43:31,711 - app.main - INFO - Application startup initiated.
2025-07-05 16:43:31,712 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:43:31,712 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:43:31,712 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:43:31,712 - app.main - INFO - Application startup complete.
2025-07-05 16:43:31,712 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:43:31,712 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:43:31.712284+00:00.
2025-07-05 16:43:31,712 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:43:31,712 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:43:31,717 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:43:31,724 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:43:31,725 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:43:31,725 - app.services.aggregation_service - INFO - Next aggregation check in 988.27 seconds.
2025-07-05 16:43:31,725 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:43:31,725 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:43:31,748 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:43:31,769 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:43:31,966 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108081
2025-07-05 16:43:31,969 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108081.0 at 2025-07-05 20:40:00+00:00 (granularity: 5min)
2025-07-05 16:43:31,973 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:43:32,164 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:43:32,225 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:43:32,225 - app.main - INFO - Application shutdown complete.
2025-07-05 16:49:41,375 - root - INFO - Logging configured at level: INFO
2025-07-05 16:49:41,375 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:49:41,414 - app.main - INFO - Application startup initiated.
2025-07-05 16:49:41,415 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:49:41,415 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:49:41,415 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:49:41,415 - app.main - INFO - Application startup complete.
2025-07-05 16:49:41,415 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:49:41,415 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:49:41.415883+00:00.
2025-07-05 16:49:41,415 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:49:41,416 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:49:41,422 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:49:41,428 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:49:41,428 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:49:41,428 - app.services.aggregation_service - INFO - Next aggregation check in 618.57 seconds.
2025-07-05 16:49:41,428 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:49:41,429 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:49:41,452 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:49:41,473 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:49:41,616 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108097
2025-07-05 16:49:41,618 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108097.0 at 2025-07-05 20:45:00+00:00 (granularity: 5min)
2025-07-05 16:49:41,677 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:49:41,870 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:49:41,931 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:49:41,931 - app.main - INFO - Application shutdown complete.
2025-07-05 16:52:42,443 - root - INFO - Logging configured at level: INFO
2025-07-05 16:52:42,443 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:52:42,484 - app.main - INFO - Application startup initiated.
2025-07-05 16:52:42,485 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:52:42,485 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:52:42,485 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:52:42,485 - app.main - INFO - Application startup complete.
2025-07-05 16:52:42,485 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:52:42,485 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:52:42.485510+00:00.
2025-07-05 16:52:42,485 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:52:42,485 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:52:42,491 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:52:42,497 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:52:42,497 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:52:42,498 - app.services.aggregation_service - INFO - Next aggregation check in 437.50 seconds.
2025-07-05 16:52:42,498 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:52:42,498 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:52:42,521 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:52:42,542 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:52:42,711 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108119
2025-07-05 16:52:42,714 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108119.0 at 2025-07-05 20:50:00+00:00 (granularity: 5min)
2025-07-05 16:52:42,746 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:52:42,938 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:52:43,002 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:52:43,002 - app.main - INFO - Application shutdown complete.
2025-07-05 16:53:33,186 - root - INFO - Logging configured at level: INFO
2025-07-05 16:53:33,186 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:53:33,207 - app.main - INFO - Application startup initiated.
2025-07-05 16:53:33,207 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:53:33,207 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:53:33,207 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 16:53:33,207 - app.main - INFO - Application startup complete.
2025-07-05 16:53:33,207 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 16:53:33,207 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 20:53:33.207947+00:00.
2025-07-05 16:53:33,208 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 16:53:33,208 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T19:00:00+00:00 to 2025-07-05T20:00:00+00:00 UTC.
2025-07-05 16:53:33,214 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:53:33,220 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:53:33,220 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 19:00:00.000000', 108046.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 16:53:33,220 - app.services.aggregation_service - INFO - Next aggregation check in 386.78 seconds.
2025-07-05 16:53:33,220 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 16:53:33,221 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 16:53:33,258 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 16:53:33,279 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:53:33,345 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108119
2025-07-05 16:53:33,345 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:50:00.000000', 108119.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 16:53:33,485 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:53:33,679 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:53:33,741 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:53:33,741 - app.main - INFO - Application shutdown complete.
2025-07-05 16:57:21,398 - root - INFO - Logging configured at level: INFO
2025-07-05 16:57:21,399 - root - INFO - Logs will also be written to: app.log
2025-07-05 16:57:21,420 - app.main - INFO - Application startup initiated.
2025-07-05 16:57:21,420 - app.main - INFO - Database tables ensured to exist.
2025-07-05 16:57:21,420 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 16:57:21,420 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 16:57:21,421 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 16:57:21,625 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 16:57:21,815 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 16:57:21,894 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 16:57:21,894 - app.main - INFO - Application shutdown complete.
2025-07-05 17:03:34,619 - root - INFO - Logging configured at level: INFO
2025-07-05 17:03:34,619 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:03:34,641 - app.main - INFO - Application startup initiated.
2025-07-05 17:03:34,642 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:03:34,642 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:03:34,642 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:03:34,642 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:03:34,850 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:03:35,043 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:03:35,120 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:03:35,120 - app.main - INFO - Application shutdown complete.
2025-07-05 17:04:10,839 - root - INFO - Logging configured at level: INFO
2025-07-05 17:04:10,839 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:04:10,856 - app.main - INFO - Application startup initiated.
2025-07-05 17:04:10,857 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:04:10,857 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:04:10,857 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:04:10,857 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:04:11,061 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:04:11,246 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:04:11,319 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:04:11,319 - app.main - INFO - Application shutdown complete.
2025-07-05 17:06:54,029 - root - INFO - Logging configured at level: INFO
2025-07-05 17:06:54,029 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:06:54,069 - app.main - INFO - Application startup initiated.
2025-07-05 17:06:54,070 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:06:54,070 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:06:54,070 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:06:54,070 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:06:54,275 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:06:54,465 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:06:54,527 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:06:54,527 - app.main - INFO - Application shutdown complete.
2025-07-05 17:13:04,205 - root - INFO - Logging configured at level: INFO
2025-07-05 17:13:04,205 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:13:04,246 - app.main - INFO - Application startup initiated.
2025-07-05 17:13:04,247 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:13:04,247 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:13:04,247 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:13:04,248 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:13:04,453 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:13:04,645 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:13:04,665 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:13:04,666 - app.main - INFO - Application shutdown complete.
2025-07-05 17:13:26,986 - root - INFO - Logging configured at level: INFO
2025-07-05 17:13:26,986 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:13:27,024 - app.main - INFO - Application startup initiated.
2025-07-05 17:13:27,025 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:13:27,025 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:13:27,025 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:13:27,025 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:13:27,231 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:13:27,422 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:13:27,487 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:13:27,487 - app.main - INFO - Application shutdown complete.
2025-07-05 17:14:38,324 - root - INFO - Logging configured at level: INFO
2025-07-05 17:14:38,324 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:14:38,366 - app.main - INFO - Application startup initiated.
2025-07-05 17:14:38,367 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:14:38,367 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:14:38,367 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:14:38,368 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:14:38,573 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:14:38,765 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:14:38,828 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:14:38,828 - app.main - INFO - Application shutdown complete.
2025-07-05 17:15:55,240 - root - INFO - Logging configured at level: INFO
2025-07-05 17:15:55,240 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:15:55,281 - app.main - INFO - Application startup initiated.
2025-07-05 17:15:55,281 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:15:55,281 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:15:55,281 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:15:55,282 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:15:55,486 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:15:55,677 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:15:55,737 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:15:55,737 - app.main - INFO - Application shutdown complete.
2025-07-05 17:17:53,005 - root - INFO - Logging configured at level: INFO
2025-07-05 17:17:53,005 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:18:25,103 - root - INFO - Logging configured at level: INFO
2025-07-05 17:18:25,103 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:18:25,125 - app.main - INFO - Application startup initiated.
2025-07-05 17:18:25,126 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:18:25,126 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:18:25,126 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:18:25,126 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:18:25,331 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:18:25,524 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:18:25,600 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:18:25,600 - app.main - INFO - Application shutdown complete.
2025-07-05 17:19:43,027 - root - INFO - Logging configured at level: INFO
2025-07-05 17:19:43,027 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:20:32,095 - root - INFO - Logging configured at level: INFO
2025-07-05 17:20:32,095 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:20:32,116 - app.main - INFO - Application startup initiated.
2025-07-05 17:20:32,117 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:20:32,117 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:20:32,117 - app.main - INFO - Background jobs are disabled. Application will run without ingestion or aggregation tasks.
2025-07-05 17:20:32,117 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:20:32,322 - app.api.endpoints - INFO - Login attempt for user: rate_limit_user
2025-07-05 17:20:32,516 - app.api.endpoints - INFO - User rate_limit_user successfully logged in and token issued.
2025-07-05 17:20:32,592 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:20:32,592 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:22,973 - root - INFO - Logging configured at level: INFO
2025-07-05 17:36:22,973 - root - INFO - Logs will also be written to: app.log
2025-07-05 17:36:23,013 - app.main - INFO - Application startup initiated.
2025-07-05 17:36:23,014 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:36:23,014 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:36:23,014 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-05 17:36:23,014 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 17:36:23,014 - app.main - INFO - Application startup complete.
2025-07-05 17:36:23,014 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 17:36:23,014 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 21:36:23.014666+00:00.
2025-07-05 17:36:23,014 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 17:36:23,014 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 UTC.
2025-07-05 17:36:23,021 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 completed. Processed 1 symbols.
2025-07-05 17:36:23,021 - app.services.aggregation_service - INFO - Next aggregation check in 1416.98 seconds.
2025-07-05 17:36:23,021 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 17:36:23,022 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 17:36:23,045 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-05 17:36:23,069 - app.api.endpoints - INFO - Attempting to register new user: testuser_reg
2025-07-05 17:36:23,070 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-05 17:36:23,207 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108132
2025-07-05 17:36:23,208 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108132.0 at 2025-07-05 21:35:00+00:00 (granularity: 5min)
2025-07-05 17:36:23,273 - app.api.endpoints - INFO - User testuser_reg successfully registered.
2025-07-05 17:36:23,275 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:36:23,275 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:23,277 - app.main - INFO - Application startup initiated.
2025-07-05 17:36:23,278 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:36:23,278 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:36:23,278 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-05 17:36:23,278 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 17:36:23,278 - app.main - INFO - Application startup complete.
2025-07-05 17:36:23,278 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 17:36:23,278 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 21:36:23.278316+00:00.
2025-07-05 17:36:23,278 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 17:36:23,278 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 UTC.
2025-07-05 17:36:23,279 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 17:36:23,289 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 17:36:23,290 - app.services.aggregation_service - INFO - Next aggregation check in 1416.71 seconds.
2025-07-05 17:36:23,290 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 17:36:23,290 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 17:36:23,501 - app.api.endpoints - INFO - Login attempt for user: testuser_login
2025-07-05 17:36:23,693 - app.api.endpoints - INFO - User testuser_login successfully logged in and token issued.
2025-07-05 17:36:23,694 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:36:23,694 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:23,696 - app.main - INFO - Application startup initiated.
2025-07-05 17:36:23,696 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:36:23,696 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:36:23,696 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-05 17:36:23,696 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 17:36:23,696 - app.main - INFO - Application startup complete.
2025-07-05 17:36:23,696 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 17:36:23,696 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 21:36:23.696722+00:00.
2025-07-05 17:36:23,696 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 17:36:23,696 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 UTC.
2025-07-05 17:36:23,697 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 17:36:23,698 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 17:36:23,698 - app.services.aggregation_service - INFO - Next aggregation check in 1416.30 seconds.
2025-07-05 17:36:23,698 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 17:36:23,698 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 17:36:23,909 - app.api.endpoints - INFO - Login attempt for user: testuser_hist
2025-07-05 17:36:24,093 - app.api.endpoints - INFO - User testuser_hist successfully logged in and token issued.
2025-07-05 17:36:24,095 - app.api.endpoints - INFO - User testuser_hist querying historical prices for TEST with granularity 5min from 2025-07-05T21:06:24+00:00 to 2025-07-05T21:41:24+00:00.
2025-07-05 17:36:24,096 - app.api.endpoints - INFO - Returned 5 historical prices for TEST.
2025-07-05 17:36:24,097 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:36:24,097 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:24,098 - app.main - INFO - Application startup initiated.
2025-07-05 17:36:24,098 - app.main - INFO - Database tables ensured to exist.
2025-07-05 17:36:24,098 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-05 17:36:24,098 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-05 17:36:24,098 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-05 17:36:24,098 - app.main - INFO - Application startup complete.
2025-07-05 17:36:24,098 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-05 17:36:24,098 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-05 21:36:24.098931+00:00.
2025-07-05 17:36:24,098 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-05 17:36:24,099 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-05T20:00:00+00:00 to 2025-07-05T21:00:00+00:00 UTC.
2025-07-05 17:36:24,099 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 15, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-05 17:36:24,100 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-05 20:00:00.000000', 108093.875, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-05 17:36:24,100 - app.services.aggregation_service - INFO - Next aggregation check in 1415.90 seconds.
2025-07-05 17:36:24,100 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-05 17:36:24,101 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-05 17:36:24,311 - app.api.endpoints - INFO - Login attempt for user: testuser_latest
2025-07-05 17:36:24,495 - app.api.endpoints - INFO - User testuser_latest successfully logged in and token issued.
2025-07-05 17:36:24,496 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 17:36:24,497 - app.api.endpoints - INFO - Fetched latest price for LATEST from DB and cached it. Price: 500.0
2025-07-05 17:36:24,498 - app.api.endpoints - INFO - User testuser_latest querying latest price for LATEST with granularity 5min.
2025-07-05 17:36:24,498 - app.api.endpoints - INFO - Serving latest price for LATEST from cache.
2025-07-05 17:36:24,498 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-05 17:36:24,498 - app.main - INFO - Application shutdown complete.
2025-07-05 17:36:36,319 - root - INFO - Logging configured at level: INFO
2025-07-05 17:36:36,319 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:42:05,928 - root - INFO - Logging configured at level: INFO
2025-07-06 08:42:05,928 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:42:05,932 - app.main - INFO - Application startup initiated.
2025-07-06 08:42:05,936 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:42:05,936 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:42:05,936 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:42:05,936 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 08:42:05,936 - app.main - INFO - Application startup complete.
2025-07-06 08:42:05,936 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:42:05,936 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:42:05.936891+00:00.
2025-07-06 08:42:05,936 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:42:05,937 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:42:05,941 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:42:05,941 - app.services.aggregation_service - INFO - Next aggregation check in 1074.06 seconds.
2025-07-06 08:42:05,941 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:42:05,942 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:42:05,972 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:42:06,138 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108134
2025-07-06 08:42:06,143 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108134.0 at 2025-07-06 12:40:00+00:00 (granularity: 5min)
2025-07-06 08:42:11,973 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 08:42:12,116 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2517.97
2025-07-06 08:42:12,132 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2517.97 at 2025-07-06 12:40:00+00:00 (granularity: 5min)
2025-07-06 08:42:17,975 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 08:42:18,098 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 08:42:18,105 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 12:40:00+00:00 (granularity: 5min)
2025-07-06 08:42:23,975 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 08:42:24,102 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 148.3
2025-07-06 08:42:24,110 - app.services.ingestion_service - INFO - Ingested SOLANA price 148.3 at 2025-07-06 12:40:00+00:00 (granularity: 5min)
2025-07-06 08:42:29,977 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 08:42:30,110 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.579323
2025-07-06 08:42:30,114 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.579323 at 2025-07-06 12:40:00+00:00 (granularity: 5min)
2025-07-06 08:42:35,978 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 08:42:36,101 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.165656
2025-07-06 08:42:36,104 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.165656 at 2025-07-06 12:40:00+00:00 (granularity: 5min)
2025-07-06 08:42:36,104 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 143.90 seconds.
2025-07-06 08:44:49,599 - app.api.endpoints - INFO - Attempting to register new user: testuser_7ebe3027
2025-07-06 08:44:49,604 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-06 08:44:49,818 - app.api.endpoints - INFO - User testuser_7ebe3027 successfully registered.
2025-07-06 08:44:49,821 - app.api.endpoints - INFO - Login attempt for user: testuser_7ebe3027
2025-07-06 08:44:50,012 - app.api.endpoints - INFO - User testuser_7ebe3027 successfully logged in and token issued.
2025-07-06 08:44:50,016 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 5min from 2025-07-05T12:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,017 - app.api.endpoints - INFO - Returned 1 historical prices for BITCOIN.
2025-07-06 08:44:50,018 - app.api.endpoints - INFO - User testuser_7ebe3027 querying latest price for BITCOIN with granularity 5min.
2025-07-06 08:44:50,019 - app.api.endpoints - INFO - Fetched latest price for BITCOIN from DB and cached it. Price: 108134.0
2025-07-06 08:44:50,021 - app.api.endpoints - INFO - User testuser_7ebe3027 triggered manual prefetch for ETHEREUM.
2025-07-06 08:44:50,026 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 08:44:50,099 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 1h from 2025-07-04T12:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,099 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity 1h in the requested range.
2025-07-06 08:44:50,100 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 08:44:50,101 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 1d from 2025-06-26T12:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,101 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity 1d in the requested range.
2025-07-06 08:44:50,101 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 08:44:50,102 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 5min from 2025-07-06T11:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,102 - app.api.endpoints - INFO - Returned 1 historical prices for BITCOIN.
2025-07-06 08:44:50,103 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 1h from 2025-07-04T12:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,104 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity 1h in the requested range.
2025-07-06 08:44:50,104 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 08:44:50,105 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 1d from 2025-06-26T12:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,105 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity 1d in the requested range.
2025-07-06 08:44:50,105 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 08:44:50,107 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 5min from 2025-07-04T12:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,107 - app.api.endpoints - INFO - Returned 1 historical prices for BITCOIN.
2025-07-06 08:44:50,108 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 1h from 2025-06-26T12:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,108 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity 1h in the requested range.
2025-07-06 08:44:50,108 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 08:44:50,110 - app.api.endpoints - INFO - User testuser_7ebe3027 querying historical prices for BITCOIN with granularity 1d from 2025-06-06T12:44:50.014631+00:00 to 2025-07-06T12:44:50.014631+00:00.
2025-07-06 08:44:50,110 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity 1d in the requested range.
2025-07-06 08:44:50,110 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 08:44:50,111 - app.api.endpoints - INFO - User testuser_7ebe3027 querying latest price for BITCOIN with granularity 5min.
2025-07-06 08:44:50,111 - app.api.endpoints - INFO - Serving latest price for BITCOIN from cache.
2025-07-06 08:44:50,114 - app.api.endpoints - INFO - User testuser_7ebe3027 querying latest price for BITCOIN with granularity 5min.
2025-07-06 08:44:50,114 - app.api.endpoints - INFO - Serving latest price for BITCOIN from cache.
2025-07-06 08:44:50,115 - app.api.endpoints - INFO - User testuser_7ebe3027 querying latest price for NEWTOKEN with granularity 5min.
2025-07-06 08:44:50,115 - app.api.endpoints - WARNING - No latest price data found in DB for NEWTOKEN with granularity 5min.
2025-07-06 08:44:50,116 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/newtoken: No latest price data found
2025-07-06 08:44:50,145 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2518.89
2025-07-06 08:44:50,146 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 12:40:00.000000', 2518.89, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:45:00,002 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:45:00.001839+00:00.
2025-07-06 08:45:00,016 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:45:00,185 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108152
2025-07-06 08:45:00,190 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108152.0 at 2025-07-06 12:45:00+00:00 (granularity: 5min)
2025-07-06 08:45:06,016 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 08:45:06,089 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2518.89
2025-07-06 08:45:06,091 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2518.89 at 2025-07-06 12:45:00+00:00 (granularity: 5min)
2025-07-06 08:45:12,018 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 08:45:12,140 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 08:45:12,143 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 12:45:00+00:00 (granularity: 5min)
2025-07-06 08:45:18,018 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 08:45:18,137 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 148.33
2025-07-06 08:45:18,145 - app.services.ingestion_service - INFO - Ingested SOLANA price 148.33 at 2025-07-06 12:45:00+00:00 (granularity: 5min)
2025-07-06 08:45:24,019 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 08:45:24,158 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.579533
2025-07-06 08:45:24,164 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.579533 at 2025-07-06 12:45:00+00:00 (granularity: 5min)
2025-07-06 08:45:30,021 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 08:45:30,147 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.165742
2025-07-06 08:45:30,150 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.165742 at 2025-07-06 12:45:00+00:00 (granularity: 5min)
2025-07-06 08:45:30,150 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.85 seconds.
2025-07-06 08:46:34,811 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 08:46:34,812 - app.main - INFO - Application shutdown complete.
2025-07-06 08:46:35,387 - root - INFO - Logging configured at level: INFO
2025-07-06 08:46:35,387 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:46:35,392 - app.main - INFO - Application startup initiated.
2025-07-06 08:46:35,393 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:46:35,393 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:46:35,393 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:46:35,393 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 08:46:35,393 - app.main - INFO - Application startup complete.
2025-07-06 08:46:35,393 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:46:35,393 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:46:35.393847+00:00.
2025-07-06 08:46:35,393 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:46:35,393 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:46:35,396 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:46:35,396 - app.services.aggregation_service - INFO - Next aggregation check in 804.60 seconds.
2025-07-06 08:46:35,396 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:46:35,397 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:46:35,423 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:46:35,570 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108164
2025-07-06 08:46:35,572 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:45:00.000000', 108164.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:46:41,423 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 08:46:41,561 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2519.11
2025-07-06 08:46:41,563 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 12:45:00.000000', 2519.11, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:46:47,423 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 08:46:47,588 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 08:46:47,591 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 12:45:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:46:53,425 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 08:46:53,552 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 148.4
2025-07-06 08:46:53,561 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 12:45:00.000000', 148.4, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:46:59,426 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 08:46:59,556 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.579807
2025-07-06 08:46:59,559 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 12:45:00.000000', 0.579807, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:47:05,427 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 08:47:05,547 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.165829
2025-07-06 08:47:05,548 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 12:45:00.000000', 0.165829, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:47:05,548 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 174.45 seconds.
2025-07-06 08:47:37,864 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 08:47:37,865 - app.main - INFO - Application shutdown complete.
2025-07-06 08:47:38,343 - root - INFO - Logging configured at level: INFO
2025-07-06 08:47:38,343 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:47:38,349 - app.main - INFO - Application startup initiated.
2025-07-06 08:47:38,350 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:47:38,350 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:47:38,350 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:47:38,350 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 08:47:38,350 - app.main - INFO - Application startup complete.
2025-07-06 08:47:38,350 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:47:38,350 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:47:38.350457+00:00.
2025-07-06 08:47:38,350 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:47:38,350 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:47:38,354 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:47:38,354 - app.services.aggregation_service - INFO - Next aggregation check in 741.65 seconds.
2025-07-06 08:47:38,354 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:47:38,355 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:47:38,380 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:47:38,538 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108170
2025-07-06 08:47:38,540 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:45:00.000000', 108170.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:47:39,364 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 08:47:39,364 - app.main - INFO - Application shutdown complete.
2025-07-06 08:47:39,699 - root - INFO - Logging configured at level: INFO
2025-07-06 08:47:39,699 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:47:39,703 - app.main - INFO - Application startup initiated.
2025-07-06 08:47:39,704 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:47:39,704 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:47:39,704 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:47:39,707 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:47:39,707 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:47:39.707370+00:00.
2025-07-06 08:47:39,707 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:47:39,707 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:47:39,710 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:47:39,710 - app.services.aggregation_service - INFO - Next aggregation check in 740.29 seconds.
2025-07-06 08:47:39,710 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:47:39,711 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:47:39,726 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:49:04,362 - root - INFO - Logging configured at level: INFO
2025-07-06 08:49:04,362 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:49:04,369 - app.main - INFO - Application startup initiated.
2025-07-06 08:49:04,371 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:49:04,371 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:49:04,371 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:49:04,372 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:49:04,372 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:49:04.372400+00:00.
2025-07-06 08:49:04,372 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:49:04,372 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:49:04,376 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:49:04,376 - app.services.aggregation_service - INFO - Next aggregation check in 655.62 seconds.
2025-07-06 08:49:04,376 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:49:04,377 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:49:04,406 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:49:06,882 - root - INFO - Logging configured at level: INFO
2025-07-06 08:49:06,882 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:49:06,887 - app.main - INFO - Application startup initiated.
2025-07-06 08:49:06,887 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:49:06,888 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:49:06,888 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:49:06,888 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:49:06,888 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:49:06.888836+00:00.
2025-07-06 08:49:06,888 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:49:06,888 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:49:06,892 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:49:06,892 - app.services.aggregation_service - INFO - Next aggregation check in 653.11 seconds.
2025-07-06 08:49:06,892 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:49:06,892 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:49:06,909 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:49:25,482 - root - INFO - Logging configured at level: INFO
2025-07-06 08:49:25,482 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:49:25,486 - app.main - INFO - Application startup initiated.
2025-07-06 08:49:25,486 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:49:25,487 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:49:25,487 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:49:25,487 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:49:25,487 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:49:25.487777+00:00.
2025-07-06 08:49:25,487 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:49:25,488 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:49:25,490 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:49:25,490 - app.services.aggregation_service - INFO - Next aggregation check in 634.51 seconds.
2025-07-06 08:49:25,490 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:49:25,491 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:49:25,505 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:49:37,548 - root - INFO - Logging configured at level: INFO
2025-07-06 08:49:37,548 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:49:37,552 - app.main - INFO - Application startup initiated.
2025-07-06 08:49:37,553 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:49:37,553 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:49:37,553 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:49:37,555 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:49:37,555 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:49:37.555875+00:00.
2025-07-06 08:49:37,555 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:49:37,555 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:49:37,558 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:49:37,558 - app.services.aggregation_service - INFO - Next aggregation check in 622.44 seconds.
2025-07-06 08:49:37,558 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:49:37,559 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:49:37,582 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:50:29,059 - root - INFO - Logging configured at level: INFO
2025-07-06 08:50:29,060 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:50:29,073 - app.main - INFO - Application startup initiated.
2025-07-06 08:50:29,074 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:50:29,074 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:50:29,074 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:50:29,075 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:50:29,075 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:50:29.075985+00:00.
2025-07-06 08:50:29,076 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:50:29,076 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:50:29,080 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:50:29,080 - app.services.aggregation_service - INFO - Next aggregation check in 570.92 seconds.
2025-07-06 08:50:29,080 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:50:29,082 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:50:29,110 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:50:32,672 - root - INFO - Logging configured at level: INFO
2025-07-06 08:50:32,672 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:50:32,676 - app.main - INFO - Application startup initiated.
2025-07-06 08:50:32,677 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:50:32,677 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:50:32,677 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:50:32,677 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 08:50:32,677 - app.main - INFO - Application startup complete.
2025-07-06 08:50:32,677 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:50:32,677 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:50:32.677774+00:00.
2025-07-06 08:50:32,677 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:50:32,677 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:50:32,680 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:50:32,680 - app.services.aggregation_service - INFO - Next aggregation check in 567.32 seconds.
2025-07-06 08:50:32,680 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:50:32,681 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:50:32,697 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:50:32,845 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108187
2025-07-06 08:50:32,850 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108187.0 at 2025-07-06 12:50:00+00:00 (granularity: 5min)
2025-07-06 08:50:38,697 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 08:50:38,855 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2520.11
2025-07-06 08:50:38,859 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2520.11 at 2025-07-06 12:50:00+00:00 (granularity: 5min)
2025-07-06 08:50:44,698 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 08:50:44,829 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 08:50:44,832 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 12:50:00+00:00 (granularity: 5min)
2025-07-06 08:50:50,699 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 08:50:50,830 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 148.43
2025-07-06 08:50:50,833 - app.services.ingestion_service - INFO - Ingested SOLANA price 148.43 at 2025-07-06 12:50:00+00:00 (granularity: 5min)
2025-07-06 08:50:56,700 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 08:50:56,830 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.580182
2025-07-06 08:50:56,844 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.580182 at 2025-07-06 12:50:00+00:00 (granularity: 5min)
2025-07-06 08:51:02,700 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 08:51:02,841 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.16628
2025-07-06 08:51:02,844 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.16628 at 2025-07-06 12:50:00+00:00 (granularity: 5min)
2025-07-06 08:51:02,844 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 237.16 seconds.
2025-07-06 08:51:55,381 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 08:51:55,382 - app.main - INFO - Application shutdown complete.
2025-07-06 08:51:55,821 - root - INFO - Logging configured at level: INFO
2025-07-06 08:51:55,821 - root - INFO - Logs will also be written to: app.log
2025-07-06 08:51:55,825 - app.main - INFO - Application startup initiated.
2025-07-06 08:51:55,826 - app.main - INFO - Database tables ensured to exist.
2025-07-06 08:51:55,826 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 08:51:55,826 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 08:51:55,826 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 08:51:55,826 - app.main - INFO - Application startup complete.
2025-07-06 08:51:55,826 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 08:51:55,826 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:51:55.826598+00:00.
2025-07-06 08:51:55,826 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 08:51:55,826 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T11:00:00+00:00 to 2025-07-06T12:00:00+00:00 UTC.
2025-07-06 08:51:55,829 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 11:00:00+00:00 to 2025-07-06 12:00:00+00:00.
2025-07-06 08:51:55,829 - app.services.aggregation_service - INFO - Next aggregation check in 484.17 seconds.
2025-07-06 08:51:55,829 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 08:51:55,830 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 08:51:55,851 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:51:56,007 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108189
2025-07-06 08:51:56,009 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:50:00.000000', 108189.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:52:01,852 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 08:52:02,006 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2520.17
2025-07-06 08:52:02,009 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 12:50:00.000000', 2520.17, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:52:07,854 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 08:52:07,975 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 08:52:07,978 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 12:50:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:52:13,855 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 08:52:13,989 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 148.43
2025-07-06 08:52:13,997 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 12:50:00.000000', 148.43, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:52:19,855 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 08:52:19,984 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.580272
2025-07-06 08:52:19,986 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 12:50:00.000000', 0.580272, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:52:25,857 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 08:52:25,985 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.166365
2025-07-06 08:52:25,987 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 12:50:00.000000', 0.166365, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 08:52:25,988 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 154.01 seconds.
2025-07-06 08:55:00,004 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 12:55:00.003914+00:00.
2025-07-06 08:55:00,026 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 08:55:00,199 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108191
2025-07-06 08:55:00,206 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108191.0 at 2025-07-06 12:55:00+00:00 (granularity: 5min)
2025-07-06 08:55:06,027 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 08:55:06,152 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2520.06
2025-07-06 08:55:06,157 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2520.06 at 2025-07-06 12:55:00+00:00 (granularity: 5min)
2025-07-06 08:55:06,261 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 08:55:06,261 - app.main - INFO - Application shutdown complete.
2025-07-06 09:37:19,505 - root - INFO - Logging configured at level: INFO
2025-07-06 09:37:19,505 - root - INFO - Logs will also be written to: app.log
2025-07-06 09:37:19,509 - app.main - INFO - Application startup initiated.
2025-07-06 09:37:19,510 - app.main - INFO - Database tables ensured to exist.
2025-07-06 09:37:19,510 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 09:37:19,510 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 09:37:19,510 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 09:37:19,510 - app.main - INFO - Application startup complete.
2025-07-06 09:37:19,511 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 09:37:19,511 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 13:37:19.511203+00:00.
2025-07-06 09:37:19,511 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 09:37:19,511 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T12:00:00+00:00 to 2025-07-06T13:00:00+00:00 UTC.
2025-07-06 09:37:19,521 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-06T12:00:00+00:00 to 2025-07-06T13:00:00+00:00 completed. Processed 6 symbols.
2025-07-06 09:37:19,521 - app.services.aggregation_service - INFO - Next aggregation check in 1360.48 seconds.
2025-07-06 09:37:19,521 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 09:37:19,522 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 09:37:19,551 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 09:37:19,714 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108582
2025-07-06 09:37:19,717 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108582.0 at 2025-07-06 13:35:00+00:00 (granularity: 5min)
2025-07-06 09:37:25,551 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 09:37:25,690 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2540.33
2025-07-06 09:37:25,693 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2540.33 at 2025-07-06 13:35:00+00:00 (granularity: 5min)
2025-07-06 09:37:31,552 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 09:37:31,697 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 09:37:31,699 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.28 at 2025-07-06 13:35:00+00:00 (granularity: 5min)
2025-07-06 09:37:37,553 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 09:37:37,679 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 150.22
2025-07-06 09:37:37,682 - app.services.ingestion_service - INFO - Ingested SOLANA price 150.22 at 2025-07-06 13:35:00+00:00 (granularity: 5min)
2025-07-06 09:37:43,554 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 09:37:43,690 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583215
2025-07-06 09:37:43,696 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.583215 at 2025-07-06 13:35:00+00:00 (granularity: 5min)
2025-07-06 09:37:49,555 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 09:37:49,678 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.169214
2025-07-06 09:37:49,680 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.169214 at 2025-07-06 13:35:00+00:00 (granularity: 5min)
2025-07-06 09:37:49,680 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 130.32 seconds.
2025-07-06 09:39:07,990 - app.main - WARNING - HTTP Exception (Client Error) at POST /api/v1/backfill: No symbols provided and no default symbol list configured.
2025-07-06 09:39:51,977 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 09:39:51,978 - app.main - INFO - Application shutdown complete.
2025-07-06 09:39:52,476 - root - INFO - Logging configured at level: INFO
2025-07-06 09:39:52,477 - root - INFO - Logs will also be written to: app.log
2025-07-06 09:39:52,481 - app.main - INFO - Application startup initiated.
2025-07-06 09:39:52,482 - app.main - INFO - Database tables ensured to exist.
2025-07-06 09:39:52,482 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 09:39:52,482 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 09:39:52,482 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 09:39:52,482 - app.main - INFO - Application startup complete.
2025-07-06 09:39:52,482 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 09:39:52,482 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 13:39:52.482874+00:00.
2025-07-06 09:39:52,482 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 09:39:52,482 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T12:00:00+00:00 to 2025-07-06T13:00:00+00:00 UTC.
2025-07-06 09:39:52,488 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 09:39:52,495 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:52,495 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:52,496 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:52,496 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:52,496 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:52,497 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:52,497 - app.services.aggregation_service - INFO - Next aggregation check in 1207.50 seconds.
2025-07-06 09:39:52,497 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 09:39:52,498 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 09:39:52,523 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 09:39:52,730 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108603
2025-07-06 09:39:52,733 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:35:00.000000', 108603.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 09:39:53,408 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 09:39:53,408 - app.main - INFO - Application shutdown complete.
2025-07-06 09:39:53,741 - root - INFO - Logging configured at level: INFO
2025-07-06 09:39:53,741 - root - INFO - Logs will also be written to: app.log
2025-07-06 09:39:53,745 - app.main - INFO - Application startup initiated.
2025-07-06 09:39:53,746 - app.main - INFO - Database tables ensured to exist.
2025-07-06 09:39:53,746 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 09:39:53,746 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 09:39:53,746 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 09:39:53,746 - app.main - INFO - Application startup complete.
2025-07-06 09:39:53,746 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'litecoin', 'cardano'] every 5 minutes...
2025-07-06 09:39:53,746 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'litecoin', 'cardano'] at 2025-07-06 13:39:53.746443+00:00.
2025-07-06 09:39:53,746 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 09:39:53,746 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T12:00:00+00:00 to 2025-07-06T13:00:00+00:00 UTC.
2025-07-06 09:39:53,750 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 09:39:53,753 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:53,754 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:53,754 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:53,754 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:53,754 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:53,755 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 12:00:00.000000', 108166.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 09:39:53,755 - app.services.aggregation_service - INFO - Next aggregation check in 1206.24 seconds.
2025-07-06 09:39:53,755 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 09:39:53,756 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 09:39:53,771 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 09:39:53,858 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108603
2025-07-06 09:39:53,858 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:35:00.000000', 108603.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 09:39:59,772 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 09:39:59,906 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2542.04
2025-07-06 09:39:59,907 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 13:35:00.000000', 2542.04, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 09:40:05,773 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 09:40:05,941 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 09:40:05,945 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.28 at 2025-07-06 13:40:00+00:00 (granularity: 5min)
2025-07-06 09:40:11,774 - app.services.ingestion_service - INFO - Attempting to fetch price for litecoin from CoinGecko.
2025-07-06 09:40:11,952 - app.services.ingestion_service - INFO - Successfully fetched price for litecoin: 87.92
2025-07-06 09:40:11,956 - app.services.ingestion_service - INFO - Ingested LITECOIN price 87.92 at 2025-07-06 13:40:00+00:00 (granularity: 5min)
2025-07-06 09:40:17,774 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 09:40:17,894 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583789
2025-07-06 09:40:17,900 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.583789 at 2025-07-06 13:40:00+00:00 (granularity: 5min)
2025-07-06 09:40:17,900 - app.services.ingestion_service - WARNING - Ingestion cycle took longer than interval. Adjusting next run time.
2025-07-06 09:40:17,900 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'litecoin', 'cardano'] scheduled in 282.10 seconds.
2025-07-06 09:43:17,204 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 09:43:17,205 - app.main - INFO - Application shutdown complete.
2025-07-06 09:50:53,106 - root - INFO - Logging configured at level: INFO
2025-07-06 09:50:53,107 - root - INFO - Logs will also be written to: app.log
2025-07-06 09:50:53,111 - app.main - INFO - Application startup initiated.
2025-07-06 09:50:53,115 - app.main - INFO - Database tables ensured to exist.
2025-07-06 09:50:53,115 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 09:50:53,115 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 09:50:53,115 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 09:50:53,115 - app.main - INFO - Application startup complete.
2025-07-06 09:50:53,115 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 09:50:53,115 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 13:50:53.115305+00:00.
2025-07-06 09:50:53,115 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 09:50:53,115 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T12:00:00+00:00 to 2025-07-06T13:00:00+00:00 UTC.
2025-07-06 09:50:53,118 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 12:00:00+00:00 to 2025-07-06 13:00:00+00:00.
2025-07-06 09:50:53,118 - app.services.aggregation_service - INFO - Next aggregation check in 546.88 seconds.
2025-07-06 09:50:53,118 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 09:50:53,119 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 09:50:53,147 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 09:50:53,324 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108740
2025-07-06 09:50:53,331 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108740.0 at 2025-07-06 13:50:00+00:00 (granularity: 5min)
2025-07-06 09:50:59,148 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 09:50:59,288 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2544.01
2025-07-06 09:50:59,293 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2544.01 at 2025-07-06 13:50:00+00:00 (granularity: 5min)
2025-07-06 09:51:05,150 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 09:51:05,308 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 09:51:05,314 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.28 at 2025-07-06 13:50:00+00:00 (granularity: 5min)
2025-07-06 09:51:11,151 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 09:51:11,288 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.4
2025-07-06 09:51:11,291 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.4 at 2025-07-06 13:50:00+00:00 (granularity: 5min)
2025-07-06 09:51:17,152 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 09:51:17,275 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.585537
2025-07-06 09:51:17,282 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.585537 at 2025-07-06 13:50:00+00:00 (granularity: 5min)
2025-07-06 09:51:23,152 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 09:51:23,277 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.171186
2025-07-06 09:51:23,279 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.171186 at 2025-07-06 13:50:00+00:00 (granularity: 5min)
2025-07-06 09:51:23,280 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 216.72 seconds.
2025-07-06 09:51:47,230 - app.main - WARNING - HTTP Exception (Client Error) at POST /api/v1/backfill: No symbols provided and no default symbol list configured.
2025-07-06 09:52:27,503 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 09:52:27,505 - app.main - INFO - Application shutdown complete.
2025-07-06 09:52:27,996 - root - INFO - Logging configured at level: INFO
2025-07-06 09:52:27,997 - root - INFO - Logs will also be written to: app.log
2025-07-06 09:52:28,001 - app.main - INFO - Application startup initiated.
2025-07-06 09:52:28,001 - app.main - INFO - Database tables ensured to exist.
2025-07-06 09:52:28,002 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 09:52:28,002 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 09:52:28,002 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 09:52:28,002 - app.main - INFO - Application startup complete.
2025-07-06 09:52:28,002 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 09:52:28,002 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 13:52:28.002324+00:00.
2025-07-06 09:52:28,002 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 09:52:28,002 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T12:00:00+00:00 to 2025-07-06T13:00:00+00:00 UTC.
2025-07-06 09:52:28,005 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 12:00:00+00:00 to 2025-07-06 13:00:00+00:00.
2025-07-06 09:52:28,005 - app.services.aggregation_service - INFO - Next aggregation check in 451.99 seconds.
2025-07-06 09:52:28,006 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 09:52:28,006 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 09:52:28,030 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 09:52:28,223 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108796
2025-07-06 09:52:28,224 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:50:00.000000', 108796.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 09:52:34,030 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 09:52:34,156 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2546.35
2025-07-06 09:52:34,159 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 13:50:00.000000', 2546.35, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 09:52:37,505 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 09:52:37,506 - app.main - INFO - Application shutdown complete.
2025-07-06 10:14:11,370 - root - INFO - Logging configured at level: INFO
2025-07-06 10:14:11,370 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:14:11,374 - app.main - INFO - Application startup initiated.
2025-07-06 10:14:11,375 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:14:11,375 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:14:11,375 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:14:11,375 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:14:11,375 - app.main - INFO - Application startup complete.
2025-07-06 10:14:11,376 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:14:11,376 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:14:11.376074+00:00.
2025-07-06 10:14:11,376 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:14:11,376 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:14:11,387 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 completed. Processed 6 symbols.
2025-07-06 10:14:11,387 - app.services.aggregation_service - INFO - Next aggregation check in 2748.61 seconds.
2025-07-06 10:14:11,387 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:14:11,388 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:14:11,419 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:14:11,589 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108810
2025-07-06 10:14:11,590 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108810.0 at 2025-07-06 14:10:00+00:00 (granularity: 5min)
2025-07-06 10:14:17,418 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:14:17,571 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2559.13
2025-07-06 10:14:17,573 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2559.13 at 2025-07-06 14:10:00+00:00 (granularity: 5min)
2025-07-06 10:14:23,417 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:14:23,550 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:14:23,557 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.28 at 2025-07-06 14:10:00+00:00 (granularity: 5min)
2025-07-06 10:14:29,417 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:14:29,565 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.51
2025-07-06 10:14:29,568 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.51 at 2025-07-06 14:10:00+00:00 (granularity: 5min)
2025-07-06 10:14:35,417 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:14:35,555 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.585108
2025-07-06 10:14:35,561 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.585108 at 2025-07-06 14:10:00+00:00 (granularity: 5min)
2025-07-06 10:14:41,418 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:14:41,546 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.172965
2025-07-06 10:14:41,549 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.172965 at 2025-07-06 14:10:00+00:00 (granularity: 5min)
2025-07-06 10:14:41,549 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 18.45 seconds.
2025-07-06 10:15:00,000 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:15:00.000876+00:00.
2025-07-06 10:15:00,013 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:15:00,104 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108810
2025-07-06 10:15:00,106 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108810.0 at 2025-07-06 14:15:00+00:00 (granularity: 5min)
2025-07-06 10:15:05,129 - app.main - WARNING - HTTP Exception (Client Error) at POST /api/v1/backfill: No symbols provided and no default symbol list configured.
2025-07-06 10:15:06,014 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:15:06,081 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2559.13
2025-07-06 10:15:06,083 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2559.13 at 2025-07-06 14:15:00+00:00 (granularity: 5min)
2025-07-06 10:15:12,016 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:15:12,087 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:15:12,089 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.28 at 2025-07-06 14:15:00+00:00 (granularity: 5min)
2025-07-06 10:15:13,284 - app.main - WARNING - HTTP Exception (Client Error) at POST /api/v1/backfill: No symbols provided and no default symbol list configured.
2025-07-06 10:15:18,017 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:15:18,109 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.51
2025-07-06 10:15:18,115 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.51 at 2025-07-06 14:15:00+00:00 (granularity: 5min)
2025-07-06 10:15:24,017 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:15:24,080 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.585108
2025-07-06 10:15:24,081 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.585108 at 2025-07-06 14:15:00+00:00 (granularity: 5min)
2025-07-06 10:15:30,018 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:15:30,093 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.172965
2025-07-06 10:15:30,099 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.172965 at 2025-07-06 14:15:00+00:00 (granularity: 5min)
2025-07-06 10:15:30,100 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.90 seconds.
2025-07-06 10:19:02,821 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:19:02,823 - app.main - INFO - Application shutdown complete.
2025-07-06 10:19:03,348 - root - INFO - Logging configured at level: INFO
2025-07-06 10:19:03,349 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:19:03,354 - app.main - INFO - Application startup initiated.
2025-07-06 10:19:03,356 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:19:03,356 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:19:03,356 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:19:03,356 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:19:03,356 - app.main - INFO - Application startup complete.
2025-07-06 10:19:03,356 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:19:03,356 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:19:03.356944+00:00.
2025-07-06 10:19:03,357 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:19:03,357 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:19:03,362 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:03,376 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:03,378 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:03,380 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:03,382 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:03,383 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:03,385 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:03,386 - app.services.aggregation_service - INFO - Next aggregation check in 2456.61 seconds.
2025-07-06 10:19:03,386 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:19:03,388 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:19:03,425 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:19:03,629 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108827
2025-07-06 10:19:03,631 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:15:00.000000', 108827.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:04,197 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:19:04,197 - app.main - INFO - Application shutdown complete.
2025-07-06 10:19:04,528 - root - INFO - Logging configured at level: INFO
2025-07-06 10:19:04,528 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:19:04,532 - app.main - INFO - Application startup initiated.
2025-07-06 10:19:04,533 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:19:04,533 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:19:04,533 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:19:04,533 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:19:04,533 - app.main - INFO - Application startup complete.
2025-07-06 10:19:04,533 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:19:04,533 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:19:04.533703+00:00.
2025-07-06 10:19:04,533 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:19:04,533 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:19:04,537 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:04,540 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:04,540 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:04,541 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:04,541 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:04,541 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:04,541 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:04,542 - app.services.aggregation_service - INFO - Next aggregation check in 2455.46 seconds.
2025-07-06 10:19:04,542 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:19:04,543 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:19:04,558 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:19:04,663 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108827
2025-07-06 10:19:04,666 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:15:00.000000', 108827.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:10,559 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:19:10,690 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.49
2025-07-06 10:19:10,691 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:15:00.000000', 2558.49, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:12,523 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:19:12,523 - app.main - INFO - Application shutdown complete.
2025-07-06 10:19:12,865 - root - INFO - Logging configured at level: INFO
2025-07-06 10:19:12,865 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:19:12,869 - app.main - INFO - Application startup initiated.
2025-07-06 10:19:12,870 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:19:12,870 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:19:12,870 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:19:12,870 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:19:12,870 - app.main - INFO - Application startup complete.
2025-07-06 10:19:12,870 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:19:12,870 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:19:12.870457+00:00.
2025-07-06 10:19:12,870 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:19:12,870 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:19:12,874 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:12,877 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:12,877 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:12,877 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:12,878 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:12,878 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:12,878 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:12,878 - app.services.aggregation_service - INFO - Next aggregation check in 2447.12 seconds.
2025-07-06 10:19:12,878 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:19:12,879 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:19:12,897 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:19:12,977 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108827
2025-07-06 10:19:12,980 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:15:00.000000', 108827.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:15,408 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:19:15,409 - app.main - INFO - Application shutdown complete.
2025-07-06 10:19:15,772 - root - INFO - Logging configured at level: INFO
2025-07-06 10:19:15,772 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:19:15,777 - app.main - INFO - Application startup initiated.
2025-07-06 10:19:15,777 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:19:15,778 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:19:15,778 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:19:15,778 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:19:15,778 - app.main - INFO - Application startup complete.
2025-07-06 10:19:15,778 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:19:15,778 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:19:15.778352+00:00.
2025-07-06 10:19:15,778 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:19:15,778 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:19:15,782 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:15,784 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:15,785 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:15,785 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:15,785 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:15,785 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:15,786 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:15,786 - app.services.aggregation_service - INFO - Next aggregation check in 2444.21 seconds.
2025-07-06 10:19:15,786 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:19:15,787 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:19:15,801 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:19:15,903 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108827
2025-07-06 10:19:15,906 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:15:00.000000', 108827.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:21,803 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:19:21,904 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.49
2025-07-06 10:19:21,908 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:15:00.000000', 2558.49, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:27,804 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:19:27,957 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:19:27,958 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 14:15:00.000000', 2.28, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:33,804 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:19:33,933 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.57
2025-07-06 10:19:33,934 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 14:15:00.000000', 151.57, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:39,425 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:19:39,425 - app.main - INFO - Application shutdown complete.
2025-07-06 10:19:39,869 - root - INFO - Logging configured at level: INFO
2025-07-06 10:19:39,869 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:19:39,873 - app.main - INFO - Application startup initiated.
2025-07-06 10:19:39,873 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:19:39,873 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:19:39,873 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:19:39,873 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:19:39,873 - app.main - INFO - Application startup complete.
2025-07-06 10:19:39,874 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:19:39,874 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:19:39.874035+00:00.
2025-07-06 10:19:39,874 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:19:39,874 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:19:39,881 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:39,888 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:39,888 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:39,888 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:39,888 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:39,889 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:39,889 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:39,889 - app.services.aggregation_service - INFO - Next aggregation check in 2420.11 seconds.
2025-07-06 10:19:39,889 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:19:39,890 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:19:39,915 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:19:40,008 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108827
2025-07-06 10:19:40,011 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:15:00.000000', 108827.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:45,915 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:19:45,994 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.49
2025-07-06 10:19:45,997 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:15:00.000000', 2558.49, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:51,915 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:19:51,987 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:19:51,990 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 14:15:00.000000', 2.28, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:57,916 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:19:57,986 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.57
2025-07-06 10:19:57,989 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 14:15:00.000000', 151.57, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:58,379 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:19:58,380 - app.main - INFO - Application shutdown complete.
2025-07-06 10:19:58,828 - root - INFO - Logging configured at level: INFO
2025-07-06 10:19:58,828 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:19:58,832 - app.main - INFO - Application startup initiated.
2025-07-06 10:19:58,833 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:19:58,833 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:19:58,833 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:19:58,833 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:19:58,833 - app.main - INFO - Application startup complete.
2025-07-06 10:19:58,833 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:19:58,833 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:19:58.833873+00:00.
2025-07-06 10:19:58,833 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:19:58,833 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:19:58,838 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:19:58,844 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:58,845 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:58,845 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:58,845 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:58,845 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:58,845 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:19:58,846 - app.services.aggregation_service - INFO - Next aggregation check in 2401.15 seconds.
2025-07-06 10:19:58,846 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:19:58,846 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:19:58,869 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:19:58,947 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108827
2025-07-06 10:19:58,950 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:15:00.000000', 108827.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:01,271 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:20:01,271 - app.main - INFO - Application shutdown complete.
2025-07-06 10:20:01,670 - root - INFO - Logging configured at level: INFO
2025-07-06 10:20:01,670 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:20:01,674 - app.main - INFO - Application startup initiated.
2025-07-06 10:20:01,675 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:20:01,675 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:20:01,675 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:20:01,675 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:20:01,675 - app.main - INFO - Application startup complete.
2025-07-06 10:20:01,675 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:20:01,675 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:20:01.675668+00:00.
2025-07-06 10:20:01,675 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:20:01,675 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:20:01,679 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:01,682 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:01,682 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:01,682 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:01,683 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:01,683 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:01,683 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:01,683 - app.services.aggregation_service - INFO - Next aggregation check in 2398.32 seconds.
2025-07-06 10:20:01,683 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:20:01,684 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:20:01,700 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:20:01,795 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108827
2025-07-06 10:20:01,799 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108827.0 at 2025-07-06 14:20:00+00:00 (granularity: 5min)
2025-07-06 10:20:07,701 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:20:07,760 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.49
2025-07-06 10:20:07,763 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2558.49 at 2025-07-06 14:20:00+00:00 (granularity: 5min)
2025-07-06 10:20:12,296 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:20:12,296 - app.main - INFO - Application shutdown complete.
2025-07-06 10:20:18,126 - root - INFO - Logging configured at level: INFO
2025-07-06 10:20:18,126 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:20:18,130 - app.main - INFO - Application startup initiated.
2025-07-06 10:20:18,131 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:20:18,131 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:20:18,131 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:20:18,131 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:20:18,131 - app.main - INFO - Application startup complete.
2025-07-06 10:20:18,131 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:20:18,131 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:20:18.131654+00:00.
2025-07-06 10:20:18,131 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:20:18,131 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:20:18,135 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:18,142 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:18,142 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:18,142 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:18,142 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:18,143 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:18,143 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:18,143 - app.services.aggregation_service - INFO - Next aggregation check in 2381.86 seconds.
2025-07-06 10:20:18,143 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:20:18,144 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:20:18,170 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:20:18,319 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108847
2025-07-06 10:20:18,322 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:20:00.000000', 108847.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:24,170 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:20:24,299 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.8
2025-07-06 10:20:24,300 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:20:00.000000', 2558.8, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:30,172 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:20:30,304 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 10:20:30,313 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 14:20:00+00:00 (granularity: 5min)
2025-07-06 10:20:31,193 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:20:31,194 - app.main - INFO - Application shutdown complete.
2025-07-06 10:20:35,603 - root - INFO - Logging configured at level: INFO
2025-07-06 10:20:35,604 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:20:35,607 - app.main - INFO - Application startup initiated.
2025-07-06 10:20:35,608 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:20:35,608 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:20:35,608 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:20:35,608 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:20:35,608 - app.main - INFO - Application startup complete.
2025-07-06 10:20:35,608 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:20:35,608 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:20:35.608930+00:00.
2025-07-06 10:20:35,608 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:20:35,609 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:20:35,613 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:35,619 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:35,620 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:35,620 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:35,620 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:35,620 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:35,620 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:20:35,621 - app.services.aggregation_service - INFO - Next aggregation check in 2364.38 seconds.
2025-07-06 10:20:35,621 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:20:35,621 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:20:35,644 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:20:35,730 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108847
2025-07-06 10:20:35,732 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:20:00.000000', 108847.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:41,644 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:20:41,703 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.8
2025-07-06 10:20:41,704 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:20:00.000000', 2558.8, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:47,644 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:20:47,717 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 10:20:47,720 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 14:20:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:20:53,645 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:20:53,786 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.58
2025-07-06 10:20:53,800 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.58 at 2025-07-06 14:20:00+00:00 (granularity: 5min)
2025-07-06 10:20:59,646 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:20:59,776 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.585166
2025-07-06 10:20:59,779 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.585166 at 2025-07-06 14:20:00+00:00 (granularity: 5min)
2025-07-06 10:21:05,647 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:21:05,779 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.172565
2025-07-06 10:21:05,786 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.172565 at 2025-07-06 14:20:00+00:00 (granularity: 5min)
2025-07-06 10:21:05,787 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 234.21 seconds.
2025-07-06 10:21:08,023 - app.services.backfill_service - INFO - Starting automatic historical data backfill job...
2025-07-06 10:21:08,024 - app.services.backfill_service - INFO - Found tokens to backfill: ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin']
2025-07-06 10:21:08,024 - app.services.backfill_service - INFO - Starting backfill for token: bitcoin
2025-07-06 10:21:08,024 - app.services.backfill_service - INFO - Backfilling historical data for bitcoin from CoinGecko...
2025-07-06 10:21:08,166 - app.services.backfill_service - INFO - Fetched 181 price points for bitcoin from CoinGecko.
2025-07-06 10:21:08,168 - app.services.backfill_service - ERROR - Bulk insert error for bitcoin: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 10:21:08,169 - app.services.backfill_service - INFO - Successfully completed backfill for token: bitcoin
2025-07-06 10:21:18,169 - app.services.backfill_service - INFO - Starting backfill for token: ethereum
2025-07-06 10:21:18,170 - app.services.backfill_service - INFO - Backfilling historical data for ethereum from CoinGecko...
2025-07-06 10:21:18,332 - app.services.backfill_service - INFO - Fetched 181 price points for ethereum from CoinGecko.
2025-07-06 10:21:18,335 - app.services.backfill_service - ERROR - Bulk insert error for ethereum: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 10:21:18,336 - app.services.backfill_service - INFO - Successfully completed backfill for token: ethereum
2025-07-06 10:21:28,337 - app.services.backfill_service - INFO - Starting backfill for token: ripple
2025-07-06 10:21:28,339 - app.services.backfill_service - INFO - Backfilling historical data for ripple from CoinGecko...
2025-07-06 10:21:28,483 - app.services.backfill_service - INFO - Fetched 181 price points for ripple from CoinGecko.
2025-07-06 10:21:28,487 - app.services.backfill_service - ERROR - Bulk insert error for ripple: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 10:21:28,488 - app.services.backfill_service - INFO - Successfully completed backfill for token: ripple
2025-07-06 10:21:38,490 - app.services.backfill_service - INFO - Starting backfill for token: solana
2025-07-06 10:21:38,491 - app.services.backfill_service - INFO - Backfilling historical data for solana from CoinGecko...
2025-07-06 10:21:38,648 - app.services.backfill_service - INFO - Fetched 181 price points for solana from CoinGecko.
2025-07-06 10:21:38,651 - app.services.backfill_service - ERROR - Bulk insert error for solana: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 10:21:38,652 - app.services.backfill_service - INFO - Successfully completed backfill for token: solana
2025-07-06 10:21:48,653 - app.services.backfill_service - INFO - Starting backfill for token: cardano
2025-07-06 10:21:48,653 - app.services.backfill_service - INFO - Backfilling historical data for cardano from CoinGecko...
2025-07-06 10:21:48,839 - app.services.backfill_service - INFO - Fetched 181 price points for cardano from CoinGecko.
2025-07-06 10:21:48,842 - app.services.backfill_service - ERROR - Bulk insert error for cardano: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 10:21:48,843 - app.services.backfill_service - INFO - Successfully completed backfill for token: cardano
2025-07-06 10:21:58,844 - app.services.backfill_service - INFO - Starting backfill for token: dogecoin
2025-07-06 10:21:58,845 - app.services.backfill_service - INFO - Backfilling historical data for dogecoin from CoinGecko...
2025-07-06 10:21:58,914 - app.services.backfill_service - ERROR - Failed to fetch data from CoinGecko for dogecoin: Client error '429 Too Many Requests' for url 'https://api.coingecko.com/api/v3/coins/dogecoin/market_chart?vs_currency=usd&days=180&interval=daily'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429
2025-07-06 10:21:58,914 - app.services.backfill_service - INFO - Successfully completed backfill for token: dogecoin
2025-07-06 10:22:08,916 - app.services.backfill_service - INFO - Automatic historical data backfill job finished.
2025-07-06 10:24:59,998 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:24:59.997880+00:00.
2025-07-06 10:25:00,018 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:25:00,176 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108859
2025-07-06 10:25:00,183 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108859.0 at 2025-07-06 14:25:00+00:00 (granularity: 5min)
2025-07-06 10:25:06,018 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:25:06,142 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2557.75
2025-07-06 10:25:06,156 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2557.75 at 2025-07-06 14:25:00+00:00 (granularity: 5min)
2025-07-06 10:25:12,020 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:25:12,194 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 10:25:12,201 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 14:25:00+00:00 (granularity: 5min)
2025-07-06 10:25:18,020 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:25:18,152 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.36
2025-07-06 10:25:18,158 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.36 at 2025-07-06 14:25:00+00:00 (granularity: 5min)
2025-07-06 10:25:24,021 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:25:24,160 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584462
2025-07-06 10:25:24,166 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584462 at 2025-07-06 14:25:00+00:00 (granularity: 5min)
2025-07-06 10:25:30,022 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:25:30,144 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.171877
2025-07-06 10:25:30,150 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.171877 at 2025-07-06 14:25:00+00:00 (granularity: 5min)
2025-07-06 10:25:30,150 - app.services.ingestion_service - WARNING - Ingestion cycle took longer than interval. Adjusting next run time.
2025-07-06 10:25:30,151 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.85 seconds.
2025-07-06 10:28:20,244 - app.api.security - WARNING - Token decoding failed. Invalid credentials.
2025-07-06 10:28:20,245 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: Could not validate credentials
2025-07-06 10:29:01,214 - app.api.security - WARNING - Token decoding failed. Invalid credentials.
2025-07-06 10:29:01,215 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: Could not validate credentials
2025-07-06 10:29:59,999 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:29:59.998971+00:00.
2025-07-06 10:30:00,022 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:30:00,231 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108874
2025-07-06 10:30:00,236 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108874.0 at 2025-07-06 14:30:00+00:00 (granularity: 5min)
2025-07-06 10:30:06,022 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:30:06,150 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2557.57
2025-07-06 10:30:06,153 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2557.57 at 2025-07-06 14:30:00+00:00 (granularity: 5min)
2025-07-06 10:30:12,024 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:30:12,149 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 10:30:12,152 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 14:30:00+00:00 (granularity: 5min)
2025-07-06 10:30:18,025 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:30:18,172 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.43
2025-07-06 10:30:18,177 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.43 at 2025-07-06 14:30:00+00:00 (granularity: 5min)
2025-07-06 10:30:24,027 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:30:24,198 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584135
2025-07-06 10:30:24,202 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584135 at 2025-07-06 14:30:00+00:00 (granularity: 5min)
2025-07-06 10:30:30,028 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:30:30,156 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.171674
2025-07-06 10:30:30,161 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.171674 at 2025-07-06 14:30:00+00:00 (granularity: 5min)
2025-07-06 10:30:30,161 - app.services.ingestion_service - WARNING - Ingestion cycle took longer than interval. Adjusting next run time.
2025-07-06 10:30:30,162 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.84 seconds.
2025-07-06 10:31:35,641 - app.api.security - WARNING - Token decoding failed. Invalid credentials.
2025-07-06 10:31:35,642 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: Could not validate credentials
2025-07-06 10:33:24,428 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: Not authenticated
2025-07-06 10:34:59,998 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:34:59.997683+00:00.
2025-07-06 10:35:00,027 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:35:00,197 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108947
2025-07-06 10:35:00,205 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108947.0 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:35:06,029 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:35:06,170 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2560.28
2025-07-06 10:35:06,176 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2560.28 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:35:12,030 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:35:12,156 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 10:35:12,158 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:35:18,030 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:35:18,167 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.6
2025-07-06 10:35:18,173 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.6 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:35:24,032 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:35:24,169 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584695
2025-07-06 10:35:24,175 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584695 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:35:30,033 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:35:30,177 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.171252
2025-07-06 10:35:30,185 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.171252 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:35:30,185 - app.services.ingestion_service - WARNING - Ingestion cycle took longer than interval. Adjusting next run time.
2025-07-06 10:35:30,185 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.81 seconds.
2025-07-06 10:35:44,097 - app.api.security - WARNING - Token decoding failed. Invalid credentials.
2025-07-06 10:35:44,097 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: Could not validate credentials
2025-07-06 10:37:25,601 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:37:25,601 - app.main - INFO - Application shutdown complete.
2025-07-06 10:37:26,093 - root - INFO - Logging configured at level: INFO
2025-07-06 10:37:26,093 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:37:26,097 - app.main - INFO - Application startup initiated.
2025-07-06 10:37:26,098 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:37:26,098 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:37:26,098 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:37:26,098 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:37:26,098 - app.main - INFO - Application startup complete.
2025-07-06 10:37:26,098 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:37:26,098 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:37:26.098473+00:00.
2025-07-06 10:37:26,098 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:37:26,098 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:37:26,103 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:26,110 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:26,110 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:26,110 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:26,110 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:26,111 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:26,111 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:26,111 - app.services.aggregation_service - INFO - Next aggregation check in 1353.89 seconds.
2025-07-06 10:37:26,111 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:37:26,112 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:37:26,135 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:37:26,309 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108943
2025-07-06 10:37:26,313 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:35:00.000000', 108943.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:32,136 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:37:32,271 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2560.66
2025-07-06 10:37:32,272 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:35:00.000000', 2560.66, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:38,138 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:37:38,271 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:37:38,274 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 14:35:00.000000', 2.28, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:44,138 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:37:44,290 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.68
2025-07-06 10:37:44,293 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 14:35:00.000000', 151.68, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:50,139 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:37:50,286 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584758
2025-07-06 10:37:50,289 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 14:35:00.000000', 0.584758, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:52,178 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:37:52,178 - app.main - INFO - Application shutdown complete.
2025-07-06 10:37:52,637 - root - INFO - Logging configured at level: INFO
2025-07-06 10:37:52,637 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:37:52,641 - app.main - INFO - Application startup initiated.
2025-07-06 10:37:52,642 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:37:52,642 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:37:52,642 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:37:52,642 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:37:52,642 - app.main - INFO - Application startup complete.
2025-07-06 10:37:52,642 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:37:52,642 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:37:52.642459+00:00.
2025-07-06 10:37:52,642 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:37:52,642 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:37:52,646 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:52,652 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:52,653 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:52,653 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:52,653 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:52,653 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:52,654 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:52,654 - app.services.aggregation_service - INFO - Next aggregation check in 1327.35 seconds.
2025-07-06 10:37:52,654 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:37:52,655 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:37:52,719 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:37:52,809 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108943
2025-07-06 10:37:52,809 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:35:00.000000', 108943.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:58,313 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:37:58,313 - app.main - INFO - Application shutdown complete.
2025-07-06 10:37:58,797 - root - INFO - Logging configured at level: INFO
2025-07-06 10:37:58,797 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:37:58,802 - app.main - INFO - Application startup initiated.
2025-07-06 10:37:58,803 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:37:58,803 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:37:58,803 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:37:58,803 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:37:58,803 - app.main - INFO - Application startup complete.
2025-07-06 10:37:58,803 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:37:58,804 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:37:58.804008+00:00.
2025-07-06 10:37:58,804 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:37:58,804 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:37:58,809 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:37:58,814 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:58,814 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:58,815 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:58,815 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:58,816 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:58,816 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:37:58,816 - app.services.aggregation_service - INFO - Next aggregation check in 1321.18 seconds.
2025-07-06 10:37:58,816 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:37:58,818 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:37:58,845 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:37:58,938 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108943
2025-07-06 10:37:58,939 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:35:00.000000', 108943.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:38:02,765 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:38:02,765 - app.main - INFO - Application shutdown complete.
2025-07-06 10:38:03,101 - root - INFO - Logging configured at level: INFO
2025-07-06 10:38:03,102 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:38:03,106 - app.main - INFO - Application startup initiated.
2025-07-06 10:38:03,106 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:38:03,106 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:38:03,106 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:38:03,107 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:38:03,107 - app.main - INFO - Application startup complete.
2025-07-06 10:38:03,107 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:38:03,107 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:38:03.107225+00:00.
2025-07-06 10:38:03,107 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:38:03,107 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:38:03,111 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:38:03,113 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:03,113 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:03,114 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:03,114 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:03,114 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:03,114 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:03,114 - app.services.aggregation_service - INFO - Next aggregation check in 1316.89 seconds.
2025-07-06 10:38:03,115 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:38:03,115 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:38:03,130 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:38:03,229 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108943
2025-07-06 10:38:03,230 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:35:00.000000', 108943.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:38:09,131 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:38:09,198 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2560.66
2025-07-06 10:38:09,200 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:35:00.000000', 2560.66, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:38:13,022 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:38:13,023 - app.main - INFO - Application shutdown complete.
2025-07-06 10:38:13,555 - root - INFO - Logging configured at level: INFO
2025-07-06 10:38:13,555 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:38:13,559 - app.main - INFO - Application startup initiated.
2025-07-06 10:38:13,560 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:38:13,560 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:38:13,560 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:38:13,560 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:38:13,560 - app.main - INFO - Application startup complete.
2025-07-06 10:38:13,560 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:38:13,560 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:38:13.560662+00:00.
2025-07-06 10:38:13,560 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:38:13,560 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:38:13,564 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:38:13,570 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:13,571 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:13,571 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:13,571 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:13,571 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:13,572 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 13:00:00.000000', 108740.0, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 10:38:13,572 - app.services.aggregation_service - INFO - Next aggregation check in 1306.43 seconds.
2025-07-06 10:38:13,572 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:38:13,573 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:38:13,596 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:38:13,674 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108943
2025-07-06 10:38:13,675 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:35:00.000000', 108943.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:38:19,597 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:38:19,667 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2560.66
2025-07-06 10:38:19,669 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:35:00.000000', 2560.66, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:38:25,598 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:38:25,670 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:38:25,672 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 14:35:00.000000', 2.28, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:38:28,328 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:38:28,329 - app.main - INFO - Application shutdown complete.
2025-07-06 10:38:48,727 - root - INFO - Logging configured at level: INFO
2025-07-06 10:38:48,727 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:38:48,731 - app.main - INFO - Application startup initiated.
2025-07-06 10:38:48,735 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:38:48,735 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:38:48,735 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:38:48,735 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:38:48,735 - app.main - INFO - Application startup complete.
2025-07-06 10:38:48,735 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:38:48,735 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:38:48.735801+00:00.
2025-07-06 10:38:48,735 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:38:48,735 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:38:48,739 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:38:48,739 - app.services.aggregation_service - INFO - Next aggregation check in 1271.26 seconds.
2025-07-06 10:38:48,739 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:38:48,739 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:38:48,766 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:38:48,928 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108937
2025-07-06 10:38:48,933 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108937.0 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:38:54,767 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:38:54,925 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2561.09
2025-07-06 10:38:54,927 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2561.09 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:39:00,766 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:39:00,895 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:39:00,900 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.28 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:39:06,768 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:39:06,902 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.66
2025-07-06 10:39:06,909 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.66 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:39:12,768 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:39:12,911 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584953
2025-07-06 10:39:12,929 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584953 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:39:18,769 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:39:18,896 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.171333
2025-07-06 10:39:18,902 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.171333 at 2025-07-06 14:35:00+00:00 (granularity: 5min)
2025-07-06 10:39:18,902 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 41.10 seconds.
2025-07-06 10:40:00,001 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:40:00.001470+00:00.
2025-07-06 10:40:00,007 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:40:00,163 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108930
2025-07-06 10:40:00,166 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108930.0 at 2025-07-06 14:40:00+00:00 (granularity: 5min)
2025-07-06 10:40:06,008 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:40:06,155 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2561.22
2025-07-06 10:40:06,158 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2561.22 at 2025-07-06 14:40:00+00:00 (granularity: 5min)
2025-07-06 10:40:12,010 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:40:12,144 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:40:12,149 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.28 at 2025-07-06 14:40:00+00:00 (granularity: 5min)
2025-07-06 10:40:18,011 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:40:18,143 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.57
2025-07-06 10:40:18,152 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.57 at 2025-07-06 14:40:00+00:00 (granularity: 5min)
2025-07-06 10:40:24,012 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:40:24,191 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584897
2025-07-06 10:40:24,196 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584897 at 2025-07-06 14:40:00+00:00 (granularity: 5min)
2025-07-06 10:40:30,013 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:40:30,137 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.171262
2025-07-06 10:40:30,139 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.171262 at 2025-07-06 14:40:00+00:00 (granularity: 5min)
2025-07-06 10:40:30,139 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.86 seconds.
2025-07-06 10:42:31,533 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:42:31,534 - app.main - INFO - Application shutdown complete.
2025-07-06 10:42:32,021 - root - INFO - Logging configured at level: INFO
2025-07-06 10:42:32,021 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:42:32,025 - app.main - INFO - Application startup initiated.
2025-07-06 10:42:32,025 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:42:32,025 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:42:32,025 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:42:32,025 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:42:32,025 - app.main - INFO - Application startup complete.
2025-07-06 10:42:32,025 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:42:32,025 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:42:32.025813+00:00.
2025-07-06 10:42:32,025 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:42:32,026 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:42:32,028 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:42:32,028 - app.services.aggregation_service - INFO - Next aggregation check in 1047.97 seconds.
2025-07-06 10:42:32,028 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:42:32,029 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:42:32,054 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:42:32,236 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:42:32,238 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:42:36,072 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:42:36,072 - app.main - INFO - Application shutdown complete.
2025-07-06 10:42:36,418 - root - INFO - Logging configured at level: INFO
2025-07-06 10:42:36,418 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:42:36,422 - app.main - INFO - Application startup initiated.
2025-07-06 10:42:36,422 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:42:36,422 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:42:36,422 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:42:36,422 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:42:36,423 - app.main - INFO - Application startup complete.
2025-07-06 10:42:36,423 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:42:36,423 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:42:36.423276+00:00.
2025-07-06 10:42:36,423 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:42:36,423 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:42:36,426 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:42:36,426 - app.services.aggregation_service - INFO - Next aggregation check in 1043.57 seconds.
2025-07-06 10:42:36,426 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:42:36,426 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:42:36,440 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:42:36,526 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:42:36,527 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:42:42,184 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:42:42,185 - app.main - INFO - Application shutdown complete.
2025-07-06 10:42:42,611 - root - INFO - Logging configured at level: INFO
2025-07-06 10:42:42,611 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:42:42,615 - app.main - INFO - Application startup initiated.
2025-07-06 10:42:42,615 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:42:42,615 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:42:42,616 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:42:42,616 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:42:42,616 - app.main - INFO - Application startup complete.
2025-07-06 10:42:42,616 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:42:42,616 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:42:42.616244+00:00.
2025-07-06 10:42:42,616 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:42:42,616 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:42:42,619 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:42:42,619 - app.services.aggregation_service - INFO - Next aggregation check in 1037.38 seconds.
2025-07-06 10:42:42,619 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:42:42,619 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:42:42,633 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:42:42,707 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:42:42,709 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:42:44,641 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:42:44,641 - app.main - INFO - Application shutdown complete.
2025-07-06 10:42:44,976 - root - INFO - Logging configured at level: INFO
2025-07-06 10:42:44,976 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:42:44,980 - app.main - INFO - Application startup initiated.
2025-07-06 10:42:44,981 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:42:44,981 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:42:44,981 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:42:44,981 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:42:44,981 - app.main - INFO - Application startup complete.
2025-07-06 10:42:44,981 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:42:44,981 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:42:44.981898+00:00.
2025-07-06 10:42:44,982 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:42:44,982 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:42:44,984 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:42:44,984 - app.services.aggregation_service - INFO - Next aggregation check in 1035.02 seconds.
2025-07-06 10:42:44,984 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:42:44,985 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:42:44,999 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:42:45,086 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:42:45,088 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:42:47,823 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:42:47,823 - app.main - INFO - Application shutdown complete.
2025-07-06 10:42:48,179 - root - INFO - Logging configured at level: INFO
2025-07-06 10:42:48,179 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:42:48,184 - app.main - INFO - Application startup initiated.
2025-07-06 10:42:48,184 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:42:48,184 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:42:48,184 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:42:48,184 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:42:48,184 - app.main - INFO - Application startup complete.
2025-07-06 10:42:48,185 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:42:48,185 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:42:48.185053+00:00.
2025-07-06 10:42:48,185 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:42:48,185 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:42:48,187 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:42:48,187 - app.services.aggregation_service - INFO - Next aggregation check in 1031.81 seconds.
2025-07-06 10:42:48,187 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:42:48,188 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:42:48,203 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:42:48,291 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:42:48,292 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:42:51,015 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:42:51,016 - app.main - INFO - Application shutdown complete.
2025-07-06 10:42:51,454 - root - INFO - Logging configured at level: INFO
2025-07-06 10:42:51,454 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:42:51,458 - app.main - INFO - Application startup initiated.
2025-07-06 10:42:51,458 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:42:51,458 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:42:51,458 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:42:51,459 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:42:51,459 - app.main - INFO - Application startup complete.
2025-07-06 10:42:51,459 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:42:51,459 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:42:51.459294+00:00.
2025-07-06 10:42:51,459 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:42:51,459 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:42:51,462 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:42:51,462 - app.services.aggregation_service - INFO - Next aggregation check in 1028.54 seconds.
2025-07-06 10:42:51,462 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:42:51,463 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:42:51,478 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:42:51,581 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:42:51,582 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:42:52,170 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:42:52,170 - app.main - INFO - Application shutdown complete.
2025-07-06 10:42:52,538 - root - INFO - Logging configured at level: INFO
2025-07-06 10:42:52,538 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:42:52,541 - app.main - INFO - Application startup initiated.
2025-07-06 10:42:52,542 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:42:52,542 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:42:52,542 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:42:52,542 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:42:52,542 - app.main - INFO - Application startup complete.
2025-07-06 10:42:52,542 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:42:52,542 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:42:52.542985+00:00.
2025-07-06 10:42:52,543 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:42:52,543 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:42:52,545 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:42:52,545 - app.services.aggregation_service - INFO - Next aggregation check in 1027.45 seconds.
2025-07-06 10:42:52,545 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:42:52,546 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:42:52,562 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:42:52,653 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:42:52,654 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:42:58,562 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:42:58,687 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.81
2025-07-06 10:42:58,687 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:40:00.000000', 2558.81, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:42:59,516 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:42:59,516 - app.main - INFO - Application shutdown complete.
2025-07-06 10:42:59,847 - root - INFO - Logging configured at level: INFO
2025-07-06 10:42:59,847 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:42:59,851 - app.main - INFO - Application startup initiated.
2025-07-06 10:42:59,851 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:42:59,851 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:42:59,851 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:42:59,851 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:42:59,851 - app.main - INFO - Application startup complete.
2025-07-06 10:42:59,851 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:42:59,852 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:42:59.852019+00:00.
2025-07-06 10:42:59,852 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:42:59,852 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:42:59,854 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:42:59,854 - app.services.aggregation_service - INFO - Next aggregation check in 1020.15 seconds.
2025-07-06 10:42:59,854 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:42:59,855 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:42:59,869 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:42:59,953 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:42:59,954 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:05,870 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:43:05,934 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.81
2025-07-06 10:43:05,937 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:40:00.000000', 2558.81, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:07,939 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:43:07,939 - app.main - INFO - Application shutdown complete.
2025-07-06 10:43:08,360 - root - INFO - Logging configured at level: INFO
2025-07-06 10:43:08,360 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:43:08,364 - app.main - INFO - Application startup initiated.
2025-07-06 10:43:08,365 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:43:08,365 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:43:08,365 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:43:08,365 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:43:08,365 - app.main - INFO - Application startup complete.
2025-07-06 10:43:08,365 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:43:08,365 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:43:08.365316+00:00.
2025-07-06 10:43:08,365 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:43:08,365 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:43:08,368 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:43:08,368 - app.services.aggregation_service - INFO - Next aggregation check in 1011.63 seconds.
2025-07-06 10:43:08,368 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:43:08,369 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:43:08,384 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:43:08,474 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:43:08,475 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:14,385 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:43:14,475 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.81
2025-07-06 10:43:14,477 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:40:00.000000', 2558.81, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:18,575 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 10:43:18,575 - app.main - INFO - Application shutdown complete.
2025-07-06 10:43:19,050 - root - INFO - Logging configured at level: INFO
2025-07-06 10:43:19,050 - root - INFO - Logs will also be written to: app.log
2025-07-06 10:43:19,054 - app.main - INFO - Application startup initiated.
2025-07-06 10:43:19,054 - app.main - INFO - Database tables ensured to exist.
2025-07-06 10:43:19,054 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 10:43:19,054 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 10:43:19,054 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 10:43:19,054 - app.main - INFO - Application startup complete.
2025-07-06 10:43:19,054 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 10:43:19,054 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:43:19.054914+00:00.
2025-07-06 10:43:19,054 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 10:43:19,055 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T13:00:00+00:00 to 2025-07-06T14:00:00+00:00 UTC.
2025-07-06 10:43:19,057 - app.services.aggregation_service - INFO - No 5min data found for hourly aggregation in 2025-07-06 13:00:00+00:00 to 2025-07-06 14:00:00+00:00.
2025-07-06 10:43:19,057 - app.services.aggregation_service - INFO - Next aggregation check in 1000.94 seconds.
2025-07-06 10:43:19,057 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 10:43:19,058 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 10:43:19,084 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:43:19,193 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108902
2025-07-06 10:43:19,194 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:40:00.000000', 108902.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:25,085 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:43:25,153 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.81
2025-07-06 10:43:25,154 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 14:40:00.000000', 2558.81, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:30,294 - app.api.endpoints - INFO - User querying latest price for BITCOIN with granularity 1d.
2025-07-06 10:43:30,296 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 1d.
2025-07-06 10:43:30,296 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/bitcoin: No latest price data found
2025-07-06 10:43:31,086 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:43:31,220 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.28
2025-07-06 10:43:31,221 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 14:40:00.000000', 2.28, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:37,088 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:43:37,219 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.37
2025-07-06 10:43:37,222 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 14:40:00.000000', 151.37, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:43,088 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:43:43,218 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583608
2025-07-06 10:43:43,219 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 14:40:00.000000', 0.583608, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:49,089 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:43:49,254 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170728
2025-07-06 10:43:49,257 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 14:40:00.000000', 0.170728, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 10:43:49,257 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 70.74 seconds.
2025-07-06 10:45:00,000 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:44:59.999777+00:00.
2025-07-06 10:45:00,025 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:45:00,252 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108836
2025-07-06 10:45:00,257 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108836.0 at 2025-07-06 14:45:00+00:00 (granularity: 5min)
2025-07-06 10:45:06,026 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:45:06,147 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2557.17
2025-07-06 10:45:06,150 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2557.17 at 2025-07-06 14:45:00+00:00 (granularity: 5min)
2025-07-06 10:45:12,027 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:45:12,184 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 10:45:12,194 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 14:45:00+00:00 (granularity: 5min)
2025-07-06 10:45:18,028 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:45:18,165 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.29
2025-07-06 10:45:18,171 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.29 at 2025-07-06 14:45:00+00:00 (granularity: 5min)
2025-07-06 10:45:18,632 - app.api.endpoints - INFO - User querying latest price for BITCOIN with granularity 1d.
2025-07-06 10:45:18,636 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 1d.
2025-07-06 10:45:18,636 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/BITCOIN: No latest price data found
2025-07-06 10:45:24,029 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:45:24,161 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583237
2025-07-06 10:45:24,166 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.583237 at 2025-07-06 14:45:00+00:00 (granularity: 5min)
2025-07-06 10:45:30,029 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:45:30,148 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170304
2025-07-06 10:45:30,154 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170304 at 2025-07-06 14:45:00+00:00 (granularity: 5min)
2025-07-06 10:45:30,155 - app.services.ingestion_service - WARNING - Ingestion cycle took longer than interval. Adjusting next run time.
2025-07-06 10:45:30,155 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.85 seconds.
2025-07-06 10:46:56,256 - app.api.endpoints - INFO - User querying latest price for BTC with granularity 1d.
2025-07-06 10:46:56,260 - app.api.endpoints - WARNING - No latest price data found in DB for BTC with granularity 1d.
2025-07-06 10:46:56,260 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/BTC: No latest price data found
2025-07-06 10:47:06,106 - app.api.endpoints - INFO - User querying latest price for BITCOIN with granularity 1d.
2025-07-06 10:47:06,107 - app.api.endpoints - WARNING - No latest price data found in DB for BITCOIN with granularity 1d.
2025-07-06 10:47:06,107 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/BITCOIN: No latest price data found
2025-07-06 10:47:14,779 - app.api.endpoints - INFO - User querying latest price for BTC with granularity 1d.
2025-07-06 10:47:14,780 - app.api.endpoints - WARNING - No latest price data found in DB for BTC with granularity 1d.
2025-07-06 10:47:14,780 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/latest/btc: No latest price data found
2025-07-06 10:50:00,032 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:50:00.032651+00:00.
2025-07-06 10:50:00,041 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:50:00,219 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108768
2025-07-06 10:50:00,230 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108768.0 at 2025-07-06 14:50:00+00:00 (granularity: 5min)
2025-07-06 10:50:06,042 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:50:06,161 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2555.2
2025-07-06 10:50:06,162 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2555.2 at 2025-07-06 14:50:00+00:00 (granularity: 5min)
2025-07-06 10:50:12,043 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:50:12,168 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 10:50:12,172 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 14:50:00+00:00 (granularity: 5min)
2025-07-06 10:50:18,043 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:50:18,194 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.15
2025-07-06 10:50:18,195 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.15 at 2025-07-06 14:50:00+00:00 (granularity: 5min)
2025-07-06 10:50:24,043 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:50:24,179 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.58251
2025-07-06 10:50:24,186 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.58251 at 2025-07-06 14:50:00+00:00 (granularity: 5min)
2025-07-06 10:50:30,044 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:50:30,179 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.169992
2025-07-06 10:50:30,184 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.169992 at 2025-07-06 14:50:00+00:00 (granularity: 5min)
2025-07-06 10:50:30,185 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.81 seconds.
2025-07-06 10:55:00,003 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 14:55:00.002713+00:00.
2025-07-06 10:55:00,028 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 10:55:00,228 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108848
2025-07-06 10:55:00,238 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108848.0 at 2025-07-06 14:55:00+00:00 (granularity: 5min)
2025-07-06 10:55:06,029 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 10:55:06,156 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2556.37
2025-07-06 10:55:06,159 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2556.37 at 2025-07-06 14:55:00+00:00 (granularity: 5min)
2025-07-06 10:55:12,030 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 10:55:12,163 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 10:55:12,172 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 14:55:00+00:00 (granularity: 5min)
2025-07-06 10:55:18,032 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 10:55:18,158 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.36
2025-07-06 10:55:18,161 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.36 at 2025-07-06 14:55:00+00:00 (granularity: 5min)
2025-07-06 10:55:24,032 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 10:55:24,164 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.582873
2025-07-06 10:55:24,167 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.582873 at 2025-07-06 14:55:00+00:00 (granularity: 5min)
2025-07-06 10:55:30,034 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 10:55:30,159 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170165
2025-07-06 10:55:30,160 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170165 at 2025-07-06 14:55:00+00:00 (granularity: 5min)
2025-07-06 10:55:30,161 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.84 seconds.
2025-07-06 11:00:00,001 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:00:00.000862+00:00.
2025-07-06 11:00:00,023 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:00:00,061 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:00:00,075 - app.services.aggregation_service - INFO - Hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 completed. Processed 6 symbols.
2025-07-06 11:00:00,075 - app.services.aggregation_service - INFO - Next aggregation check in 3599.92 seconds.
2025-07-06 11:00:00,567 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108867
2025-07-06 11:00:00,571 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108867.0 at 2025-07-06 15:00:00+00:00 (granularity: 5min)
2025-07-06 11:00:06,024 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:00:06,165 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2557.73
2025-07-06 11:00:06,167 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2557.73 at 2025-07-06 15:00:00+00:00 (granularity: 5min)
2025-07-06 11:00:12,024 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:00:12,165 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:00:12,171 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:00:00+00:00 (granularity: 5min)
2025-07-06 11:00:18,026 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:00:18,169 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.5
2025-07-06 11:00:18,170 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.5 at 2025-07-06 15:00:00+00:00 (granularity: 5min)
2025-07-06 11:00:24,026 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:00:24,157 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583249
2025-07-06 11:00:24,168 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.583249 at 2025-07-06 15:00:00+00:00 (granularity: 5min)
2025-07-06 11:00:30,028 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:00:30,201 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170228
2025-07-06 11:00:30,208 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170228 at 2025-07-06 15:00:00+00:00 (granularity: 5min)
2025-07-06 11:00:30,208 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.79 seconds.
2025-07-06 11:01:59,625 - app.api.endpoints - INFO - User querying latest price for BITCOIN with granularity 5min.
2025-07-06 11:01:59,628 - app.api.endpoints - INFO - Fetched latest price for BITCOIN from DB and cached it. Price: 108867.0
2025-07-06 11:05:00,002 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:05:00.001244+00:00.
2025-07-06 11:05:00,022 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:05:00,204 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108916
2025-07-06 11:05:00,223 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108916.0 at 2025-07-06 15:05:00+00:00 (granularity: 5min)
2025-07-06 11:05:06,023 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:05:06,154 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.09
2025-07-06 11:05:06,156 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2558.09 at 2025-07-06 15:05:00+00:00 (granularity: 5min)
2025-07-06 11:05:12,024 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:05:12,157 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:05:12,161 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:05:00+00:00 (granularity: 5min)
2025-07-06 11:05:18,025 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:05:18,166 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.51
2025-07-06 11:05:18,173 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.51 at 2025-07-06 15:05:00+00:00 (granularity: 5min)
2025-07-06 11:05:24,026 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:05:24,172 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583784
2025-07-06 11:05:24,175 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.583784 at 2025-07-06 15:05:00+00:00 (granularity: 5min)
2025-07-06 11:05:30,027 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:05:30,161 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.17038
2025-07-06 11:05:30,167 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.17038 at 2025-07-06 15:05:00+00:00 (granularity: 5min)
2025-07-06 11:05:30,169 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.83 seconds.
2025-07-06 11:10:00,002 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:10:00.001818+00:00.
2025-07-06 11:10:00,024 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:10:00,206 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108928
2025-07-06 11:10:00,214 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108928.0 at 2025-07-06 15:10:00+00:00 (granularity: 5min)
2025-07-06 11:10:06,025 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:10:06,165 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2559.63
2025-07-06 11:10:06,176 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2559.63 at 2025-07-06 15:10:00+00:00 (granularity: 5min)
2025-07-06 11:10:12,026 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:10:12,167 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:10:12,173 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:10:00+00:00 (granularity: 5min)
2025-07-06 11:10:18,027 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:10:18,161 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.49
2025-07-06 11:10:18,166 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.49 at 2025-07-06 15:10:00+00:00 (granularity: 5min)
2025-07-06 11:10:24,029 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:10:24,169 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584611
2025-07-06 11:10:24,175 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584611 at 2025-07-06 15:10:00+00:00 (granularity: 5min)
2025-07-06 11:10:30,031 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:10:30,170 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170592
2025-07-06 11:10:30,177 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170592 at 2025-07-06 15:10:00+00:00 (granularity: 5min)
2025-07-06 11:10:30,178 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.82 seconds.
2025-07-06 11:15:00,002 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:15:00.001253+00:00.
2025-07-06 11:15:00,023 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:15:00,198 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108905
2025-07-06 11:15:00,205 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108905.0 at 2025-07-06 15:15:00+00:00 (granularity: 5min)
2025-07-06 11:15:06,024 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:15:06,161 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2559.23
2025-07-06 11:15:06,164 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2559.23 at 2025-07-06 15:15:00+00:00 (granularity: 5min)
2025-07-06 11:15:12,025 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:15:12,136 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:15:12,138 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:15:00+00:00 (granularity: 5min)
2025-07-06 11:15:18,026 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:15:18,171 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.56
2025-07-06 11:15:18,177 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.56 at 2025-07-06 15:15:00+00:00 (granularity: 5min)
2025-07-06 11:15:24,027 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:15:24,183 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.585048
2025-07-06 11:15:24,189 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.585048 at 2025-07-06 15:15:00+00:00 (granularity: 5min)
2025-07-06 11:15:30,028 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:15:30,166 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170774
2025-07-06 11:15:30,171 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170774 at 2025-07-06 15:15:00+00:00 (granularity: 5min)
2025-07-06 11:15:30,172 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.83 seconds.
2025-07-06 11:16:09,832 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:16:09,833 - app.main - INFO - Application shutdown complete.
2025-07-06 11:16:10,322 - root - INFO - Logging configured at level: INFO
2025-07-06 11:16:10,323 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:16:10,327 - app.main - INFO - Application startup initiated.
2025-07-06 11:16:10,328 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:16:10,328 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:16:10,328 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:16:10,328 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:16:10,328 - app.main - INFO - Application startup complete.
2025-07-06 11:16:10,329 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:16:10,329 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:16:10.329058+00:00.
2025-07-06 11:16:10,329 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:16:10,329 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:16:10,333 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:16:10,341 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:16:10,341 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:16:10,341 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:16:10,342 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:16:10,342 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:16:10,342 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:16:10,342 - app.services.aggregation_service - INFO - Next aggregation check in 2629.66 seconds.
2025-07-06 11:16:10,343 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:16:10,344 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:16:10,372 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:16:10,523 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108900
2025-07-06 11:16:10,524 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:15:00.000000', 108900.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:16:16,373 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:16:16,516 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2559.1
2025-07-06 11:16:16,517 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:15:00.000000', 2559.1, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:16:22,374 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:16:22,522 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:16:22,525 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:15:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:16:28,376 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:16:28,517 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.59
2025-07-06 11:16:28,519 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:15:00.000000', 151.59, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:16:34,376 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:16:34,547 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.585102
2025-07-06 11:16:34,549 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 15:15:00.000000', 0.585102, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:16:40,378 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:16:40,509 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170811
2025-07-06 11:16:40,512 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 15:15:00.000000', 0.170811, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:16:40,512 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 199.49 seconds.
2025-07-06 11:18:03,608 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:18:03,609 - app.main - INFO - Application shutdown complete.
2025-07-06 11:18:04,102 - root - INFO - Logging configured at level: INFO
2025-07-06 11:18:04,102 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:18:04,107 - app.main - INFO - Application startup initiated.
2025-07-06 11:18:04,107 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:18:04,108 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:18:04,108 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:18:04,108 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:18:04,108 - app.main - INFO - Application startup complete.
2025-07-06 11:18:04,108 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:18:04,108 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:18:04.108178+00:00.
2025-07-06 11:18:04,108 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:18:04,108 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:18:04,112 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:04,118 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:04,118 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:04,119 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:04,119 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:04,119 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:04,119 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:04,119 - app.services.aggregation_service - INFO - Next aggregation check in 2515.88 seconds.
2025-07-06 11:18:04,119 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:18:04,120 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:18:04,143 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:18:04,298 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108906
2025-07-06 11:18:04,299 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:15:00.000000', 108906.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:10,144 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:18:10,290 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.99
2025-07-06 11:18:10,293 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:15:00.000000', 2558.99, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:11,598 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:18:11,598 - app.main - INFO - Application shutdown complete.
2025-07-06 11:18:12,031 - root - INFO - Logging configured at level: INFO
2025-07-06 11:18:12,031 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:18:12,035 - app.main - INFO - Application startup initiated.
2025-07-06 11:18:12,036 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:18:12,036 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:18:12,036 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:18:12,036 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:18:12,036 - app.main - INFO - Application startup complete.
2025-07-06 11:18:12,036 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:18:12,036 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:18:12.036719+00:00.
2025-07-06 11:18:12,036 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:18:12,036 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:18:12,041 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:12,045 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:12,046 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:12,046 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:12,046 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:12,046 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:12,046 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:18:12,047 - app.services.aggregation_service - INFO - Next aggregation check in 2507.95 seconds.
2025-07-06 11:18:12,047 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:18:12,047 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:18:12,069 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:18:12,149 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108906
2025-07-06 11:18:12,149 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:15:00.000000', 108906.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:18,070 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:18:18,148 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.99
2025-07-06 11:18:18,150 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:15:00.000000', 2558.99, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:24,071 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:18:24,210 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:18:24,213 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:15:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:30,072 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:18:30,229 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.71
2025-07-06 11:18:30,230 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:15:00.000000', 151.71, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:36,073 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:18:36,207 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.58502
2025-07-06 11:18:36,209 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 15:15:00.000000', 0.58502, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:42,074 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:18:42,198 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170782
2025-07-06 11:18:42,200 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 15:15:00.000000', 0.170782, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:18:42,201 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 77.80 seconds.
2025-07-06 11:20:00,002 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:20:00.002365+00:00.
2025-07-06 11:20:00,025 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:20:00,247 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108890
2025-07-06 11:20:00,251 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108890.0 at 2025-07-06 15:20:00+00:00 (granularity: 5min)
2025-07-06 11:20:06,026 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:20:06,163 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.47
2025-07-06 11:20:06,166 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2558.47 at 2025-07-06 15:20:00+00:00 (granularity: 5min)
2025-07-06 11:20:12,034 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:20:13,409 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:20:13,414 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:20:00+00:00 (granularity: 5min)
2025-07-06 11:20:18,044 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:20:18,193 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.67
2025-07-06 11:20:18,200 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.67 at 2025-07-06 15:20:00+00:00 (granularity: 5min)
2025-07-06 11:20:24,051 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:20:24,191 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584673
2025-07-06 11:20:24,194 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584673 at 2025-07-06 15:20:00+00:00 (granularity: 5min)
2025-07-06 11:20:30,056 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:20:30,199 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.17073
2025-07-06 11:20:30,206 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.17073 at 2025-07-06 15:20:00+00:00 (granularity: 5min)
2025-07-06 11:20:30,206 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.79 seconds.
2025-07-06 11:20:49,414 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:20:49,415 - app.main - INFO - Application shutdown complete.
2025-07-06 11:20:49,886 - root - INFO - Logging configured at level: INFO
2025-07-06 11:20:49,887 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:20:49,892 - app.main - INFO - Application startup initiated.
2025-07-06 11:20:49,893 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:20:49,893 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:20:49,893 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:20:49,893 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:20:49,893 - app.main - INFO - Application startup complete.
2025-07-06 11:20:49,893 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:20:49,893 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:20:49.893430+00:00.
2025-07-06 11:20:49,893 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:20:49,893 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:20:49,898 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:20:49,904 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:49,904 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:49,905 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:49,905 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:49,905 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:49,905 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:49,905 - app.services.aggregation_service - INFO - Next aggregation check in 2350.09 seconds.
2025-07-06 11:20:49,905 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:20:49,906 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:20:49,929 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:20:50,014 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108890
2025-07-06 11:20:50,016 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:20:00.000000', 108890.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:20:51,831 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:20:51,832 - app.main - INFO - Application shutdown complete.
2025-07-06 11:20:52,243 - root - INFO - Logging configured at level: INFO
2025-07-06 11:20:52,243 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:20:52,248 - app.main - INFO - Application startup initiated.
2025-07-06 11:20:52,248 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:20:52,248 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:20:52,248 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:20:52,248 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:20:52,249 - app.main - INFO - Application startup complete.
2025-07-06 11:20:52,249 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:20:52,249 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:20:52.249272+00:00.
2025-07-06 11:20:52,249 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:20:52,249 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:20:52,254 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:20:52,257 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:52,257 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:52,257 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:52,258 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:52,258 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:52,258 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:52,258 - app.services.aggregation_service - INFO - Next aggregation check in 2347.74 seconds.
2025-07-06 11:20:52,258 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:20:52,259 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:20:52,276 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:20:52,372 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108890
2025-07-06 11:20:52,373 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:20:00.000000', 108890.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:20:58,279 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:20:58,336 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.47
2025-07-06 11:20:58,338 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:20:00.000000', 2558.47, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:20:58,948 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:20:58,948 - app.main - INFO - Application shutdown complete.
2025-07-06 11:20:59,380 - root - INFO - Logging configured at level: INFO
2025-07-06 11:20:59,380 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:20:59,385 - app.main - INFO - Application startup initiated.
2025-07-06 11:20:59,386 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:20:59,386 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:20:59,386 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:20:59,386 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:20:59,386 - app.main - INFO - Application startup complete.
2025-07-06 11:20:59,386 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:20:59,386 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:20:59.386383+00:00.
2025-07-06 11:20:59,386 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:20:59,386 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:20:59,390 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:20:59,393 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:59,393 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:59,393 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:59,394 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:59,394 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:59,394 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:20:59,394 - app.services.aggregation_service - INFO - Next aggregation check in 2340.61 seconds.
2025-07-06 11:20:59,394 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:20:59,395 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:20:59,410 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:20:59,509 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108890
2025-07-06 11:20:59,510 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:20:00.000000', 108890.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:01,417 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:21:01,417 - app.main - INFO - Application shutdown complete.
2025-07-06 11:21:01,782 - root - INFO - Logging configured at level: INFO
2025-07-06 11:21:01,782 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:21:01,787 - app.main - INFO - Application startup initiated.
2025-07-06 11:21:01,788 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:21:01,788 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:21:01,788 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:21:01,788 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:21:01,788 - app.main - INFO - Application startup complete.
2025-07-06 11:21:01,788 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:21:01,788 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:21:01.788885+00:00.
2025-07-06 11:21:01,788 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:21:01,789 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:21:01,793 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:01,795 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:01,796 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:01,796 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:01,796 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:01,796 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:01,797 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:01,797 - app.services.aggregation_service - INFO - Next aggregation check in 2338.20 seconds.
2025-07-06 11:21:01,797 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:21:01,797 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:21:01,812 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:21:01,995 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108873
2025-07-06 11:21:01,996 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:20:00.000000', 108873.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:07,815 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:21:07,940 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.59
2025-07-06 11:21:07,942 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:20:00.000000', 2558.59, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:08,285 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:21:08,285 - app.main - INFO - Application shutdown complete.
2025-07-06 11:21:08,692 - root - INFO - Logging configured at level: INFO
2025-07-06 11:21:08,692 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:21:08,697 - app.main - INFO - Application startup initiated.
2025-07-06 11:21:08,698 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:21:08,698 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:21:08,698 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:21:08,698 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:21:08,698 - app.main - INFO - Application startup complete.
2025-07-06 11:21:08,698 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:21:08,698 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:21:08.698490+00:00.
2025-07-06 11:21:08,698 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:21:08,698 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:21:08,703 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:08,705 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:08,706 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:08,706 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:08,706 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:08,707 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:08,707 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:21:08,707 - app.services.aggregation_service - INFO - Next aggregation check in 2331.29 seconds.
2025-07-06 11:21:08,707 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:21:08,708 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:21:08,725 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:21:08,824 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108873
2025-07-06 11:21:08,825 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:20:00.000000', 108873.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:14,726 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:21:14,811 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.59
2025-07-06 11:21:14,813 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:20:00.000000', 2558.59, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:20,728 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:21:20,879 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:21:20,880 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:20:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:26,728 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:21:26,856 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.65
2025-07-06 11:21:26,857 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:20:00.000000', 151.65, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:32,729 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:21:32,869 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584505
2025-07-06 11:21:32,871 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 15:20:00.000000', 0.584505, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:38,731 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:21:38,861 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170702
2025-07-06 11:21:38,862 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 15:20:00.000000', 0.170702, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:21:38,863 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 201.14 seconds.
2025-07-06 11:23:23,422 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:23:23,424 - app.main - INFO - Application shutdown complete.
2025-07-06 11:23:23,901 - root - INFO - Logging configured at level: INFO
2025-07-06 11:23:23,901 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:23:23,906 - app.main - INFO - Application startup initiated.
2025-07-06 11:23:23,906 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:23:23,907 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:23:23,907 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:23:23,907 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:23:23,907 - app.main - INFO - Application startup complete.
2025-07-06 11:23:23,907 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:23:23,907 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:23:23.907311+00:00.
2025-07-06 11:23:23,907 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:23:23,907 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:23:23,912 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:23:23,918 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:23:23,918 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:23:23,919 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:23:23,919 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:23:23,919 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:23:23,919 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:23:23,919 - app.services.aggregation_service - INFO - Next aggregation check in 2196.08 seconds.
2025-07-06 11:23:23,919 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:23:23,920 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:23:23,942 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:23:24,133 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108820
2025-07-06 11:23:24,134 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:20:00.000000', 108820.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:23:29,943 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:23:30,076 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2557.51
2025-07-06 11:23:30,079 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:20:00.000000', 2557.51, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:23:35,943 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:23:36,074 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:23:36,076 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:20:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:23:41,945 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:23:42,089 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.54
2025-07-06 11:23:42,092 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:20:00.000000', 151.54, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:23:47,947 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:23:48,082 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584011
2025-07-06 11:23:48,083 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 15:20:00.000000', 0.584011, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:23:53,947 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:23:54,094 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170575
2025-07-06 11:23:54,095 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 15:20:00.000000', 0.170575, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:23:54,095 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 65.90 seconds.
2025-07-06 11:25:00,001 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:25:00.001526+00:00.
2025-07-06 11:25:00,030 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:25:00,204 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108815
2025-07-06 11:25:00,209 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108815.0 at 2025-07-06 15:25:00+00:00 (granularity: 5min)
2025-07-06 11:25:06,031 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:25:06,162 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2557.76
2025-07-06 11:25:06,165 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2557.76 at 2025-07-06 15:25:00+00:00 (granularity: 5min)
2025-07-06 11:25:09,265 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:25:09,265 - app.main - INFO - Application shutdown complete.
2025-07-06 11:25:09,813 - root - INFO - Logging configured at level: INFO
2025-07-06 11:25:09,813 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:25:09,818 - app.main - INFO - Application startup initiated.
2025-07-06 11:25:09,819 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:25:09,819 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:25:09,819 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:25:09,819 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:25:09,819 - app.main - INFO - Application startup complete.
2025-07-06 11:25:09,819 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:25:09,819 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:25:09.819505+00:00.
2025-07-06 11:25:09,819 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:25:09,819 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:25:09,823 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:25:09,829 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:09,830 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:09,830 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:09,830 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:09,830 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:09,831 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:09,831 - app.services.aggregation_service - INFO - Next aggregation check in 2090.17 seconds.
2025-07-06 11:25:09,831 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:25:09,831 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:25:09,854 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:25:09,942 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108815
2025-07-06 11:25:09,942 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108815.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:25:15,856 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:25:15,930 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2557.76
2025-07-06 11:25:15,933 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:25:00.000000', 2557.76, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:25:21,856 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:25:21,974 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:25:21,979 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:25:00+00:00 (granularity: 5min)
2025-07-06 11:25:27,857 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:25:27,991 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.52
2025-07-06 11:25:27,994 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.52 at 2025-07-06 15:25:00+00:00 (granularity: 5min)
2025-07-06 11:25:32,678 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:25:32,678 - app.main - INFO - Application shutdown complete.
2025-07-06 11:25:33,156 - root - INFO - Logging configured at level: INFO
2025-07-06 11:25:33,156 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:25:33,161 - app.main - INFO - Application startup initiated.
2025-07-06 11:25:33,161 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:25:33,161 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:25:33,161 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:25:33,161 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:25:33,162 - app.main - INFO - Application startup complete.
2025-07-06 11:25:33,162 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:25:33,162 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:25:33.162322+00:00.
2025-07-06 11:25:33,162 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:25:33,162 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:25:33,166 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:25:33,172 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:33,172 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:33,173 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:33,173 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:33,173 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:33,173 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:25:33,174 - app.services.aggregation_service - INFO - Next aggregation check in 2066.83 seconds.
2025-07-06 11:25:33,174 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:25:33,174 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:25:33,195 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:25:33,284 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108815
2025-07-06 11:25:33,285 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108815.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:25:39,197 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:25:39,270 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2557.76
2025-07-06 11:25:39,270 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:25:00.000000', 2557.76, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:25:45,197 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:25:45,270 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:25:45,271 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:25:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:25:51,199 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:25:51,276 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.52
2025-07-06 11:25:51,278 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:25:00.000000', 151.52, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:25:57,200 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:25:57,339 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583971
2025-07-06 11:25:57,344 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.583971 at 2025-07-06 15:25:00+00:00 (granularity: 5min)
2025-07-06 11:26:03,201 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:26:03,334 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.17062
2025-07-06 11:26:03,342 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.17062 at 2025-07-06 15:25:00+00:00 (granularity: 5min)
2025-07-06 11:26:03,343 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 236.66 seconds.
2025-07-06 11:26:05,106 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:26:05,106 - app.main - INFO - Application shutdown complete.
2025-07-06 11:26:05,567 - root - INFO - Logging configured at level: INFO
2025-07-06 11:26:05,567 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:26:05,572 - app.main - INFO - Application startup initiated.
2025-07-06 11:26:05,573 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:26:05,573 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:26:05,573 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:26:05,573 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:26:05,573 - app.main - INFO - Application startup complete.
2025-07-06 11:26:05,573 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:26:05,573 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:26:05.573355+00:00.
2025-07-06 11:26:05,573 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:26:05,573 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:26:05,577 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:05,583 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:05,583 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:05,583 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:05,584 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:05,584 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:05,584 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:05,584 - app.services.aggregation_service - INFO - Next aggregation check in 2034.42 seconds.
2025-07-06 11:26:05,584 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:26:05,585 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:26:05,607 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:26:05,762 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108814
2025-07-06 11:26:05,762 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108814.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:11,609 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:26:11,797 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.41
2025-07-06 11:26:11,800 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:25:00.000000', 2558.41, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:17,610 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:26:17,673 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:26:17,674 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:25:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:23,611 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:26:23,693 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.52
2025-07-06 11:26:23,696 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:25:00.000000', 151.52, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:29,612 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:26:29,683 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583971
2025-07-06 11:26:29,686 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 15:25:00.000000', 0.583971, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:35,613 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:26:35,675 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.17062
2025-07-06 11:26:35,678 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 15:25:00.000000', 0.17062, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:35,678 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 204.32 seconds.
2025-07-06 11:26:43,685 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:26:43,687 - app.main - INFO - Application shutdown complete.
2025-07-06 11:26:44,166 - root - INFO - Logging configured at level: INFO
2025-07-06 11:26:44,166 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:26:44,171 - app.main - INFO - Application startup initiated.
2025-07-06 11:26:44,172 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:26:44,172 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:26:44,172 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:26:44,172 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:26:44,172 - app.main - INFO - Application startup complete.
2025-07-06 11:26:44,172 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:26:44,172 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:26:44.172748+00:00.
2025-07-06 11:26:44,172 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:26:44,172 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:26:44,178 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:44,185 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:44,185 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:44,185 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:44,185 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:44,186 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:44,186 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:44,186 - app.services.aggregation_service - INFO - Next aggregation check in 1995.81 seconds.
2025-07-06 11:26:44,186 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:26:44,187 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:26:44,216 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:26:44,320 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108814
2025-07-06 11:26:44,320 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108814.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:49,848 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:26:49,849 - app.main - INFO - Application shutdown complete.
2025-07-06 11:26:50,199 - root - INFO - Logging configured at level: INFO
2025-07-06 11:26:50,199 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:26:50,204 - app.main - INFO - Application startup initiated.
2025-07-06 11:26:50,204 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:26:50,204 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:26:50,204 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:26:50,204 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:26:50,205 - app.main - INFO - Application startup complete.
2025-07-06 11:26:50,205 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:26:50,205 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:26:50.205090+00:00.
2025-07-06 11:26:50,205 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:26:50,205 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:26:50,209 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:50,211 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:50,212 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:50,212 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:50,212 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:50,212 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:50,213 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:50,213 - app.services.aggregation_service - INFO - Next aggregation check in 1989.79 seconds.
2025-07-06 11:26:50,213 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:26:50,214 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:26:50,230 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:26:50,333 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108814
2025-07-06 11:26:50,333 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108814.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:51,730 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:26:51,730 - app.main - INFO - Application shutdown complete.
2025-07-06 11:26:52,064 - root - INFO - Logging configured at level: INFO
2025-07-06 11:26:52,064 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:26:52,069 - app.main - INFO - Application startup initiated.
2025-07-06 11:26:52,069 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:26:52,069 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:26:52,069 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:26:52,070 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:26:52,070 - app.main - INFO - Application startup complete.
2025-07-06 11:26:52,070 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:26:52,070 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:26:52.070234+00:00.
2025-07-06 11:26:52,070 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:26:52,070 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:26:52,074 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:52,077 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:52,077 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:52,077 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:52,077 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:52,078 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:52,078 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:52,078 - app.services.aggregation_service - INFO - Next aggregation check in 1987.92 seconds.
2025-07-06 11:26:52,078 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:26:52,079 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:26:52,093 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:26:52,173 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108814
2025-07-06 11:26:52,174 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108814.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:55,922 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:26:55,923 - app.main - INFO - Application shutdown complete.
2025-07-06 11:26:56,344 - root - INFO - Logging configured at level: INFO
2025-07-06 11:26:56,344 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:26:56,349 - app.main - INFO - Application startup initiated.
2025-07-06 11:26:56,349 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:26:56,350 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:26:56,350 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:26:56,350 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:26:56,350 - app.main - INFO - Application startup complete.
2025-07-06 11:26:56,350 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:26:56,350 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:26:56.350324+00:00.
2025-07-06 11:26:56,350 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:26:56,350 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:26:56,354 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:26:56,356 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:56,357 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:56,357 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:56,357 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:56,357 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:56,358 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:26:56,358 - app.services.aggregation_service - INFO - Next aggregation check in 1983.64 seconds.
2025-07-06 11:26:56,358 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:26:56,359 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:26:56,374 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:26:56,461 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108814
2025-07-06 11:26:56,462 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108814.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:00,201 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:27:00,201 - app.main - INFO - Application shutdown complete.
2025-07-06 11:27:00,545 - root - INFO - Logging configured at level: INFO
2025-07-06 11:27:00,545 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:27:00,550 - app.main - INFO - Application startup initiated.
2025-07-06 11:27:00,550 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:27:00,550 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:27:00,550 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:27:00,550 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:27:00,550 - app.main - INFO - Application startup complete.
2025-07-06 11:27:00,551 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:27:00,551 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:27:00.551198+00:00.
2025-07-06 11:27:00,551 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:27:00,551 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:27:00,555 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:00,557 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:00,558 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:00,558 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:00,558 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:00,558 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:00,559 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:00,559 - app.services.aggregation_service - INFO - Next aggregation check in 1979.44 seconds.
2025-07-06 11:27:00,559 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:27:00,560 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:27:00,574 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:27:00,652 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108814
2025-07-06 11:27:00,653 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108814.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:06,575 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:27:06,635 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.41
2025-07-06 11:27:06,636 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:25:00.000000', 2558.41, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:12,576 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:27:12,707 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:27:12,710 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:25:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:17,741 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:27:17,741 - app.main - INFO - Application shutdown complete.
2025-07-06 11:27:18,143 - root - INFO - Logging configured at level: INFO
2025-07-06 11:27:18,143 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:27:18,148 - app.main - INFO - Application startup initiated.
2025-07-06 11:27:18,148 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:27:18,148 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:27:18,148 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:27:18,148 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:27:18,148 - app.main - INFO - Application startup complete.
2025-07-06 11:27:18,148 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:27:18,148 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:27:18.148860+00:00.
2025-07-06 11:27:18,148 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:27:18,148 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:27:18,152 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:18,155 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:18,155 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:18,155 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:18,156 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:18,156 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:18,156 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:18,156 - app.services.aggregation_service - INFO - Next aggregation check in 1961.84 seconds.
2025-07-06 11:27:18,156 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:27:18,157 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:27:18,172 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:27:18,328 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:27:18,329 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:19,576 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:27:19,576 - app.main - INFO - Application shutdown complete.
2025-07-06 11:27:19,906 - root - INFO - Logging configured at level: INFO
2025-07-06 11:27:19,906 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:27:19,911 - app.main - INFO - Application startup initiated.
2025-07-06 11:27:19,911 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:27:19,911 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:27:19,911 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:27:19,911 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:27:19,911 - app.main - INFO - Application startup complete.
2025-07-06 11:27:19,911 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:27:19,911 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:27:19.911942+00:00.
2025-07-06 11:27:19,911 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:27:19,912 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:27:19,915 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:19,918 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:19,918 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:19,918 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:19,919 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:19,919 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:19,919 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:19,919 - app.services.aggregation_service - INFO - Next aggregation check in 1960.08 seconds.
2025-07-06 11:27:19,919 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:27:19,920 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:27:19,934 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:27:20,014 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:27:20,014 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:23,055 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:27:23,056 - app.main - INFO - Application shutdown complete.
2025-07-06 11:27:23,394 - root - INFO - Logging configured at level: INFO
2025-07-06 11:27:23,394 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:27:23,399 - app.main - INFO - Application startup initiated.
2025-07-06 11:27:23,399 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:27:23,399 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:27:23,399 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:27:23,399 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:27:23,399 - app.main - INFO - Application startup complete.
2025-07-06 11:27:23,399 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:27:23,399 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:27:23.399933+00:00.
2025-07-06 11:27:23,399 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:27:23,400 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:27:23,403 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:23,406 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:23,406 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:23,406 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:23,406 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:23,407 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:23,407 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:23,407 - app.services.aggregation_service - INFO - Next aggregation check in 1956.59 seconds.
2025-07-06 11:27:23,407 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:27:23,408 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:27:23,422 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:27:23,516 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:27:23,517 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:25,025 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:27:25,025 - app.main - INFO - Application shutdown complete.
2025-07-06 11:27:25,382 - root - INFO - Logging configured at level: INFO
2025-07-06 11:27:25,382 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:27:25,386 - app.main - INFO - Application startup initiated.
2025-07-06 11:27:25,387 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:27:25,387 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:27:25,387 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:27:25,387 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:27:25,387 - app.main - INFO - Application startup complete.
2025-07-06 11:27:25,387 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:27:25,387 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:27:25.387942+00:00.
2025-07-06 11:27:25,387 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:27:25,388 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:27:25,392 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:25,395 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:25,395 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:25,395 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:25,396 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:25,396 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:25,396 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:27:25,396 - app.services.aggregation_service - INFO - Next aggregation check in 1954.60 seconds.
2025-07-06 11:27:25,396 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:27:25,397 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:27:25,413 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:27:25,502 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:27:25,503 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:25:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:31,414 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:27:31,553 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.75
2025-07-06 11:27:31,555 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:25:00.000000', 2558.75, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:37,415 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:27:37,481 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:27:37,483 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:25:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:43,416 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:27:43,577 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.47
2025-07-06 11:27:43,580 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:25:00.000000', 151.47, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:49,417 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:27:49,548 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584278
2025-07-06 11:27:49,549 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 15:25:00.000000', 0.584278, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:55,418 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:27:55,557 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170623
2025-07-06 11:27:55,559 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 15:25:00.000000', 0.170623, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:27:55,559 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 124.44 seconds.
2025-07-06 11:29:03,833 - app.services.backfill_service - INFO - Starting automatic historical data backfill job...
2025-07-06 11:29:03,833 - app.services.backfill_service - INFO - Found tokens to backfill: ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin']
2025-07-06 11:29:03,834 - app.services.backfill_service - INFO - Starting backfill for token: bitcoin
2025-07-06 11:29:03,834 - app.services.backfill_service - INFO - Backfilling historical data for bitcoin from CoinGecko...
2025-07-06 11:29:03,843 - app.api.endpoints - INFO - Attempting to register new user: testuser_22aa2ab6
2025-07-06 11:29:03,845 - passlib.handlers.bcrypt - WARNING - (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-07-06 11:29:03,960 - app.services.backfill_service - INFO - Fetched 181 price points for bitcoin from CoinGecko.
2025-07-06 11:29:03,961 - app.services.backfill_service - ERROR - Bulk insert error for bitcoin: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:29:03,961 - app.services.backfill_service - INFO - Successfully completed backfill for token: bitcoin
2025-07-06 11:29:04,050 - app.api.endpoints - INFO - User testuser_22aa2ab6 successfully registered.
2025-07-06 11:29:04,052 - app.api.endpoints - INFO - Login attempt for user: testuser_22aa2ab6
2025-07-06 11:29:04,246 - app.api.endpoints - INFO - User testuser_22aa2ab6 successfully logged in and token issued.
2025-07-06 11:29:04,251 - app.api.endpoints - INFO - User querying historical prices for BITCOIN with granularities ALL from 2025-05-27T15:29:04.250169+00:00 to 2025-06-26T15:29:04.250169+00:00.
2025-07-06 11:29:04,269 - app.main - ERROR - Request validation error for GET /api/v1/prices/latest/bitcoin: [{'type': 'missing', 'loc': ('query', 'granularity'), 'msg': 'Field required', 'input': None}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'missing', 'loc': ('query', 'granularity'), 'msg': 'Field required', 'input': None}]
2025-07-06 11:29:04,271 - app.api.endpoints - INFO - User testuser_22aa2ab6 triggered manual prefetch for ETHEREUM.
2025-07-06 11:29:04,276 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:29:04,409 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.61
2025-07-06 11:29:04,411 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:25:00.000000', 2558.61, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:29:06,292 - app.main - ERROR - Request validation error for GET /api/v1/prices/latest/ethereum: [{'type': 'missing', 'loc': ('query', 'granularity'), 'msg': 'Field required', 'input': None}]
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 346, in app
    raise validation_error
fastapi.exceptions.RequestValidationError: [{'type': 'missing', 'loc': ('query', 'granularity'), 'msg': 'Field required', 'input': None}]
2025-07-06 11:29:13,962 - app.services.backfill_service - INFO - Starting backfill for token: ethereum
2025-07-06 11:29:13,963 - app.services.backfill_service - INFO - Backfilling historical data for ethereum from CoinGecko...
2025-07-06 11:29:14,105 - app.services.backfill_service - INFO - Fetched 181 price points for ethereum from CoinGecko.
2025-07-06 11:29:14,109 - app.services.backfill_service - ERROR - Bulk insert error for ethereum: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:29:14,109 - app.services.backfill_service - INFO - Successfully completed backfill for token: ethereum
2025-07-06 11:29:24,110 - app.services.backfill_service - INFO - Starting backfill for token: ripple
2025-07-06 11:29:24,111 - app.services.backfill_service - INFO - Backfilling historical data for ripple from CoinGecko...
2025-07-06 11:29:24,245 - app.services.backfill_service - INFO - Fetched 181 price points for ripple from CoinGecko.
2025-07-06 11:29:24,248 - app.services.backfill_service - ERROR - Bulk insert error for ripple: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:29:24,248 - app.services.backfill_service - INFO - Successfully completed backfill for token: ripple
2025-07-06 11:29:34,249 - app.services.backfill_service - INFO - Starting backfill for token: solana
2025-07-06 11:29:34,250 - app.services.backfill_service - INFO - Backfilling historical data for solana from CoinGecko...
2025-07-06 11:29:34,397 - app.services.backfill_service - INFO - Fetched 181 price points for solana from CoinGecko.
2025-07-06 11:29:34,401 - app.services.backfill_service - ERROR - Bulk insert error for solana: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:29:34,402 - app.services.backfill_service - INFO - Successfully completed backfill for token: solana
2025-07-06 11:29:44,403 - app.services.backfill_service - INFO - Starting backfill for token: cardano
2025-07-06 11:29:44,404 - app.services.backfill_service - INFO - Backfilling historical data for cardano from CoinGecko...
2025-07-06 11:29:44,542 - app.services.backfill_service - INFO - Fetched 181 price points for cardano from CoinGecko.
2025-07-06 11:29:44,580 - app.services.backfill_service - ERROR - Bulk insert error for cardano: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:29:44,580 - app.services.backfill_service - INFO - Successfully completed backfill for token: cardano
2025-07-06 11:29:54,582 - app.services.backfill_service - INFO - Starting backfill for token: dogecoin
2025-07-06 11:29:54,582 - app.services.backfill_service - INFO - Backfilling historical data for dogecoin from CoinGecko...
2025-07-06 11:29:54,646 - app.services.backfill_service - ERROR - Failed to fetch data from CoinGecko for dogecoin: Client error '429 Too Many Requests' for url 'https://api.coingecko.com/api/v3/coins/dogecoin/market_chart?vs_currency=usd&days=180&interval=daily'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429
2025-07-06 11:29:54,646 - app.services.backfill_service - INFO - Successfully completed backfill for token: dogecoin
2025-07-06 11:30:00,002 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:30:00.002530+00:00.
2025-07-06 11:30:00,009 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:30:00,160 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108838
2025-07-06 11:30:00,164 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108838.0 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:30:04,647 - app.services.backfill_service - INFO - Automatic historical data backfill job finished.
2025-07-06 11:30:04,703 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:30:04,704 - app.main - INFO - Application shutdown complete.
2025-07-06 11:30:05,167 - root - INFO - Logging configured at level: INFO
2025-07-06 11:30:05,167 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:30:05,171 - app.main - INFO - Application startup initiated.
2025-07-06 11:30:05,172 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:30:05,172 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:30:05,172 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:30:05,172 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:30:05,172 - app.main - INFO - Application startup complete.
2025-07-06 11:30:05,172 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:30:05,172 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:30:05.172547+00:00.
2025-07-06 11:30:05,172 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:30:05,172 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:30:05,176 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:05,182 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,183 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,183 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,183 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,183 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,184 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,184 - app.services.aggregation_service - INFO - Next aggregation check in 1794.82 seconds.
2025-07-06 11:30:05,184 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:30:05,184 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:30:05,530 - root - INFO - Logging configured at level: INFO
2025-07-06 11:30:05,530 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:30:05,535 - app.main - INFO - Application startup initiated.
2025-07-06 11:30:05,536 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:30:05,536 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:30:05,537 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:30:05,537 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:30:05,537 - app.main - INFO - Application startup complete.
2025-07-06 11:30:05,537 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:30:05,537 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:30:05.537184+00:00.
2025-07-06 11:30:05,537 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:30:05,537 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:30:05,541 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:05,544 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,545 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,545 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,545 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,545 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,546 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:05,546 - app.services.aggregation_service - INFO - Next aggregation check in 1794.45 seconds.
2025-07-06 11:30:05,546 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:30:05,547 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:30:05,573 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:30:05,648 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108838
2025-07-06 11:30:05,648 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:30:00.000000', 108838.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:11,574 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:30:11,877 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.81
2025-07-06 11:30:11,886 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2558.81 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:30:17,574 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:30:17,709 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:30:17,714 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:30:23,575 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:30:23,709 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.43
2025-07-06 11:30:23,715 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.43 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:30:29,576 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:30:29,717 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584492
2025-07-06 11:30:29,723 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584492 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:30:35,577 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:30:35,708 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170522
2025-07-06 11:30:35,710 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170522 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:30:35,710 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 264.29 seconds.
2025-07-06 11:30:35,958 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:30:35,959 - app.main - INFO - Application shutdown complete.
2025-07-06 11:30:36,408 - root - INFO - Logging configured at level: INFO
2025-07-06 11:30:36,408 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:30:36,413 - app.main - INFO - Application startup initiated.
2025-07-06 11:30:36,414 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:30:36,414 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:30:36,414 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:30:36,414 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:30:36,414 - app.main - INFO - Application startup complete.
2025-07-06 11:30:36,414 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:30:36,414 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:30:36.414213+00:00.
2025-07-06 11:30:36,414 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:30:36,414 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:30:36,418 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:36,425 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:36,425 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:36,425 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:36,426 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:36,426 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:36,426 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:36,426 - app.services.aggregation_service - INFO - Next aggregation check in 1763.57 seconds.
2025-07-06 11:30:36,426 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:30:36,427 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:30:36,450 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:30:36,531 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108838
2025-07-06 11:30:36,532 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:30:00.000000', 108838.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:42,452 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:30:42,540 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.81
2025-07-06 11:30:42,541 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:30:00.000000', 2558.81, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:42,790 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:30:42,790 - app.main - INFO - Application shutdown complete.
2025-07-06 11:30:43,138 - root - INFO - Logging configured at level: INFO
2025-07-06 11:30:43,138 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:30:43,142 - app.main - INFO - Application startup initiated.
2025-07-06 11:30:43,143 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:30:43,143 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:30:43,143 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:30:43,143 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:30:43,143 - app.main - INFO - Application startup complete.
2025-07-06 11:30:43,143 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:30:43,143 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:30:43.143976+00:00.
2025-07-06 11:30:43,144 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:30:43,144 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:30:43,148 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:43,150 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:43,150 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:43,151 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:43,151 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:43,151 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:43,151 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:30:43,151 - app.services.aggregation_service - INFO - Next aggregation check in 1756.85 seconds.
2025-07-06 11:30:43,151 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:30:43,152 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:30:43,167 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:30:43,267 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108838
2025-07-06 11:30:43,268 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:30:00.000000', 108838.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:49,168 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:30:49,240 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.81
2025-07-06 11:30:49,243 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:30:00.000000', 2558.81, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:30:55,169 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:30:55,243 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:30:55,245 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:30:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:01,170 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:31:01,240 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.43
2025-07-06 11:31:01,241 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:30:00.000000', 151.43, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:07,171 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:31:07,234 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584492
2025-07-06 11:31:07,236 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 15:30:00.000000', 0.584492, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:07,611 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:31:07,612 - app.main - INFO - Application shutdown complete.
2025-07-06 11:31:07,939 - root - INFO - Logging configured at level: INFO
2025-07-06 11:31:07,939 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:31:07,944 - app.main - INFO - Application startup initiated.
2025-07-06 11:31:07,945 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:31:07,945 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:31:07,945 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:31:07,945 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:31:07,945 - app.main - INFO - Application startup complete.
2025-07-06 11:31:07,945 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:31:07,945 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:31:07.945595+00:00.
2025-07-06 11:31:07,945 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:31:07,945 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:31:07,949 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:07,952 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:07,952 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:07,952 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:07,952 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:07,952 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:07,953 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:07,953 - app.services.aggregation_service - INFO - Next aggregation check in 1732.05 seconds.
2025-07-06 11:31:07,953 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:31:07,953 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:31:07,968 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:31:08,125 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108852
2025-07-06 11:31:08,126 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:30:00.000000', 108852.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:11,699 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:31:11,699 - app.main - INFO - Application shutdown complete.
2025-07-06 11:31:12,046 - root - INFO - Logging configured at level: INFO
2025-07-06 11:31:12,046 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:31:12,051 - app.main - INFO - Application startup initiated.
2025-07-06 11:31:12,052 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:31:12,052 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:31:12,052 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:31:12,052 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:31:12,052 - app.main - INFO - Application startup complete.
2025-07-06 11:31:12,052 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:31:12,052 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:31:12.052793+00:00.
2025-07-06 11:31:12,052 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:31:12,052 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:31:12,057 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:12,061 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:12,061 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:12,062 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:12,062 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:12,062 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:12,063 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:12,063 - app.services.aggregation_service - INFO - Next aggregation check in 1727.94 seconds.
2025-07-06 11:31:12,063 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:31:12,064 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:31:12,080 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:31:12,162 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108852
2025-07-06 11:31:12,163 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:30:00.000000', 108852.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:13,480 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:31:13,480 - app.main - INFO - Application shutdown complete.
2025-07-06 11:31:13,825 - root - INFO - Logging configured at level: INFO
2025-07-06 11:31:13,825 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:31:13,831 - app.main - INFO - Application startup initiated.
2025-07-06 11:31:13,832 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:31:13,832 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:31:13,832 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:31:13,832 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:31:13,832 - app.main - INFO - Application startup complete.
2025-07-06 11:31:13,832 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:31:13,832 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:31:13.832959+00:00.
2025-07-06 11:31:13,833 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:31:13,833 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:31:13,837 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:13,840 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:13,840 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:13,840 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:13,841 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:13,841 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:13,841 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:13,841 - app.services.aggregation_service - INFO - Next aggregation check in 1726.16 seconds.
2025-07-06 11:31:13,841 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:31:13,842 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:31:13,858 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:31:13,936 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108852
2025-07-06 11:31:13,937 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:30:00.000000', 108852.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:16,772 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:31:16,772 - app.main - INFO - Application shutdown complete.
2025-07-06 11:31:17,107 - root - INFO - Logging configured at level: INFO
2025-07-06 11:31:17,107 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:31:17,112 - app.main - INFO - Application startup initiated.
2025-07-06 11:31:17,113 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:31:17,113 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:31:17,113 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:31:17,113 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:31:17,113 - app.main - INFO - Application startup complete.
2025-07-06 11:31:17,113 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:31:17,113 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:31:17.113422+00:00.
2025-07-06 11:31:17,113 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:31:17,113 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:31:17,117 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:17,120 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:17,120 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:17,120 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:17,120 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:17,120 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:17,121 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:17,121 - app.services.aggregation_service - INFO - Next aggregation check in 1722.88 seconds.
2025-07-06 11:31:17,121 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:31:17,121 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:31:17,136 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:31:17,221 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108852
2025-07-06 11:31:17,221 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:30:00.000000', 108852.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:19,041 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:31:19,042 - app.main - INFO - Application shutdown complete.
2025-07-06 11:31:19,379 - root - INFO - Logging configured at level: INFO
2025-07-06 11:31:19,379 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:31:19,384 - app.main - INFO - Application startup initiated.
2025-07-06 11:31:19,384 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:31:19,384 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:31:19,384 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:31:19,384 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:31:19,385 - app.main - INFO - Application startup complete.
2025-07-06 11:31:19,385 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:31:19,385 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:31:19.385216+00:00.
2025-07-06 11:31:19,385 - app.services.aggregation_service - INFO - Starting aggregation loop every 60 minutes...
2025-07-06 11:31:19,385 - app.services.aggregation_service - INFO - Running hourly aggregation for 2025-07-06T14:00:00+00:00 to 2025-07-06T15:00:00+00:00 UTC.
2025-07-06 11:31:19,389 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for BITCOIN: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlite3.IntegrityError: UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
           ^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 523, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1637, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:19,392 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for CARDANO: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:19,392 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for DOGECOIN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:19,392 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for ETHEREUM: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:19,392 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for RIPPLE: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:19,392 - app.services.aggregation_service - ERROR - Error saving hourly aggregate for SOLANA: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 39, in run_hourly_aggregation
    create_token_price(db, hourly_price)
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/crud/token_price.py", line 17, in create_token_price
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:19,393 - app.services.aggregation_service - ERROR - Error during hourly aggregation: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/Users/kaiwang/workspace/token_pricing_system-1/app/services/aggregation_service.py", line 46, in run_hourly_aggregation
    db.commit()
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/kaiwang/workspace/token_pricing_system-1/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 14:00:00.000000', 108863.8, '1h', 'agg_hourly')]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-07-06 11:31:19,393 - app.services.aggregation_service - INFO - Next aggregation check in 1720.61 seconds.
2025-07-06 11:31:19,393 - app.services.aggregation_service - INFO - Starting data retention job loop.
2025-07-06 11:31:19,394 - app.services.aggregation_service - INFO - Next data retention run in 12.00 hours.
2025-07-06 11:31:19,408 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:31:19,504 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108852
2025-07-06 11:31:19,505 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:30:00.000000', 108852.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:25,409 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:31:25,543 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2559.46
2025-07-06 11:31:25,544 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:30:00.000000', 2559.46, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:31,410 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:31:31,524 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:31:31,525 - app.services.ingestion_service - ERROR - Failed to ingest price for ripple: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('RIPPLE', '2025-07-06 15:30:00.000000', 2.27, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:37,411 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:31:37,553 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.44
2025-07-06 11:31:37,556 - app.services.ingestion_service - ERROR - Failed to ingest price for solana: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('SOLANA', '2025-07-06 15:30:00.000000', 151.44, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:43,412 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:31:43,561 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584549
2025-07-06 11:31:43,563 - app.services.ingestion_service - ERROR - Failed to ingest price for cardano: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('CARDANO', '2025-07-06 15:30:00.000000', 0.584549, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:49,412 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:31:49,533 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170496
2025-07-06 11:31:49,534 - app.services.ingestion_service - ERROR - Failed to ingest price for dogecoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('DOGECOIN', '2025-07-06 15:30:00.000000', 0.170496, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:31:49,534 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 190.47 seconds.
2025-07-06 11:33:15,603 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:33:15,605 - app.main - INFO - Application shutdown complete.
2025-07-06 11:34:02,621 - root - INFO - Logging configured at level: INFO
2025-07-06 11:34:02,621 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:34:02,626 - app.main - INFO - Application startup initiated.
2025-07-06 11:34:02,630 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:34:02,630 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:34:02,630 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:34:02,630 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:34:02,630 - app.main - INFO - Application startup complete.
2025-07-06 11:34:02,630 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:34:02,630 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:34:02.630397+00:00.
2025-07-06 11:34:02,655 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:34:02,852 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108852
2025-07-06 11:34:02,862 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108852.0 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:34:08,656 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:34:08,789 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2559.68
2025-07-06 11:34:08,797 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2559.68 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:34:14,657 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:34:14,807 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:34:14,810 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:34:20,658 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:34:20,820 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.43
2025-07-06 11:34:20,822 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.43 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:34:26,659 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:34:26,793 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.58454
2025-07-06 11:34:26,795 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.58454 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:34:32,660 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:34:32,797 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170461
2025-07-06 11:34:32,801 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170461 at 2025-07-06 15:30:00+00:00 (granularity: 5min)
2025-07-06 11:34:32,801 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 27.20 seconds.
2025-07-06 11:34:49,086 - app.services.backfill_service - INFO - Starting automatic historical data backfill job...
2025-07-06 11:34:49,086 - app.services.backfill_service - INFO - Found tokens to backfill: ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin']
2025-07-06 11:34:49,086 - app.services.backfill_service - INFO - Starting backfill for token: bitcoin
2025-07-06 11:34:49,086 - app.services.backfill_service - INFO - Backfilling historical data for bitcoin from CoinGecko...
2025-07-06 11:34:49,235 - app.services.backfill_service - INFO - Fetched 181 price points for bitcoin from CoinGecko.
2025-07-06 11:34:49,238 - app.services.backfill_service - ERROR - Bulk insert error for bitcoin: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:34:49,238 - app.services.backfill_service - INFO - Successfully completed backfill for token: bitcoin
2025-07-06 11:34:59,239 - app.services.backfill_service - INFO - Starting backfill for token: ethereum
2025-07-06 11:34:59,240 - app.services.backfill_service - INFO - Backfilling historical data for ethereum from CoinGecko...
2025-07-06 11:34:59,344 - app.services.backfill_service - INFO - Fetched 181 price points for ethereum from CoinGecko.
2025-07-06 11:34:59,347 - app.services.backfill_service - ERROR - Bulk insert error for ethereum: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:34:59,347 - app.services.backfill_service - INFO - Successfully completed backfill for token: ethereum
2025-07-06 11:35:00,002 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:35:00.002247+00:00.
2025-07-06 11:35:00,021 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:35:00,130 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108852
2025-07-06 11:35:00,133 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108852.0 at 2025-07-06 15:35:00+00:00 (granularity: 5min)
2025-07-06 11:35:06,022 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:35:06,108 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2559.68
2025-07-06 11:35:06,111 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2559.68 at 2025-07-06 15:35:00+00:00 (granularity: 5min)
2025-07-06 11:35:09,347 - app.services.backfill_service - INFO - Starting backfill for token: ripple
2025-07-06 11:35:09,347 - app.services.backfill_service - INFO - Backfilling historical data for ripple from CoinGecko...
2025-07-06 11:35:09,491 - app.services.backfill_service - INFO - Fetched 181 price points for ripple from CoinGecko.
2025-07-06 11:35:09,492 - app.services.backfill_service - ERROR - Bulk insert error for ripple: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:35:09,492 - app.services.backfill_service - INFO - Successfully completed backfill for token: ripple
2025-07-06 11:35:12,023 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:35:12,092 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:35:12,094 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:35:00+00:00 (granularity: 5min)
2025-07-06 11:35:18,024 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:35:18,104 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.43
2025-07-06 11:35:18,112 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.43 at 2025-07-06 15:35:00+00:00 (granularity: 5min)
2025-07-06 11:35:19,494 - app.services.backfill_service - INFO - Starting backfill for token: solana
2025-07-06 11:35:19,494 - app.services.backfill_service - INFO - Backfilling historical data for solana from CoinGecko...
2025-07-06 11:35:19,653 - app.services.backfill_service - INFO - Fetched 181 price points for solana from CoinGecko.
2025-07-06 11:35:19,658 - app.services.backfill_service - ERROR - Bulk insert error for solana: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:35:19,658 - app.services.backfill_service - INFO - Successfully completed backfill for token: solana
2025-07-06 11:35:24,025 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:35:24,100 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.58454
2025-07-06 11:35:24,104 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.58454 at 2025-07-06 15:35:00+00:00 (granularity: 5min)
2025-07-06 11:35:29,658 - app.services.backfill_service - INFO - Starting backfill for token: cardano
2025-07-06 11:35:29,658 - app.services.backfill_service - INFO - Backfilling historical data for cardano from CoinGecko...
2025-07-06 11:35:29,788 - app.services.backfill_service - INFO - Fetched 181 price points for cardano from CoinGecko.
2025-07-06 11:35:29,792 - app.services.backfill_service - ERROR - Bulk insert error for cardano: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:35:29,792 - app.services.backfill_service - INFO - Successfully completed backfill for token: cardano
2025-07-06 11:35:30,026 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:35:30,093 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170461
2025-07-06 11:35:30,097 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170461 at 2025-07-06 15:35:00+00:00 (granularity: 5min)
2025-07-06 11:35:30,097 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.90 seconds.
2025-07-06 11:35:39,793 - app.services.backfill_service - INFO - Starting backfill for token: dogecoin
2025-07-06 11:35:39,795 - app.services.backfill_service - INFO - Backfilling historical data for dogecoin from CoinGecko...
2025-07-06 11:35:39,936 - app.services.backfill_service - INFO - Fetched 181 price points for dogecoin from CoinGecko.
2025-07-06 11:35:39,980 - app.services.backfill_service - ERROR - Bulk insert error for dogecoin: 'TokenPrice' object has no attribute 'model_dump'
2025-07-06 11:35:39,980 - app.services.backfill_service - INFO - Successfully completed backfill for token: dogecoin
2025-07-06 11:35:49,981 - app.services.backfill_service - INFO - Automatic historical data backfill job finished.
2025-07-06 11:37:08,606 - app.api.endpoints - INFO - User querying historical prices for BITCOIN with granularities ALL from 2024-06-01T00:00:00+00:00 to 2024-07-01T00:00:00+00:00.
2025-07-06 11:39:20,247 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:20,249 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:20,777 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:20,777 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:20,782 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:20,782 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:20,783 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:20,783 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:20,783 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:20,783 - app.main - INFO - Application startup complete.
2025-07-06 11:39:20,783 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:20,783 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:20.783355+00:00.
2025-07-06 11:39:20,807 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:20,968 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:20,972 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:25,934 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:25,934 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:26,283 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:26,283 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:26,287 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:26,288 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:26,288 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:26,288 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:26,288 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:26,288 - app.main - INFO - Application startup complete.
2025-07-06 11:39:26,288 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:26,288 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:26.288681+00:00.
2025-07-06 11:39:26,303 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:26,394 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:26,397 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:27,703 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:27,703 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:28,156 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:28,156 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:28,161 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:28,161 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:28,162 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:28,162 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:28,162 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:28,162 - app.main - INFO - Application startup complete.
2025-07-06 11:39:28,162 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:28,162 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:28.162194+00:00.
2025-07-06 11:39:28,176 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:28,267 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:28,269 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:31,596 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:31,596 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:31,983 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:31,983 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:31,988 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:31,989 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:31,989 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:31,989 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:31,989 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:31,989 - app.main - INFO - Application startup complete.
2025-07-06 11:39:31,989 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:31,989 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:31.989530+00:00.
2025-07-06 11:39:32,004 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:32,095 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:32,098 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:32,696 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:32,696 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:33,151 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:33,151 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:33,157 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:33,158 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:33,158 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:33,158 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:33,158 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:33,158 - app.main - INFO - Application startup complete.
2025-07-06 11:39:33,158 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:33,158 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:33.158816+00:00.
2025-07-06 11:39:33,174 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:33,273 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:33,276 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:35,484 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:35,484 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:35,846 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:35,846 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:35,851 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:35,852 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:35,852 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:35,852 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:35,852 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:35,852 - app.main - INFO - Application startup complete.
2025-07-06 11:39:35,852 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:35,852 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:35.852707+00:00.
2025-07-06 11:39:35,868 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:35,952 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:35,955 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:40,197 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:40,197 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:40,569 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:40,569 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:40,574 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:40,575 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:40,575 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:40,575 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:40,575 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:40,576 - app.main - INFO - Application startup complete.
2025-07-06 11:39:40,576 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:40,576 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:40.576144+00:00.
2025-07-06 11:39:40,591 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:40,688 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:40,691 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:42,396 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:42,396 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:42,751 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:42,751 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:42,756 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:42,757 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:42,757 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:42,757 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:42,757 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:42,757 - app.main - INFO - Application startup complete.
2025-07-06 11:39:42,757 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:42,757 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:42.757622+00:00.
2025-07-06 11:39:42,772 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:42,865 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:42,868 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:46,191 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:46,192 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:46,631 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:46,631 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:46,636 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:46,637 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:46,637 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:46,637 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:46,637 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:46,637 - app.main - INFO - Application startup complete.
2025-07-06 11:39:46,637 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:46,637 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:46.637695+00:00.
2025-07-06 11:39:46,652 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:46,737 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:46,740 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:47,242 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:47,242 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:47,626 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:47,626 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:47,631 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:47,632 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:47,632 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:47,632 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:47,632 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:47,632 - app.main - INFO - Application startup complete.
2025-07-06 11:39:47,633 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:47,633 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:47.633068+00:00.
2025-07-06 11:39:47,650 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:47,746 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:47,749 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:48,542 - app.services.cache_service - INFO - In-memory cache disconnection (no action needed for in-memory).
2025-07-06 11:39:48,542 - app.main - INFO - Application shutdown complete.
2025-07-06 11:39:48,936 - root - INFO - Logging configured at level: INFO
2025-07-06 11:39:48,936 - root - INFO - Logs will also be written to: app.log
2025-07-06 11:39:48,941 - app.main - INFO - Application startup initiated.
2025-07-06 11:39:48,941 - app.main - INFO - Database tables ensured to exist.
2025-07-06 11:39:48,942 - app.services.cache_service - INFO - In-memory cache initialized and cleanup task started.
2025-07-06 11:39:48,942 - app.main - INFO - Starting background tasks (ingestion, aggregation, retention).
2025-07-06 11:39:48,942 - app.main - INFO - Background tasks (ingestion, aggregation, retention) started.
2025-07-06 11:39:48,942 - app.main - INFO - Application startup complete.
2025-07-06 11:39:48,942 - app.services.ingestion_service - INFO - Starting ingestion loop for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] every 5 minutes...
2025-07-06 11:39:48,942 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:39:48.942222+00:00.
2025-07-06 11:39:48,956 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:39:49,055 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108819
2025-07-06 11:39:49,058 - app.services.ingestion_service - ERROR - Failed to ingest price for bitcoin: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('BITCOIN', '2025-07-06 15:35:00.000000', 108819.0, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:54,958 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:39:55,097 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2558.6
2025-07-06 11:39:55,100 - app.services.ingestion_service - ERROR - Failed to ingest price for ethereum: (sqlite3.IntegrityError) UNIQUE constraint failed: token_prices.token_symbol, token_prices.timestamp, token_prices.granularity
[SQL: INSERT INTO token_prices (token_symbol, timestamp, price, granularity, source) VALUES (?, ?, ?, ?, ?)]
[parameters: ('ETHEREUM', '2025-07-06 15:35:00.000000', 2558.6, '5min', 'coingecko')]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-07-06 11:39:56,556 - app.api.endpoints - INFO - User querying historical prices for BITCOIN with granularities ALL from 2024-06-01T00:00:00+00:00 to 2024-07-01T00:00:00+00:00.
2025-07-06 11:39:56,559 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity ALL in the requested range.
2025-07-06 11:39:56,560 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 11:40:00,960 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:40:01,145 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:40:01,148 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:40:00+00:00 (granularity: 5min)
2025-07-06 11:40:06,960 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:40:07,111 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.46
2025-07-06 11:40:07,117 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.46 at 2025-07-06 15:40:00+00:00 (granularity: 5min)
2025-07-06 11:40:12,961 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:40:13,094 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584568
2025-07-06 11:40:13,101 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584568 at 2025-07-06 15:40:00+00:00 (granularity: 5min)
2025-07-06 11:40:16,954 - app.api.endpoints - INFO - User querying historical prices for BITCOIN with granularities ALL from 2024-06-01T00:00:00+00:00 to 2024-07-07T00:00:00+00:00.
2025-07-06 11:40:16,955 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity ALL in the requested range.
2025-07-06 11:40:16,955 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 11:40:18,963 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:40:19,095 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170283
2025-07-06 11:40:19,099 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170283 at 2025-07-06 15:40:00+00:00 (granularity: 5min)
2025-07-06 11:40:19,100 - app.services.ingestion_service - WARNING - Ingestion cycle took longer than interval. Adjusting next run time.
2025-07-06 11:40:19,100 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 280.90 seconds.
2025-07-06 11:41:41,927 - app.api.endpoints - INFO - User querying historical prices for BITCOIN with granularities ALL from 2024-06-01T00:00:00+00:00 to 2024-07-07T00:00:00+00:00.
2025-07-06 11:41:41,932 - app.api.endpoints - INFO - No historical price data found for BITCOIN granularity ALL in the requested range.
2025-07-06 11:41:41,932 - app.main - WARNING - HTTP Exception (Client Error) at GET /api/v1/prices/bitcoin: No price data found for the given criteria
2025-07-06 11:45:00,004 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:45:00.004497+00:00.
2025-07-06 11:45:00,022 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:45:00,172 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108757
2025-07-06 11:45:00,181 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108757.0 at 2025-07-06 15:45:00+00:00 (granularity: 5min)
2025-07-06 11:45:06,023 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:45:06,145 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2554.88
2025-07-06 11:45:06,147 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2554.88 at 2025-07-06 15:45:00+00:00 (granularity: 5min)
2025-07-06 11:45:12,024 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:45:12,149 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:45:12,157 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:45:00+00:00 (granularity: 5min)
2025-07-06 11:45:18,026 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:45:18,154 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.23
2025-07-06 11:45:18,161 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.23 at 2025-07-06 15:45:00+00:00 (granularity: 5min)
2025-07-06 11:45:24,025 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:45:24,169 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.583736
2025-07-06 11:45:24,173 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.583736 at 2025-07-06 15:45:00+00:00 (granularity: 5min)
2025-07-06 11:45:30,026 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:45:30,194 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170151
2025-07-06 11:45:30,201 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170151 at 2025-07-06 15:45:00+00:00 (granularity: 5min)
2025-07-06 11:45:30,201 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.80 seconds.
2025-07-06 11:50:00,004 - app.services.ingestion_service - INFO - Initiating ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] at 2025-07-06 15:50:00.004542+00:00.
2025-07-06 11:50:00,016 - app.services.ingestion_service - INFO - Attempting to fetch price for bitcoin from CoinGecko.
2025-07-06 11:50:00,219 - app.services.ingestion_service - INFO - Successfully fetched price for bitcoin: 108754
2025-07-06 11:50:00,237 - app.services.ingestion_service - INFO - Ingested BITCOIN price 108754.0 at 2025-07-06 15:50:00+00:00 (granularity: 5min)
2025-07-06 11:50:06,017 - app.services.ingestion_service - INFO - Attempting to fetch price for ethereum from CoinGecko.
2025-07-06 11:50:06,159 - app.services.ingestion_service - INFO - Successfully fetched price for ethereum: 2552.37
2025-07-06 11:50:06,162 - app.services.ingestion_service - INFO - Ingested ETHEREUM price 2552.37 at 2025-07-06 15:50:00+00:00 (granularity: 5min)
2025-07-06 11:50:12,018 - app.services.ingestion_service - INFO - Attempting to fetch price for ripple from CoinGecko.
2025-07-06 11:50:12,153 - app.services.ingestion_service - INFO - Successfully fetched price for ripple: 2.27
2025-07-06 11:50:12,159 - app.services.ingestion_service - INFO - Ingested RIPPLE price 2.27 at 2025-07-06 15:50:00+00:00 (granularity: 5min)
2025-07-06 11:50:18,019 - app.services.ingestion_service - INFO - Attempting to fetch price for solana from CoinGecko.
2025-07-06 11:50:18,144 - app.services.ingestion_service - INFO - Successfully fetched price for solana: 151.11
2025-07-06 11:50:18,148 - app.services.ingestion_service - INFO - Ingested SOLANA price 151.11 at 2025-07-06 15:50:00+00:00 (granularity: 5min)
2025-07-06 11:50:24,021 - app.services.ingestion_service - INFO - Attempting to fetch price for cardano from CoinGecko.
2025-07-06 11:50:24,155 - app.services.ingestion_service - INFO - Successfully fetched price for cardano: 0.584131
2025-07-06 11:50:24,158 - app.services.ingestion_service - INFO - Ingested CARDANO price 0.584131 at 2025-07-06 15:50:00+00:00 (granularity: 5min)
2025-07-06 11:50:30,022 - app.services.ingestion_service - INFO - Attempting to fetch price for dogecoin from CoinGecko.
2025-07-06 11:50:30,151 - app.services.ingestion_service - INFO - Successfully fetched price for dogecoin: 0.170211
2025-07-06 11:50:30,153 - app.services.ingestion_service - INFO - Ingested DOGECOIN price 0.170211 at 2025-07-06 15:50:00+00:00 (granularity: 5min)
2025-07-06 11:50:30,153 - app.services.ingestion_service - INFO - Next ingestion for ['bitcoin', 'ethereum', 'ripple', 'solana', 'cardano', 'dogecoin'] scheduled in 269.85 seconds.
2025-07-06 11:52:36,645 - app.api.endpoints - INFO - User querying historical prices for BITCOIN with granularities ALL from 2024-06-01T00:00:00+00:00 to 2025-07-07T00:00:00+00:00.
2025-07-06 11:52:36,648 - app.api.endpoints - INFO - Returned 4 historical prices for BITCOIN.
